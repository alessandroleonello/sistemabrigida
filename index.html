<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Brígida - Controle</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Ícones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Biblioteca para Gráficos (Chart.js) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Biblioteca para ler arquivos Excel (.xlsx) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Biblioteca para ler arquivos CSV (PapaParse) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <!-- Fontes (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bibliotecas para Funcionalidades -->
    <!-- jsBarcode para códigos de barra -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- jsPDF e jsPDF-AutoTable para relatórios em PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Classe para esconder páginas inativas */
        .page {
            display: none;
        }

        /* Classe para mostrar a página ativa */
        .page.active {
            display: block;
        }

        /* Estilo para links ativos no menu */
        .sidebar-link.active {
            background-color: #4f46e5;
            /* indigo-700 */
            color: white;
        }
    </style>
</head>

<body class="bg-gray-100">

    <!-- =========== TELA DE AUTENTICAÇÃO =========== -->
    <div id="page-auth" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h2 class="text-3xl font-bold text-center text-gray-900">Sistema Brígida</h2>

            <!-- Abas de Login / Registrar -->
            <div class="flex border-b">
                <button id="tab-login"
                    class="flex-1 py-2 font-medium text-center text-indigo-600 border-b-2 border-indigo-600">Entrar</button>
                <button id="tab-register" class="flex-1 py-2 font-medium text-center text-gray-500">Registrar</button>
            </div>

            <!-- Formulário de Login -->
            <form id="form-login" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input id="login-email" type="email" required
                        class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input id="login-password" type="password" required
                        class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit"
                    class="w-full px-4 py-2 font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Entrar
                </button>
            </form>

            <!-- Formulário de Registro (escondido por padrão) -->
            <form id="form-register" class="hidden space-y-6">
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input id="register-email" type="email" required
                        class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input id="register-password" type="password" required
                        class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit"
                    class="w-full px-4 py-2 font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Criar Conta
                </button>
            </form>
            <p id="auth-error" class="text-sm text-center text-red-600"></p>
        </div>
    </div>

    <!-- =========== APLICAÇÃO PRINCIPAL (Escondida até o login) =========== -->
    <div id="page-main-app" class="hidden">
        <div class="flex h-screen">
            <!-- Menu Lateral (Sidebar) -->
            <nav id="sidebar" class="flex flex-col w-64 text-white bg-gray-800">
                <div class="flex items-center justify-center h-16 px-4 border-b border-gray-700">
                    <h1 class="text-xl font-bold">Sistema Brígida</h1>
                </div>
                <div class="flex-1 p-4 space-y-2 overflow-y-auto">
                    <a href="#" data-page="page-dashboard"
                        class="sidebar-link active flex items-center px-3 py-2 space-x-2 rounded-md hover:bg-gray-700">
                        <i data-lucide="layout-dashboard"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" data-page="page-produtos"
                        class="sidebar-link flex items-center px-3 py-2 space-x-2 rounded-md hover:bg-gray-700">
                        <i data-lucide="package"></i>
                        <span>Produtos</span>
                    </a>
                    <a href="#" data-page="page-vendas"
                        class="sidebar-link flex items-center px-3 py-2 space-x-2 rounded-md hover:bg-gray-700">
                        <i data-lucide="shopping-cart"></i>
                        <span>Vendas</span>
                    </a>
                    <a href="#" data-page="page-pessoas"
                        class="sidebar-link flex items-center px-3 py-2 space-x-2 rounded-md hover:bg-gray-700">
                        <i data-lucide="users"></i>
                        <span>Pessoas</span>
                    </a>
                    <a href="#" data-page="page-financeiro"
                        class="sidebar-link flex items-center px-3 py-2 space-x-2 rounded-md hover:bg-gray-700">
                        <i data-lucide="dollar-sign"></i>
                        <span>Financeiro</span>
                    </a>
                </div>
                <div class="p-4 border-t border-gray-700">
                    <div id="user-info" class="mb-2 text-sm text-gray-400">Carregando</div>
                    <button id="btn-logout"
                        class="flex items-center justify-center w-full px-3 py-2 space-x-2 text-white bg-red-600 rounded-md hover:bg-red-700">
                        <i data-lucide="log-out"></i>
                        <span>Sair</span>
                    </button>
                </div>
            </nav>

            <!-- Conteúdo Principal -->
            <main class="flex-1 p-6 overflow-y-auto bg-gray-100 md:p-10">

                <!-- =========== PÁGINA: DASHBOARD (COM LINKS) =========== -->
<div id="page-dashboard" class="page active">
    <h2 class="text-3xl font-semibold text-gray-800">Dashboard</h2>
    
    <!-- CARDS COM ATALHOS -->
    <div class="grid grid-cols-1 gap-6 mt-6 md:grid-cols-2 lg:grid-cols-4">
        
        <!-- Card de Avisos (Não clicável, apenas informa) -->
        <div class="p-6 bg-white rounded-lg shadow-md">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 uppercase">Avisos Pendentes</p>
                    <p id="dashboard-warnings-count" class="text-3xl font-bold text-red-600">0</p>
                </div>
                <div class="p-3 text-red-600 bg-red-100 rounded-full">
                    <i data-lucide="alert-triangle"></i>
                </div>
            </div>
            <p id="dashboard-warnings-details" class="mt-2 text-sm text-gray-500">Nenhum aviso.</p>
        </div>
        
        <!-- Card de Vendas (Clicável) -->
        <div id="card-link-vendas" class="p-6 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 uppercase">Vendas (Mês)</p>
                    <p id="dashboard-sales-value" class="text-3xl font-bold text-green-600">R$ 0,00</p>
                </div>
                <div class="p-3 text-green-600 bg-green-100 rounded-full">
                    <i data-lucide="trending-up"></i>
                </div>
            </div>
            <p id="dashboard-sales-count" class="mt-2 text-sm text-gray-500">0 vendas realizadas</p>
        </div>
        
        <!-- Card de Caixa (Clicável) -->
        <div id="card-link-financeiro" class="p-6 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 uppercase">Caixa (Mês)</p>
                    <p id="dashboard-balance-value" class="text-3xl font-bold text-blue-600">R$ 0,00</p>
                </div>
                <div class="p-3 text-blue-600 bg-blue-100 rounded-full">
                    <i data-lucide="scale"></i>
                </div>
            </div>
            <p id="dashboard-balance-details" class="mt-2 text-sm text-gray-500">Ent: R$0, Saí: R$0</p>
        </div>
        
        <!-- Card de Estoque Baixo (Clicável) -->
        <div id="card-link-produtos" class="p-6 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 uppercase">Estoque Zerado/Baixo</p>
                    <p id="dashboard-lowstock-count" class="text-3xl font-bold text-yellow-600">0</p>
                </div>
                <div class="p-3 text-yellow-600 bg-yellow-100 rounded-full">
                    <i data-lucide="package-check"></i>
                </div>
            </div>
            <p class="mt-2 text-sm text-gray-500">Itens com 5 un. ou menos</p>
        </div>
    </div>

    <!-- WIDGETS COM ATALHOS -->
    <div class="grid grid-cols-1 gap-6 mt-8 lg:grid-cols-3">
        
        <!-- Lista de Avisos (Itens clicáveis) -->
        <div class="p-6 bg-white rounded-lg shadow-md lg:col-span-2">
            <h3 class="text-lg font-medium">Avisos Importantes</h3>
            <ul id="dashboard-warnings-list" class="mt-4 space-y-3">
                <li id="dashboard-warnings-placeholder" class="text-sm text-gray-500">Nenhum aviso importante no momento.</li>
                <!-- JS irá popular aqui -->
            </ul>
        </div>
        
        <!-- Lista Estoque Baixo (Widget clicável) -->
        <div id="widget-link-produtos" class="p-6 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow">
            <h3 class="text-lg font-medium">Estoque Baixo</h3>
            <ul id="low-stock-list" class="mt-4 space-y-2 text-sm pointer-events-none"> <!-- pointer-events-none para que o clique vá para o 'pai' -->
                <li class="text-sm text-gray-500">Carregando...</li>
            </ul>
        </div>
        
    </div>
</div>

                    <!-- =========== PÁGINA: PRODUTOS =========== -->
                    <div id="page-produtos" class="page">
                        <h2 class="text-3xl font-semibold text-gray-800">Gestão de Produtos</h2>
                        <!-- Abas da Seção -->
                        <div class="mt-4 border-b border-gray-200">
                            <nav class="flex -mb-px space-x-6" id="product-tabs">
                                <button data-tab="tab-produtos-view"
                                    class="product-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-indigo-600 border-indigo-500">Visualizar
                                    Produtos</button>
                                <button data-tab="tab-produtos-add"
                                    class="product-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">Cadastrar
                                    Produto</button>
                                <button data-tab="tab-produtos-import"
                                    class="product-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">Importar
                                    em Lote (CSV)</button>
                                <button data-tab="tab-produtos-labels"
                                    class="product-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">Gerar
                                    Etiquetas</button>
                            </nav>
                        </div>

                        <!-- Conteúdo da Aba: Visualizar Produtos -->
                        <div id="tab-produtos-view" class="product-tab-content mt-6">
                            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                                <input type="search" id="product-search-input"
                                    placeholder="Filtrar produtos por nome, ref ou categoria"
                                    class="w-full px-4 py-2 border rounded-lg md:w-1/2">
                                <div class="flex space-x-2">
                                    <button id="btn-batch-edit"
                                        class="px-4 py-2 font-medium text-white bg-yellow-600 rounded-lg hover:bg-yellow-700">Editar
                                        em Lote</button>
                                    <button id="btn-batch-delete"
                                        class="px-4 py-2 font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">Excluir
                                        em Lote</button>
                                </div>
                            </div>
                            <div class="mt-4 overflow-x-auto bg-white rounded-lg shadow">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="w-12 px-6 py-3 text-left"><input type="checkbox"
                                                    id="select-all-products" class="rounded"></th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Nome / Ref.</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Categoria</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Estoque</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Preço Venda</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="product-list-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Exemplo de item -->
                                        <tr>
                                            <td class="px-6 py-4"><input type="checkbox" class="rounded"></td>
                                            <td class="px-6 py-4"><img
                                                    src="https://placehold.co/40x40/e2e8f0/adb5bd?text=Foto"
                                                    alt="Produto" class="w-10 h-10 rounded-md"></td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="font-medium">Brinco Argola Ouro</div>
                                                <div class="text-sm text-gray-500">REF12345</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">Brincos</td>
                                            <td class="px-6 py-4 whitespace-nowrap"><span
                                                    class="px-2 py-1 text-xs font-medium text-red-800 bg-red-100 rounded-full">0
                                                    un.</span></td>
                                            <td class="px-6 py-4 whitespace-nowrap">R$ 150,00</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                <button class="text-indigo-600 hover:text-indigo-900"><i
                                                        data-lucide="edit-2" class="w-5 h-5"></i></button>
                                                <button class="text-red-600 hover:text-red-900"><i data-lucide="trash-2"
                                                        class="w-5 h-5"></i></button>
                                            </td>
                                        </tr>
                                        <!-- JS irá popular o resto -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Conteúdo da Aba: Cadastrar Produto -->
                        <div id="tab-produtos-add"
                            class="product-tab-content hidden mt-6 p-6 bg-white rounded-lg shadow-md">
                            <form id="form-add-product" class="grid grid-cols-1 gap-6 md:grid-cols-3">
                                <!-- Coluna 1: Infos Principais -->
                                <div class="space-y-4 md:col-span-2">
                                    <h3 class="text-lg font-medium">Detalhes do Produto</h3>
                                    <div>
                                        <label class="block text-sm font-medium">Nome do Produto</label>
                                        <input type="text" id="prod-nome" required
                                            class="w-full px-3 py-2 mt-1 border rounded-md">
                                    </div>
                                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                                        <div>
                                            <label class="block text-sm font-medium">Preço de Custo (R$)</label>
                                            <input type="number" id="prod-custo" step="0.01"
                                                class="w-full px-3 py-2 mt-1 border rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium">Margem de Lucro (%)</label>
                                            <input type="number" id="prod-margem" value="100"
                                                class="w-full px-3 py-2 mt-1 border rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium">Preço de Venda (R$)</label>
                                            <input type="text" id="prod-venda" readonly
                                                class="w-full px-3 py-2 mt-1 bg-gray-100 border rounded-md">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium">Descrição</label>
                                        <textarea id="prod-desc" rows="4"
                                            class="w-full px-3 py-2 mt-1 border rounded-md"></textarea>
                                    </div>

                                </div>
                                <!-- Coluna 2: Estoque e Categoria -->
                                <div class="space-y-4 md:col-span-1">
                                    <h3 class="text-lg font-medium">Organização</h3>
                                    <div>
                                        <label class="block text-sm font-medium">Categoria</label>
                                        <div class="flex space-x-2">
                                            <select id="prod-categoria" class="w-full px-3 py-2 mt-1 border rounded-md">
                                                <option>Anéis</option>
                                                <option>Brincos</option>
                                                <option>Tornozeleiras</option>
                                                <option>Pulseiras</option>
                                                <!-- JS popula mais categorias -->
                                            </select>
                                            <button type="button" id="btn-add-category"
                                                class="px-3 py-2 mt-1 text-white bg-blue-500 rounded-md hover:bg-blue-600">
                                                <i data-lucide="plus" class="w-5 h-5"></i>
                                            </button>
                                            <button type="button" id="btn-manage-category"
                                                class="px-3 py-2 mt-1 text-white bg-gray-500 rounded-md hover:bg-gray-600">
                                                <i data-lucide="settings-2" class="w-5 h-5"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium">Código de Referência</label>
                                        <input type="text" id="prod-ref" required
                                            class="w-full px-3 py-2 mt-1 border rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium">Qtd. em Estoque</label>
                                        <input type="number" id="prod-estoque" value="1"
                                            class="w-full px-3 py-2 mt-1 border rounded-md">
                                    </div>
                                    <div class="p-4 border rounded-md">
                                        <h4 class="font-medium text-center">Código de Barras</h4>
                                        <svg id="barcode-preview" class="w-full h-auto mt-2"></svg>
                                    </div>
                                </div>
                                <!-- Ações -->
                                <div class="md:col-span-3 text-right">
                                    <button type="submit"
                                        class="px-6 py-2 font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">Salvar
                                        Produto</button>
                                </div>
                            </form>
                        </div>

                        <!-- Conteúdo da Aba: Gerar Etiquetas -->
                        <div id="tab-produtos-labels"
                            class="product-tab-content hidden mt-6 p-6 bg-white rounded-lg shadow-md">
                            <h3 class="text-lg font-medium">Gerar Etiquetas</h3>
                            <p class="text-sm text-gray-600">Selecione os produtos e o formato da etiqueta.</p>
                            <div class="grid grid-cols-1 gap-6 mt-4 md:grid-cols-2">
                                <div>
                                    <label class="block text-sm font-medium">Selecionar Produtos</label>
                                    <div id="label-product-list"
                                        class="w-full h-64 p-3 mt-1 overflow-y-auto border rounded-md">
                                        <!-- Exemplo de item -->
                                        <label class="flex items-center space-x-2 p-1 hover:bg-gray-50">
                                            <input type="checkbox" class="rounded">
                                            <span>REF12345 - Brinco Argola Ouro</span>
                                        </label>
                                        <!-- JS popula o resto -->
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">Formato da Etiqueta</label>
                                    <!-- ***** SEÇÃO MODIFICADA ***** -->
                                    <!-- Bloco NOVO com a lista completa -->
                                    <select id="label-format" class="w-full px-3 py-2 mt-1 border rounded-md">
                                        <optgroup label="PIMACO - Folha A4 (21,0 x 29,7 cm)">
                                            <option value="A4048">A4048 (3,30 x 1,70 cm)</option>
                                            <option value="A4049">A4049 (2,80 x 1,50 cm)</option>
                                            <option value="A4050">A4050 (10,16 x 5,58 cm)</option>
                                            <option value="A4051">A4051 (4,07 x 2,12 cm)</option>
                                            <option value="A4054">A4054 (10,16 x 2,54 cm)</option>
                                            <option value="A4055">A4055 (6,61 x 3,10 cm)</option>
                                            <option value="A4056">A4056 (6,61 x 2,54 cm)</option>
                                            <option value="A4060">A4060 (6,61 x 3,81 cm)</option>
                                            <option value="A4261">A4261 (6,61 x 4,65 cm)</option>
                                            <option value="A4062">A4062 (10,16 x 3,39 cm)</option>
                                            <option value="A4063">A4063 (10,16 x 3,81 cm)</option>
                                            <option value="A4264">A4264 (6,61 x 7,19 cm)</option>
                                            <option value="A4265">A4265 (10,16 x 6,78 cm)</option>
                                            <option value="A4067">A4067 (20,00 x 28,85 cm)</option>
                                            <option value="A4268">A4268 (19,99 x 14,34 cm)</option>
                                        </optgroup>
                                        <optgroup label="PIMACO - Folha Carta (21,59 x 27,94 cm)">
                                            <option value="3080">3080/3180 (6,98 x 2,54 cm)</option>
                                            <option value="3081">3081/3181 (10,68 x 2,54 cm)</option>
                                            <option value="3082">3082/3182 (10,68 x 3,39 cm)</option>
                                            <option value="5580">5580A/5580M/5580V (6,98 x 2,54 cm)</option>
                                            <option value="6080">6080/6180/6280/62580 (6,98 x 2,54 cm)</option>
                                            <option value="6081">6081/6181/6281/62581 (10,68 x 2,54 cm)</option>
                                            <option value="6082">6082/6182/6282/62582 (10,68 x 3,39 cm)</option>
                                            <option value="6083">6083/6183/6283 (10,68 x 5,08 cm)</option>
                                            <option value="6084">6084/6184/6284 (10,68 x 8,47 cm)</option>
                                            <option value="6085">6085/6185/6285 (Página Inteira)</option>
                                            <option value="6086">6086/6286 (10,64 x 13,81 cm - 2/pág)</option>
                                            <option value="6087">6087/6187/6287 (4,75 x 1,27 cm)</option>
                                            <option value="6088">6088/6288 (10,64 x 13,81 cm - 2/pág)</option>
                                            <option value="6089">6089 (4,75 x 1,69 cm)</option>
                                            <option value="6092">6092 (2,91 x 1,70 cm)</option>
                                            <option value="6093">6093/6293 (5,20 x 2,74 cm)</option>
                                            <option value="6094">6094 (6,75 x 4,85 cm)</option>
                                            <option value="6095">6095 (9,63 x 5,93 cm)</option>
                                            <option value="8096">8096/8196/8296 (6,98 x 3,00 cm)</option>
                                            <option value="8098">8098 (10,16 x 4,23 cm)</option>
                                            <option value="8099F">8099F (8,38 x 4,66 cm)</option>
                                            <option value="8099L">8099L (3,41 x 1,69 cm)</option>
                                        </optgroup>
                                        <optgroup label="Formatos Comuns (Genéricos)">
                                            <option value="gen-30x15">Genérico (30 x 15 mm)</option>
                                            <option value="gen-40x20">Genérico (40 x 20 mm)</option>
                                            <option value="gen-50x25">Genérico (50 x 25 mm)</option>
                                            <option value="gen-60x40">Genérico (60 x 40 mm)</option>
                                        </optgroup>
                                    </select>
                                    <!-- Fim do bloco NOVO -->
                                    <!-- ***** FIM DA SEÇÃO MODIFICADA ***** -->
                                    <button id="btn-generate-labels"
                                        class="w-full px-4 py-2 mt-4 font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">
                                        Gerar PDF para Impressão
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Conteúdo da Aba: Importar em Lote -->
                        <div id="tab-produtos-import"
                            class="product-tab-content hidden mt-6 p-6 bg-white rounded-lg shadow-md">
                            <h3 class="text-lg font-medium">Importar Produtos em Lote</h3>
                            <p class="text-sm text-gray-600 mt-2">Envie um arquivo no formato CSV (separado por
                                vírgulas) com as colunas na primeira linha:</p>
                            <div class="flex flex-wrap gap-2 mt-2">
                                <code class="text-xs bg-gray-100 p-1 rounded">nome</code>
                                <code class="text-xs bg-gray-100 p-1 rounded">ref</code>
                                <code class="text-xs bg-gray-100 p-1 rounded">custo</code>
                                <code class="text-xs bg-gray-100 p-1 rounded">margem</code>
                                <code class="text-xs bg-gray-100 p-1 rounded">estoque</code>
                                <code class="text-xs bg-gray-100 p-1 rounded">categoria</code>
                                <code class="text-xs bg-gray-100 p-1 rounded">descricao</code>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">O preço de venda será calculado automaticamente (custo
                                + margem).</p>

                            <div class="mt-6">
                                <label for="csv-file-input" class="block text-sm font-medium">Arquivo CSV</label>
                                <input type="file" id="csv-file-input" accept=".csv"
                                    class="w-full max-w-md px-3 py-2 mt-1 text-sm border rounded-md file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            </div>

                            <button id="btn-import-csv"
                                class="px-6 py-2 mt-6 font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:opacity-50">
                                <i data-lucide="upload-cloud" class="inline w-5 h-5 mr-1"></i>
Iniciar Importação (do arquivo CSV)                            </button>
                            <!-- NOVO BLOCO DE CÓDIGO ABAIXO -->
    <div class="mt-6">
    <label for="excel-file-input" class="block text-sm font-medium">Ou... Enviar Arquivo Excel (.xlsx)</label>
    <input type="file" id="excel-file-input" accept=".xlsx, .xls" class="w-full max-w-md px-3 py-2 mt-1 text-sm border rounded-md file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
</div>

<button id="btn-import-excel" class="px-6 py-2 mt-6 font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:opacity-50">
    <i data-lucide="file-spreadsheet" class="inline w-5 h-5 mr-1"></i>
    Iniciar Importação (do Excel)
</button>
                            <hr class="my-8">
    
    <h3 class="text-lg font-medium">Ou... Importar Copiando e Colando</h3>
    <p class="text-sm text-gray-600 mt-2">
        Copie os dados da sua planilha (Excel, Google Sheets) e cole no campo abaixo.
        <strong class="font-medium">Importante:</strong> As colunas devem estar na ordem e com os nomes corretos (ex: `nome`, `ref`, `custo`, `margem`...).
    </p>
    
    <textarea id="paste-data-input" rows="8" class="w-full p-2 mt-4 border rounded-md font-mono text-sm" placeholder="Cole os dados da sua planilha aqui..."></textarea>
    
    <button id="btn-import-paste" class="px-6 py-2 mt-4 font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50">
        <i data-lucide="clipboard-paste" class="inline w-5 h-5 mr-1"></i>
        Processar Dados Colados
    </button>
    <!-- FIM DO NOVO BLOCO -->

                            <div id="import-status" class="mt-4 text-sm"></div>
                        </div>
                    </div>

                    <!-- =========== PÁGINA: VENDAS =========== -->
                    <div id="page-vendas" class="page">
                        <h2 class="text-3xl font-semibold text-gray-800">Gestão de Vendas</h2>
                        <!-- Abas da Seção -->
                        <div class="mt-4 border-b border-gray-200">
                            <nav class="flex -mb-px space-x-6" id="vendas-tabs">
                                <button data-tab="tab-vendas-new"
                                    class="vendas-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-indigo-600 border-indigo-500">Nova
                                    Venda / Consignação</button>
                                <button data-tab="tab-vendas-consign"
                                    class="vendas-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">Consignações
                                    Ativas</button>
                                <button data-tab="tab-vendas-history"
                                    class="vendas-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">Histórico
                                    de Vendas</button>
                            </nav>
                        </div>

                        <!-- Conteúdo da Aba: Nova Venda -->
                        <div id="tab-vendas-new" class="vendas-tab-content mt-6">
                            <form id="form-new-sale" class="grid grid-cols-1 gap-6 lg:grid-cols-3">
                                <!-- Coluna 1: Itens -->
                                <div class="p-6 bg-white rounded-lg shadow-md lg:col-span-2">
                                    <h3 class="text-lg font-medium">Itens da Venda</h3>
                                    <div class="flex mt-4 space-x-2">
                                        <input type="text" id="sale-item-ref"
                                            placeholder="Digitar Código de Ref. (ou usar leitor)"
                                            class="flex-1 px-3 py-2 border rounded-md">
                                        <button type="button" id="btn-add-sale-item"
                                            class="px-4 py-2 font-medium text-white bg-blue-500 rounded-md hover:bg-blue-600">Adicionar</button>
                                    </div>
                                    <div class="mt-4 overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead>
                                                <tr>
                                                    <th class="py-2 text-left text-sm font-medium text-gray-500">Produto
                                                    </th>
                                                    <th class="py-2 text-left text-sm font-medium text-gray-500">Ref.
                                                    </th>
                                                    <th class="py-2 text-left text-sm font-medium text-gray-500">Preço
                                                        Unit.</th>
                                                    <th class="py-2 text-left text-sm font-medium text-gray-500">Ação
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="sale-items-list" class="divide-y">
                                                <!-- JS popula aqui -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Coluna 2: Detalhes da Venda -->
                                <div class="p-6 space-y-4 bg-white rounded-lg shadow-md lg:col-span-1">
                                    <h3 class="text-lg font-medium">Detalhes Finais</h3>

                                    <!-- Tipo de Venda -->
                                    <div class="flex space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="sale-type" value="direta"
                                                class="text-indigo-600 focus:ring-indigo-500" checked>
                                            <span class="ml-2 text-sm font-medium">Venda Direta</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="sale-type" value="consignacao"
                                                class="text-indigo-600 focus:ring-indigo-500">
                                            <span class="ml-2 text-sm font-medium">Consignação</span>
                                        </label>
                                    </div>

                                    <!-- Cliente / Revendedor -->
                                    <div>
                                        <label class="block text-sm font-medium">Cliente / Revendedor</label>
                                        <select id="sale-client" class="w-full px-3 py-2 mt-1 border rounded-md">
                                            <option>Consumidor Final</option>
                                            <!-- JS popula com clientes/revendedores -->
                                        </select>
                                        <button type="button" id="btn-add-new-client-sale"
                                            class="mt-1 text-sm text-indigo-600 hover:underline">Cadastrar novo
                                            cliente/revendedor</button>
                                    </div>

                                    <!-- Campos Venda Direta -->
                                    <div id="fields-venda-direta">
                                        <div>
                                            <label class="block text-sm font-medium">Desconto (%)</label>
                                            <input type="number" id="sale-discount" value="0"
                                                class="w-full px-3 py-2 mt-1 border rounded-md">
                                        </div>
                                    </div>

                                    <!-- Campos Consignação -->
                                    <div id="fields-consignacao" class="hidden">
                                        <div>
                                            <label class="block text-sm font-medium">Data do Acerto</label>
                                            <input type="date" id="sale-due-date"
                                                class="w-full px-3 py-2 mt-1 border rounded-md">
                                        </div>
                                    </div>

                                    <!-- Pagamento -->
                                    <div>
                                        <label class="block text-sm font-medium">Forma de Pagamento</label>
                                        <select id="sale-payment" class="w-full px-3 py-2 mt-1 border rounded-md">
                                            <option>Dinheiro</option>
                                            <option>Pix</option>
                                            <option>Cartão de Crédito</option>
                                            <option>Cartão de Débito</option>
                                        </select>
                                    </div>

                                    <!-- Total -->
                                    <div class="pt-4 border-t">
                                        <div class="flex justify-between text-sm">
                                            <span>Subtotal</span>
                                            <span id="sale-subtotal">R$ 0,00</span>
                                        </div>
                                        <div class="flex justify-between text-sm text-red-600">
                                            <span>Desconto</span>
                                            <span id="sale-discount-value">- R$ 0,00</span>
                                        </div>
                                        <div class="flex justify-between text-xl font-bold mt-2">
                                            <span>TOTAL</span>
                                            <span id="sale-total">R$ 0,00</span>
                                        </div>
                                    </div>

                                    <button type="submit" id="btn-finalize-sale"
                                        class="w-full px-4 py-3 font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">
                                        Finalizar Venda
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Conteúdo da Aba: Consignações Ativas -->
                        <div id="tab-vendas-consign" class="vendas-tab-content hidden mt-6">
                            <div class="p-6 bg-white rounded-lg shadow-md">
                                <h3 class="text-lg font-medium">Consignações em Aberto</h3>
                                <table class="min-w-full mt-4 divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Revendedor(a)</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Data Abertura</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Data Acerto</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Valor Total</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody id="consign-list-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Exemplo -->
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4">Maria Souza</td>
                                            <td class="px-6 py-4">25/09/2025</td>
                                            <td class="px-6 py-4 font-medium text-red-600">30/10/2025 (3 dias)</td>
                                            <td class="px-6 py-4">R$ 2.500,00</td>
                                            <td class="px-6 py-4">
                                                <button
                                                    class="px-3 py-1 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Realizar
                                                    Acerto</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Conteúdo da Aba: Histórico de Vendas -->
                        <div id="tab-vendas-history" class="vendas-tab-content hidden mt-6">
                            <div class="p-6 bg-white rounded-lg shadow-md">
                                <h3 class="text-lg font-medium">Histórico de Vendas</h3>
                                <table class="min-w-full mt-4 divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Data</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Cliente</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Tipo</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Valor Final</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-list-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Exemplo -->
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4">24/10/2025</td>
                                            <td class="px-6 py-4">Ana Clara</td>
                                            <td class="px-6 py-4"><span
                                                    class="px-2 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full">Venda
                                                    Direta</span></td>
                                            <td class="px-6 py-4">R$ 150,00</td>
                                            <td class="px-6 py-4">
                                                <button
                                                    class="px-3 py-1 text-sm font-medium text-indigo-700 bg-indigo-100 rounded-md hover:bg-indigo-200">Ver
                                                    Relatório</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- =========== PÁGINA: PESSOAS =========== -->
                    <div id="page-pessoas" class="page">
                        <h2 class="text-3xl font-semibold text-gray-800">Gestão de Pessoas</h2>
                        <!-- Abas da Seção -->
                        <div class="mt-4 border-b border-gray-200">
                            <nav class="flex -mb-px space-x-6" id="pessoas-tabs">
                                <button data-tab="tab-pessoas-view"
                                    class="pessoas-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-indigo-600 border-indigo-500">Visualizar
                                    Pessoas</button>
                                <button data-tab="tab-pessoas-add"
                                    class="pessoas-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">Cadastrar
                                    Pessoa</button>
                            </nav>
                        </div>

                        <!-- Conteúdo da Aba: Visualizar Pessoas -->
                        <div id="tab-pessoas-view" class="pessoas-tab-content mt-6">
                            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                                <input type="search" id="people-search-input"
                                    placeholder="Filtrar pessoas por nome, e-mail ou CPF"
                                    class="w-full px-4 py-2 border rounded-lg md:w-1/2">
                                <select class="px-4 py-2 border rounded-lg">
                                    <option>Todos os Tipos</option>
                                    <option>Cliente Direto</option>
                                    <option>Revendedor</option>
                                    <option>Fornecedor</option>
                                </select>
                            </div>
                            <div class="mt-4 overflow-x-auto bg-white rounded-lg shadow">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="w-12 px-6 py-3 text-left"><input type="checkbox" class="rounded">
                                            </th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Nome</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Contato (Email / Tel)</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Tipo</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="people-list-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Exemplo -->
                                        <tr>
                                            <td class="px-6 py-4"><input type="checkbox" class="rounded"></td>
                                            <td class="px-6 py-4 whitespace-nowrap">Maria Souza</td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm">maria@email.com</div>
                                                <div class="text-sm text-gray-500">(11) 98765-4321</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap"><span
                                                    class="px-2 py-1 text-xs font-medium text-purple-800 bg-purple-100 rounded-full">Revendedor</span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                <button class="text-indigo-600 hover:text-indigo-900"><i
                                                        data-lucide="edit-2" class="w-5 h-5"></i></button>
                                                <button class="text-red-600 hover:text-red-900"><i data-lucide="trash-2"
                                                        class="w-5 h-5"></i></button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Conteúdo da Aba: Cadastrar Pessoa -->
                        <div id="tab-pessoas-add"
                            class="pessoas-tab-content hidden mt-6 p-6 bg-white rounded-lg shadow-md">
                            <form id="form-add-person">
                                <h3 class="text-lg font-medium">Dados da Pessoa</h3>
                                <div class="grid grid-cols-1 gap-6 mt-4 md:grid-cols-3">
                                    <!-- Campos Obrigatórios -->
                                    <div class="md:col-span-3">
                                        <label class="block text-sm font-medium">Tipo de Cadastro</label>
                                        <select id="person-type" required
                                            class="w-full px-3 py-2 mt-1 border rounded-md md:w-1/3">
                                            <option value="cliente">Cliente Direto</option>
                                            <option value="revendedor">Revendedor</option>
                                            <option value="fornecedor">Fornecedor</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium">Nome Completo</label>
                                        <input type="text" id="person-name" required
                                            class="w-full px-3 py-2 mt-1 border rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium">Email</label>
                                        <input type="email" id="person-email" required
                                            class="w-full px-3 py-2 mt-1 border rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium">Telefone</label>
                                        <input type="tel" id="person-phone" required
                                            class="w-full px-3 py-2 mt-1 border rounded-md">
                                    </div>
                                    <div class="md:col-span-3">
                                        <label class="block text-sm font-medium">Endereço</label>
                                        <input type="text" id="person-address" required
                                            class="w-full px-3 py-2 mt-1 border rounded-md">
                                    </div>

                                    <!-- Campos Opcionais -->
                                    <hr class="md:col-span-3">
                                    <h3 class="text-lg font-medium md:col-span-3">Dados Adicionais (Opcional)</h3>
                                    <div>
                                        <label class="block text-sm font-medium">CPF</label>
                                        <input type="text" id="person-cpf"
                                            class="w-full px-3 py-2 mt-1 border rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium">RG</label>
                                        <input type="text" id="person-rg"
                                            class="w-full px-3 py-2 mt-1 border rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium">Instagram</label>
                                        <input type="text" id="person-insta"
                                            class="w-full px-3 py-2 mt-1 border rounded-md">
                                    </div>
                                </div>
                                <div class="mt-6 text-right">
                                    <button type="submit"
                                        class="px-6 py-2 font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">Salvar
                                        Pessoa</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- =========== PÁGINA: FINANCEIRO =========== -->
                    <div id="page-financeiro" class="page">
                        <h2 class="text-3xl font-semibold text-gray-800">Controle Financeiro</h2>
                        <!-- Abas da Seção -->
                        <div class="mt-4 border-b border-gray-200">
                            <nav class="flex -mb-px space-x-6" id="financeiro-tabs">
                                <button data-tab="tab-financeiro-summary"
                                    class="financeiro-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-indigo-600 border-indigo-500">Resumo
                                    do Caixa</button>
                               <button id="btn-tab-contas-a-pagar" data-tab="tab-financeiro-bills" class="financeiro-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">Contas a Pagar</button>
                                <button data-tab="tab-financeiro-history"
                                    class="financeiro-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">Todos
                                    Lançamentos</button>
                            </nav>
                        </div>

                        <!-- Conteúdo da Aba: Resumo do Caixa -->
                        <div id="tab-financeiro-summary" class="financeiro-tab-content mt-6">
                            <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
                                <div class="p-6 bg-white rounded-lg shadow-md">
                                    <p class="text-sm font-medium text-gray-500 uppercase">Receita (Mês)</p>
                                    <p id="summary-revenue" class="text-3xl font-bold text-green-600">R$ 0,00</p>
                                </div>
                                <div class="p-6 bg-white rounded-lg shadow-md">
                                    <p class="text-sm font-medium text-gray-500 uppercase">Despesas (Mês)</p>
                                    <p id="summary-expenses" class="text-3xl font-bold text-red-600">- R$ 0,00</p>
                                </div>
                                <div class="p-6 bg-white rounded-lg shadow-md">
                                    <p class="text-sm font-medium text-gray-500 uppercase">Saldo (Mês)</p>
                                    <p id="summary-balance" class="text-3xl font-bold text-blue-600">R$ 0,00</p>
                                </div>
                            </div>
                            <div class="p-6 mt-6 bg-white rounded-lg shadow-md">
    <h3 class="text-lg font-medium">Fluxo de Caixa (Últimos 30 dias)</h3>
    <div class="w-full h-64 mt-4 relative">
        <canvas id="cash-flow-chart"></canvas>
    </div>
</div>
                        </div>

                       <!-- Conteúdo da Aba: Contas a Pagar (VERSÃO ATUALIZADA) -->
<div id="tab-financeiro-bills" class="financeiro-tab-content hidden mt-6">
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
        
        <!-- Coluna 1: Cadastro de Conta (Fica igual) -->
        <div class="p-6 bg-white rounded-lg shadow-md lg:col-span-1">
            <h3 class="text-lg font-medium">Nova Conta/Despesa</h3>
            <form id="form-add-bill" class="space-y-4 mt-4">
                <div>
                    <label class="block text-sm font-medium">Descrição</label>
                    <input type="text" id="bill-desc" required class="w-full px-3 py-2 mt-1 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium">Valor (R$)</label>
                    <input type="number" id="bill-value" step="0.01" required class="w-full px-3 py-2 mt-1 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium">Data de Vencimento</label>
                    <input type="date" id="bill-due-date" required class="w-full px-3 py-2 mt-1 border rounded-md">
                </div>
                <!-- Lógica de Parcelas (Fica igual) -->
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="bill-is-installment" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="bill-is-installment" class="block text-sm font-medium">É parcelado?</label>
                </div>
                <div id="bill-installments-group" class="hidden space-y-2">
                    <div>
                        <label class="block text-sm font-medium">Número de Parcelas</label>
                        <input type="number" id="bill-installments-count" value="2" min="2" class="w-full px-3 py-2 mt-1 border rounded-md">
                    </div>
                    <p class="text-xs text-gray-500">A data de vencimento será a da 1ª parcela. As seguintes serão 30 dias após a outra.</p>
                </div>
                <!-- Fim da Lógica de Parcelas -->
                <button type="submit" class="w-full px-4 py-2 font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">Adicionar Conta</button>
            </form>
        </div>
        
        <!-- Coluna 2: Listas de Contas (ATUALIZADA) -->
        <div class="p-6 bg-white rounded-lg shadow-md lg:col-span-2 space-y-6">
            
            <!-- Lista 1: Contas A Pagar -->
            <div>
                <h3 class="text-lg font-medium">Contas a Pagar</h3>
                <div class="mt-4 overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Descrição</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Vencimento</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Valor</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="bills-list-table" class="bg-white divide-y divide-gray-200">
                            <!-- JS popula aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Lista 2: Contas Pagas (NOVO) -->
            <div>
                <h3 class="text-lg font-medium">Contas Pagas (Mês Atual)</h3>
                 <div class="mt-4 overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Descrição</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Data Pag.</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Valor</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="bills-paid-table" class="bg-white divide-y divide-gray-200">
                            <!-- JS popula aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>
</div>

                        <!-- Conteúdo da Aba: Todos Lançamentos -->
                        <div id="tab-financeiro-history" class="financeiro-tab-content hidden mt-6">
                            <div class="p-6 bg-white rounded-lg shadow-md">
                                <h3 class="text-lg font-medium">Histórico de Lançamentos</h3>
                                <table class="min-w-full mt-4 divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Data</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Descrição</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Tipo</th>
                                            <th
                                                class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody id="finance-history-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Exemplo -->
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4">24/10/2025</td>
                                            <td class="px-6 py-4">Venda Direta #1001</td>
                                            <td class="px-6 py-4"><span
                                                    class="px-2 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full">Entrada</span>
                                            </td>
                                            <td class="px-6 py-4 font-medium text-green-600">+ R$ 150,00</td>
                                        </tr>
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4">23/10/2025</td>
                                            <td class="px-6 py-4">Cadastro Produto REF123 (Custo)</td>
                                            <td class="px-6 py-4"><span
                                                    class="px-2 py-1 text-xs font-medium text-red-800 bg-red-100 rounded-full">Saída</span>
                                            </td>
                                            <td class="px-6 py-4 font-medium text-red-600">- R$ 75,00</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>

            </main>
            <!-- =========== RODAPÉ FIXO =========== -->
<footer class="absolute bottom-0 right-0 p-3 text-xs text-gray-500 bg-gray-100 bg-opacity-70">
    Desenvolvido por Alessandro Leonello Ribeiro
</footer>
        </div>
    </div>

    <!-- =========== MODAL GENÉRICO (para pop-ups) =========== -->
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-6 hidden bg-black bg-opacity-50">
        <div id="modal-content" class="w-full max-w-4xl p-6 bg-white rounded-lg shadow-xl flex flex-col max-h-[90vh]">
            <div class="flex items-center justify-between">
                <h3 id="modal-title" class="text-xl font-medium">Modal Title</h3>
                <button id="modal-close" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modal-body" class="mt-4 overflow-y-auto">
                <p>Modal body content goes here.</p>
            </div>
        </div>
    </div>

    <!-- Canvas oculto para gerar códigos de barra -->
    <canvas id="barcode-canvas" style="display: none;"></canvas>
    <!-- =========== SCRIPTS =========== -->

    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc,
            collection,
            addDoc,
            query,
            where,
            onSnapshot,
            deleteDoc,
            updateDoc,
            serverTimestamp,
            writeBatch,
            getDocs,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";



        // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---
        let app, auth, db;
        let userId = null; // ID do usuário logado

        // Configuração do Firebase (para uso local/pessoal)
        // Como você não vai publicar, pode colocar os dados aqui.
        const firebaseConfig = {
            apiKey: "AIzaSyAyr32EibUO6RE4yp5ezEaRW1xtLq3UquI",
            authDomain: "brigida-semijoias.firebaseapp.com",
            projectId: "brigida-semijoias",
            storageBucket: "brigida-semijoias.firebasestorage.app",
            messagingSenderId: "350076180515",
            appId: "1:350076180515:web:7b970020eaaf9eeaf43996"
        };

        // Pega o appId da configuração para usar nos caminhos do banco de dados
        const appId = firebaseConfig.appId;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase inicializado com sucesso.");

            // A autenticação agora será tratada pelo onAuthStateChanged
            // e pelos formulários de login/registro.

        } catch (error) {
            console.error("Erro ao inicializar o Firebase:", error);
            document.body.innerHTML = "<h1>Erro ao conectar ao sistema. Verifique o console.</h1>";

        }

        // Elementos da UI
        const pageAuth = document.getElementById('page-auth');
        const pageMainApp = document.getElementById('page-main-app');
        const userInfo = document.getElementById('user-info');
        const authError = document.getElementById('auth-error');

        // Monitorar estado de autenticação (Login/Logout real)
        onAuthStateChanged(auth, (user) => {
            if (user && !user.isAnonymous) {
                // Usuário está logado (com email/senha)
                userId = user.uid;
                pageAuth.style.display = 'none';
                pageMainApp.style.display = 'block';
                userInfo.textContent = `Logado como: ${user.email}`;
                showPage('page-dashboard'); // Vai para o dashboard após login


                // Inicia os listeners para carregar dados em tempo real
                startDataListeners();

            } else {
                // Usuário está deslogado ou anônimo
                userId = auth.currentUser?.uid; // Mantém o ID anônimo se houver
                pageAuth.style.display = 'flex';
                pageMainApp.style.display = 'none';
                userInfo.textContent = 'Não logado';
                // Para todos os listeners em tempo real para evitar vazamento de dados
                stopAllListeners();
                currentSaleItems = [];
                dataReadyCount = 0;

                // Limpa as tabelas da UI
                document.getElementById('product-list-table').innerHTML = '';
                document.getElementById('people-list-table').innerHTML = '';
                document.getElementById('low-stock-list').innerHTML = '';
                document.getElementById('history-list-table').innerHTML = '';
                document.getElementById('consign-list-table').innerHTML = '';
                document.getElementById('finance-history-table').innerHTML = '';
                // (Adicione aqui a limpeza de outras tabelas no futuro)
                const billsTable = document.getElementById('bills-list-table');
                if (billsTable) billsTable.innerHTML = '';
                const paidBillsTable = document.getElementById('bills-paid-table');
    if (paidBillsTable) paidBillsTable.innerHTML = '';
                if (cashFlowChart) {
        cashFlowChart.destroy();
        cashFlowChart = null;
    }
                const saleClientSelect = document.getElementById('sale-client');
                if (saleClientSelect) {
                    saleClientSelect.innerHTML = '<option value="Consumidor Final">Consumidor Final</option>';
                }
            }
        });

        // --- LÓGICA DE CARREGAMENTO DE DADOS (FIRESTORE) ---

        // Array para guardar todas as nossas "escutas" (listeners) do Firestore
        let activeListeners = [];
        let allUserProducts = []; // Cache global de produtos
        let currentSaleItems = []; // "Carrinho" da venda atual
        let allUserPeople = []; // Cache global de pessoas
       

       /**
 * Inicia todos os listeners de dados do usuário
 */
function startDataListeners() {
    if (!userId) return; 
    
    stopAllListeners(); 
    console.log(`Iniciando listeners para o usuário: ${userId}`);
    
    // Assegura que Produtos e Pessoas carregam primeiro
    loadProducts();
    loadPeople();
    loadCategories(); // Categories também é essencial para renderização

    // --- CARREGAMENTO DO DASHBOARD EM BACKGROUND (MELHORIA) ---
    // Cria promessas para os listeners que alimentam o Dashboard
    const salesPromise = new Promise(resolve => { loadSalesHistory(resolve); });
    const financialPromise = new Promise(resolve => { loadFinancialHistory(resolve); });

    // Espera que AMBOS Vendas e Financeiro tenham carregado pelo menos uma vez
    Promise.all([salesPromise, financialPromise]).then(() => {
        console.log("CARREGAMENTO DASHBOARD FINALIZADO. Atualizando UI.");
        updateDashboard();
    });
}
        /**
         * Para (unsubscribe) todos os listeners ativos do Firestore.
         * Isso é CRUCIAL ao fazer logout.
         */
        function stopAllListeners() {
            console.log(`Parando ${activeListeners.length} listeners ativos`);
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
        }

        /**
         * Cria o listener (onSnapshot) para a coleção de PRODUTOS
         */
        /**
         * Cria o listener (onSnapshot) para a coleção de PRODUTOS
         */
        function loadProducts() {
            // Caminho seguro para os dados do usuário
            const collectionPath = `artifacts/${appId}/users/${userId}/produtos`;
            const q = query(collection(db, collectionPath)); // Você pode adicionar filtros aqui depois

            const unsubscribe = onSnapshot(q, (snapshot) => {
                console.log(`Produtos recebidos: ${snapshot.size} docs`);
                const products = [];
                snapshot.forEach(doc => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                // Ordena os produtos por nome (opcional)
                products.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));

                // ---- ATUALIZAÇÃO IMPORTANTE ----
                allUserProducts = products; // 1. Salva na cache global

                // 2. Aplica o filtro de busca atual, se houver
                const currentSearchTerm = document.getElementById('product-search-input')?.value || '';
                const filteredProducts = filterProducts(currentSearchTerm);
                // ------------------------------

                // Envia os dados filtrados para renderizar na tela
                renderProductList(filteredProducts);

               

            }, (error) => {
                console.error("Erro ao carregar produtos: ", error);
                showModal("Erro de Dados", "Não foi possível carregar seus produtos.");
            });

            // Salva a função 'unsubscribe' para podermos pará-la no logout
            activeListeners.push(unsubscribe);
        }
        /**
         * Atualiza a tabela de produtos e a lista de estoque baixo no dashboard
         */
        /**
         * Atualiza a tabela de produtos e a lista de estoque baixo no dashboard
         */
        /**
         * Atualiza a tabela de produtos, a lista de estoque baixo e a lista de seleção de etiquetas
         */
        /**
         * Atualiza a tabela de produtos, a lista de estoque baixo e a lista de seleção de etiquetas
         */
        function renderProductList(products) {
            const productTableBody = document.getElementById('product-list-table');
            const lowStockList = document.getElementById('low-stock-list');
            const labelProductList = document.getElementById('label-product-list'); // Lista de etiquetas

            // Limpa o conteúdo atual
            productTableBody.innerHTML = '';
            lowStockList.innerHTML = '';
            labelProductList.innerHTML = '';

            if (products.length === 0) {
                productTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">Nenhum produto cadastrado ainda.</td></tr>';
                lowStockList.innerHTML = '<li class="text-gray-500 text-sm">Nenhum produto cadastrado.</li>';
                labelProductList.innerHTML = '<li class="text-gray-500 text-sm p-1">Cadastre produtos para gerar etiquetas.</li>';
                return;
            }

            let lowStockCount = 0;

            products.forEach(prod => {

                // --- Popula a Tabela de Produtos (como antes) ---
                const tr = document.createElement('tr');
                tr.dataset.id = prod.id;
                tr.innerHTML = `
            <td class="px-6 py-4"><input type="checkbox" class="rounded product-checkbox" data-id="${prod.id}"></td>
            
            <!-- Coluna de Nome/Ref (permitindo quebra de linha) -->
            <td class="px-6 py-4 min-w-[150px] break-words"> 
                <div class="font-medium">${prod.nome}</div>
                <div class="text-sm text-gray-500">${prod.ref}</div>
            </td>
            
            <!-- Coluna Categoria (permitindo quebra de linha) -->
            <td class="px-6 py-4 break-words">${prod.categoria}</td>
            
            <!-- Coluna Estoque (pode ser nowrap) -->
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-medium ${prod.estoque <= 0 ? 'text-red-800 bg-red-100' : (prod.estoque <= 5 ? 'text-yellow-800 bg-yellow-100' : 'text-green-800 bg-green-100')} rounded-full">
                    ${prod.estoque} un.
                </span>
            </td>
            
            <!-- Coluna Preço (pode ser nowrap) -->
            <td class="px-6 py-4 whitespace-nowrap">R$ ${prod.venda.toFixed(2).replace('.', ',')}</td>
            
            <!-- COLUNA DE AÇÕES CORRIGIDA (sticky) -->
            <td class="sticky right-0 px-6 py-4 whitespace-nowrap text-sm font-medium bg-white bg-opacity-95 shadow-sm">
                <div class="flex items-center space-x-2">
                    <button class="btn-edit-product text-indigo-600 hover:text-indigo-900" data-id="${prod.id}"><i data-lucide="edit-2" class="w-5 h-5 pointer-events-none"></i></button>
                    <button class="btn-delete-product text-red-600 hover:text-red-900" data-id="${prod.id}"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button>
                </div>
            </td>
        `;
                productTableBody.appendChild(tr);

                // --- Popula a Lista de Estoque Baixo (como antes) ---
                if (prod.estoque <= 5) {
                    lowStockCount++;
                    const li = document.createElement('li');
                    li.className = 'flex justify-between';
                    li.innerHTML = `
                <span>${prod.nome}</span> 
                <span class="font-medium ${prod.estoque === 0 ? 'text-red-600' : 'text-yellow-600'}">
                    ${prod.estoque} un.
                </span>
            `;
                    lowStockList.appendChild(li);
                }

                // --- ATUALIZADO: Popula a Lista de Gerar Etiquetas (com campo de Qtd) ---
                const labelItem = document.createElement('div');
                labelItem.className = 'flex items-center justify-between space-x-2 p-1 hover:bg-gray-50 rounded-md';
                labelItem.innerHTML = `
            <label class="flex items-center space-x-2 cursor-pointer flex-grow overflow-hidden">
                <input type="checkbox" class="rounded label-product-checkbox" data-id="${prod.id}">
                <span class="text-sm truncate" title="${prod.ref} - ${prod.nome}">${prod.ref} - ${prod.nome}</span>
            </label>
            <input 
                type="number" 
                value="1" 
                min="1" 
                class="label-product-qty w-16 px-2 py-1 text-sm border rounded-md bg-gray-100" 
                data-id="${prod.id}" 
                disabled
            >
        `;
                labelProductList.appendChild(labelItem);

            }); // Fim do loop forEach

            if (lowStockCount === 0 && products.length > 0) {
                lowStockList.innerHTML = '<li class="text-gray-500 text-sm">Nenhum item com estoque baixo.</li>';
            }

            // Re-cria os ícones de editar/excluir
            lucide.createIcons();
        }

        /**
         * Filtra a lista global de produtos (allUserProducts) com base em um termo.
         */
        function filterProducts(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            if (!term) {
                return allUserProducts; // Retorna tudo se o filtro estiver vazio
            }

            return allUserProducts.filter(prod => {
                // Verifica se o termo existe no nome, ref ou categoria
                return (
                    (prod.nome && prod.nome.toLowerCase().includes(term)) ||
                    (prod.ref && prod.ref.toLowerCase().includes(term)) ||
                    (prod.categoria && prod.categoria.toLowerCase().includes(term))
                );
            });
        }

        /**
         * Cria o listener (onSnapshot) para a coleção de PESSOAS
         */
        function loadPeople() {
            const collectionPath = `artifacts/${appId}/users/${userId}/pessoas`;
            const q = query(collection(db, collectionPath));

            const unsubscribe = onSnapshot(q, (snapshot) => {
                console.log(`Pessoas recebidas: ${snapshot.size} docs`);
                const people = [];
                snapshot.forEach(doc => {
                    people.push({ id: doc.id, ...doc.data() });
                });
                people.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));

                // ---- ATUALIZAÇÃO IMPORTANTE ----
                allUserPeople = people; // 1. Salva na cache global

                // 2. Aplica o filtro de busca atual, se houver
                const currentSearchTerm = document.getElementById('people-search-input')?.value || '';
                const filteredPeople = filterPeople(currentSearchTerm);
                // ------------------------------

                // ATUALIZAÇÃO: Chamar as duas funções de renderização
                // A tabela recebe a lista filtrada, o dropdown recebe a lista completa
                renderPeopleList(filteredPeople);
                renderPeopleDropdown(allUserPeople); // Dropdown sempre com todos

            }, (error) => {
                console.error("Erro ao carregar pessoas: ", error);
                showModal("Erro de Dados", "Não foi possível carregar sua lista de pessoas.");
            });

            activeListeners.push(unsubscribe);
        }
        /**
         * Atualiza a tabela de pessoas
         */
        function renderPeopleList(people) {
            const peopleTableBody = document.getElementById('people-list-table');
            peopleTableBody.innerHTML = '';

            // Remove o item de exemplo da tabela
            const exampleRow = peopleTableBody.querySelector('tr');
            if (exampleRow) exampleRow.remove();

            if (people.length === 0) {
                peopleTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Nenhuma pessoa cadastrada ainda.</td></tr>';
                return;
            }

            const typeBadges = {
                'cliente': 'text-blue-800 bg-blue-100',
                'revendedor': 'text-purple-800 bg-purple-100',
                'fornecedor': 'text-gray-800 bg-gray-100'
            };
            const typeNames = {
                'cliente': 'Cliente Direto',
                'revendedor': 'Revendedor',
                'fornecedor': 'Fornecedor'
            };

            people.forEach(person => {
                const tr = document.createElement('tr');
                tr.dataset.id = person.id;
                tr.innerHTML = `
            <td class="px-6 py-4"><input type="checkbox" class="rounded person-checkbox" data-id="${person.id}"></td>
            <td class="px-6 py-4 whitespace-nowrap">${person.nome}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm">${person.email}</div>
                <div class="text-sm text-gray-500">${person.telefone}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-medium ${typeBadges[person.tipo] || 'text-gray-800 bg-gray-100'} rounded-full">
                    ${typeNames[person.tipo] || 'Não definido'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                <button class="btn-edit-person text-indigo-600 hover:text-indigo-900" data-id="${person.id}"><i data-lucide="edit-2" class="w-5 h-5 pointer-events-none"></i></button>
                <button class="btn-delete-person text-red-600 hover:text-red-900" data-id="${person.id}"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button>
            </td>
        `;
                peopleTableBody.appendChild(tr);
            });

            // Re-cria os ícones de editar/excluir
            lucide.createIcons();
        }

        /**
         * Atualiza o <select> de Clientes/Revendedores na página de Vendas
         */
        function renderPeopleDropdown(people) {
            const select = document.getElementById('sale-client');
            if (!select) return; // Sai se o elemento não existir

            // Salva o valor que estava selecionado (se houver)
            const selectedValue = select.value;

            // Limpa as opções antigas, exceto a primeira
            select.innerHTML = '<option value="Consumidor Final">Consumidor Final</option>';

            // Filtra apenas por clientes e revendedores
            const clients = people.filter(p => p.tipo === 'cliente' || p.tipo === 'revendedor');

            clients.forEach(person => {
                const option = document.createElement('option');
                option.value = person.nome; // Usar o NOME como valor (ou person.id se preferir)
                option.textContent = `${person.nome} (${person.tipo})`;
                select.appendChild(option);
            });

            // Tenta restaurar o valor que estava selecionado
            select.value = selectedValue || 'Consumidor Final';
        }
        /**
         * Cria o listener (onSnapshot) para a coleção de CATEGORIAS
         */
        function loadCategories() {
            const collectionPath = `artifacts/${appId}/users/${userId}/categorias`;
            const q = query(collection(db, collectionPath));

            const unsubscribe = onSnapshot(q, (snapshot) => {
                console.log(`Categorias recebidas: ${snapshot.size} docs`);
                const categories = [];
                snapshot.forEach(doc => {
                    categories.push({ id: doc.id, ...doc.data() });
                });
                // Ordena por nome
                categories.sort((a, b) => a.nome.localeCompare(b.nome));

                renderCategories(categories);

            }, (error) => {
                console.error("Erro ao carregar categorias: ", error);
                // Não mostramos modal aqui para não ser intrusivo, apenas logamos
            });

            activeListeners.push(unsubscribe);
        }

        /**
         * Atualiza o <select> de categorias no formulário de produto
         */
        function renderCategories(categories) {
            const select = document.getElementById('prod-categoria');
            if (!select) return;

            // 1. Limpa apenas as opções que vieram do Firebase (para não duplicar)
            // Deixamos as opções padrão (Anéis, Brincos, etc.)
            select.querySelectorAll('option.custom-category').forEach(opt => opt.remove());

            // 2. Adiciona as novas opções
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.nome;
                option.textContent = cat.nome;
                option.className = 'custom-category'; // Marca como customizada

                // Evita adicionar duplicatas das opções padrão
                let exists = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value.toLowerCase() === cat.nome.toLowerCase()) {
                        exists = true;
                        break;
                    }
                }

                if (!exists) {
                    select.appendChild(option);
                }
            });
        }
        // --- FIM DA LÓGICA DE CARREGAMENTO ---

        // --- LÓGICA DE NAVEGAÇÃO DA SPA ---

        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const pages = document.querySelectorAll('.page');

        function showPage(pageId) {
            // Esconde todas as páginas (usa Tailwind 'hidden')
            pages.forEach(page => {
                page.classList.add('hidden');
                page.classList.remove('active'); // opcional, remove classe antiga se existir
            });

            // Mostra apenas a página desejada
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.remove('hidden');
                activePage.classList.add('active'); // opcional: mantém compatibilidade com CSS customizado
                if (window.lucide) lucide.createIcons();
            } else {
                console.error(`Página com ID ${pageId} NÃO encontrada!`);
            }

            // Marca link ativo no sidebar
            sidebarLinks.forEach(link => {
                link.classList.remove('active');
                link.classList.remove('text-indigo-600', 'font-semibold'); // limpa estilo antigo
                if (link.dataset.page === pageId) {
                    link.classList.add('active');
                    link.classList.add('text-indigo-600', 'font-semibold');
                } else {
                    link.classList.remove('text-indigo-600', 'font-semibold');
                }
            });
        }

        // Event listener do sidebar (DEVE HAVER APENAS UM!)
        const sidebarEl = document.getElementById('sidebar');
        if (sidebarEl) {
            sidebarEl.addEventListener('click', (e) => {
                const link = e.target.closest('a.sidebar-link');
                if (link && link.dataset.page) {
                    e.preventDefault();
                    showPage(link.dataset.page);
                }
            });
        }
        // --- FIM DA LÓGICA DE NAVEGAÇÃO ---
        // --- LÓGICA DAS ABAS INTERNAS (Produtos, Vendas, etc.) ---

        function setupTabs(containerId, btnClass, contentClass) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.addEventListener('click', (e) => {
                const tabButton = e.target.closest(`.${btnClass}`);
                if (!tabButton) return;

                const tabId = tabButton.dataset.tab;

                // --- CORREÇÃO INICIA AQUI ---

                // 1. Encontra o container da PÁGINA (ex: "page-produtos")
                const pageContainer = container.closest('.page');
                if (!pageContainer) {
                    console.error("Erro no setupTabs: não foi possível encontrar o '.page' pai.");
                    return;
                }

                // 2. Esconde todos os conteúdos DENTRO daquela página
                pageContainer.querySelectorAll(`.${contentClass}`).forEach(content => {
                    content.classList.add('hidden');
                });

                // --- CORREÇÃO TERMINA AQUI ---

                // Remove classe ativa dos botões
                container.querySelectorAll(`.${btnClass}`).forEach(btn => {
                    btn.classList.remove('text-indigo-600', 'border-indigo-500');
                    btn.classList.add('text-gray-500', 'border-transparent');
                });

                // Mostra o conteúdo correto
                document.getElementById(tabId)?.classList.remove('hidden');
                // Ativa o botão correto
                tabButton.classList.add('text-indigo-600', 'border-indigo-500');
                tabButton.classList.remove('text-gray-500', 'border-transparent');
            });
        }
        // Inicializa os sistemas de abas
        setupTabs('product-tabs', 'product-tab-btn', 'product-tab-content');
        setupTabs('vendas-tabs', 'vendas-tab-btn', 'vendas-tab-content');
        setupTabs('pessoas-tabs', 'pessoas-tab-btn', 'pessoas-tab-content');
        setupTabs('financeiro-tabs', 'financeiro-tab-btn', 'financeiro-tab-content');

        // --- LÓGICA DE AUTENTICAÇÃO (Formulários) ---

        const tabLogin = document.getElementById('tab-login');
        const tabRegister = document.getElementById('tab-register');
        const formLogin = document.getElementById('form-login');
        const formRegister = document.getElementById('form-register');

        tabLogin.addEventListener('click', () => {
            tabLogin.classList.add('text-indigo-600', 'border-indigo-600');
            tabLogin.classList.remove('text-gray-500');
            tabRegister.classList.add('text-gray-500');
            tabRegister.classList.remove('text-indigo-600', 'border-indigo-600');
            formLogin.classList.remove('hidden');
            formRegister.classList.add('hidden');
            authError.textContent = '';
        });

        tabRegister.addEventListener('click', () => {
            tabRegister.classList.add('text-indigo-600', 'border-indigo-600');
            tabRegister.classList.remove('text-gray-500');
            tabLogin.classList.add('text-gray-500');
            tabLogin.classList.remove('text-indigo-600', 'border-indigo-600');
            formRegister.classList.remove('hidden');
            formLogin.classList.add('hidden');
            authError.textContent = '';
        });

        // Registrar
        formRegister.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const pass = document.getElementById('register-password').value;
            authError.textContent = '';
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
                // O onAuthStateChanged vai cuidar de redirecionar
            } catch (error) {
                console.error("Erro ao registrar:", error);
                authError.textContent = "Erro ao registrar: " + error.message;
            }
        });

        // Login
        formLogin.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            authError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                // O onAuthStateChanged vai cuidar de redirecionar
            } catch (error) {
                console.error("Erro ao entrar:", error);
                authError.textContent = "Erro ao entrar: " + error.message;
            }
        });

        // Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            try {
                await signOut(auth);
                // O onAuthStateChanged vai cuidar de redirecionar
            } catch (error) {
                console.error("Erro ao sair:", error);
            }
        });

        // --- LÓGICA DE PRODUTOS (Exemplos) ---

        const prodCusto = document.getElementById('prod-custo');
        const prodMargem = document.getElementById('prod-margem');
        const prodVenda = document.getElementById('prod-venda');
        const prodRef = document.getElementById('prod-ref');

        // Calcular preço de venda
        function calcularPrecoVenda() {
            const custo = parseFloat(prodCusto.value) || 0;
            const margem = parseFloat(prodMargem.value) || 100; // 100% por padrão
            const venda = custo * (1 + (margem / 100));
            prodVenda.value = venda.toFixed(2).replace('.', ',');
        }

        // Gerar preview do código de barras
        function gerarBarcodePreview() {
            const ref = prodRef.value;
            if (ref) {
                JsBarcode("#barcode-preview", ref, {
                    format: "CODE128",
                    displayValue: true,
                    fontSize: 14,
                    margin: 10,
                    height: 50
                });
            } else {
                document.getElementById("barcode-preview").innerHTML = "";
            }
        }

        prodCusto.addEventListener('input', calcularPrecoVenda);
        prodMargem.addEventListener('input', calcularPrecoVenda);
        prodRef.addEventListener('input', gerarBarcodePreview);

        // Salvar produto (Versão simplificada, sem foto)
        document.getElementById('form-add-product').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                showModal("Erro", "Você precisa estar logado para salvar produtos.");
                return;
            }

            const form = e.currentTarget;
            const saveButton = form.querySelector('button[type="submit"]');
            const originalButtonText = saveButton.innerHTML;

            // Desabilita o botão e mostra "Salvando..."
            saveButton.disabled = true;
            saveButton.innerHTML = `<i class="animate-spin inline-block w-4 h-4 border-[2px] border-current border-t-transparent rounded-full mr-2" role="status"></i>Salvando`;

            try {
                 const collectionPath = `artifacts/${appId}/users/${userId}/produtos`;
                
// --- 3. VERIFICAR DUPLICIDADE DE REFERÊNCIA ---
            const newRef = document.getElementById('prod-ref').value.trim();
            if (!newRef) {
                throw new Error("O Código de Referência é obrigatório.");
            }
            
            const productQuery = query(
                collection(db, collectionPath), 
                where("ref", "==", newRef), // Onde a 'ref' é igual à nova ref
                where("ownerId", "==", userId)
            );
            
            const querySnapshot = await getDocs(productQuery);
            
            if (!querySnapshot.empty) {
                // Se a consulta não for vazia, significa que o produto JÁ EXISTE
                throw new Error(`A referência "${newRef}" já está sendo usada por outro produto.`);
            }

                // ---- Salvar dados no Firestore (sem foto) ----
                const produto = {
                    nome: document.getElementById('prod-nome').value,
                    custo: parseFloat(prodCusto.value) || 0,
                    margem: parseFloat(prodMargem.value) || 0,
                    venda: parseFloat(prodVenda.value.replace(',', '.')) || 0,
                    categoria: document.getElementById('prod-categoria').value,
                    ref: prodRef.value,
                    estoque: parseInt(document.getElementById('prod-estoque').value) || 0,
                    descricao: document.getElementById('prod-desc').value,
                    // fotoUrl: null, // Não precisamos mais deste campo
                    createdAt: serverTimestamp(),
                    ownerId: userId
                };
                
               const docRef = await addDoc(collection(db, collectionPath), produto);

                showModal("Sucesso", `Produto "${produto.nome}" salvo com ID: ${docRef.id}`);
                form.reset(); // Limpa o formulário
                gerarBarcodePreview(); // Limpa o preview do código de barras

            } catch (error) {
                console.error("Erro ao salvar produto: ", error);
                showModal("Erro", "Falha ao salvar o produto: " + error.message);
            } finally {
                // Reabilita o botão e restaura o texto
                saveButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
            }
        });

        // --- LÓGICA DE VENDAS (Exemplo) ---

        const radioVendaDireta = document.querySelector('input[name="sale-type"][value="direta"]');
        const radioConsignacao = document.querySelector('input[name="sale-type"][value="consignacao"]');
        const fieldsVendaDireta = document.getElementById('fields-venda-direta');
        const fieldsConsignacao = document.getElementById('fields-consignacao');
        const btnFinalizeSale = document.getElementById('btn-finalize-sale');

        radioVendaDireta.addEventListener('change', () => {
            fieldsVendaDireta.style.display = 'block';
            fieldsConsignacao.style.display = 'none';
            btnFinalizeSale.textContent = 'Finalizar Venda';
            btnFinalizeSale.classList.replace('bg-blue-600', 'bg-green-600');
            btnFinalizeSale.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
        });

      radioConsignacao.addEventListener('change', () => {
            fieldsVendaDireta.style.display = 'none';
            fieldsConsignacao.style.display = 'block';
            btnFinalizeSale.textContent = 'Abrir Consignação';
            btnFinalizeSale.classList.replace('bg-green-600', 'bg-blue-600');
            btnFinalizeSale.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
            
            // --- LINHA ADICIONADA ---
            // Define a data de acerto para 30 dias no futuro
            document.getElementById('sale-due-date').value = getFutureDateString(30);
        });

        // --- LÓGICA DO MODAL (Substitui alert() e confirm()) ---

        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.getElementById('modal-close');

        function showModal(title, message) {
            modalTitle.textContent = title;
            modalBody.innerHTML = `<p>${message}</p>`; // Cuidado com XSS se message vier do usuário
            modalContainer.style.display = 'flex';
        }

        function hideModal() {
            modalContainer.style.display = 'none';
        }
        // --- FUNÇÃO HELPER PARA CALCULAR DATAS ---
/**
 * Retorna uma data futura formatada como 'YYYY-MM-DD'.
 * @param {number} daysToAdd - O número de dias a adicionar à data de hoje.
 */
function getFutureDateString(daysToAdd) {
    const today = new Date();
    const futureDate = new Date(today);
    futureDate.setDate(today.getDate() + daysToAdd);
    
    // Formata para YYYY-MM-DD
    const year = futureDate.getFullYear();
    const month = String(futureDate.getMonth() + 1).padStart(2, '0'); // getMonth() é 0-indexado
    const day = String(futureDate.getDate()).padStart(2, '0');
    
    return `${year}-${month}-${day}`;
}
// --- FIM DA FUNÇÃO HELPER ---

        modalClose.addEventListener('click', hideModal);
        modalContainer.addEventListener('click', (e) => {
            // Fecha se clicar fora do conteúdo
            if (e.target === modalContainer) {
                hideModal();
            }
        });

        // --- LÓGICA DAS PARCELAS (FINANCEIRO UI) ---
        const billIsInstallment = document.getElementById('bill-is-installment');
        const billInstallmentsGroup = document.getElementById('bill-installments-group');

        if (billIsInstallment) {
            billIsInstallment.addEventListener('change', () => {
                if (billIsInstallment.checked) {
                    billInstallmentsGroup.classList.remove('hidden');
                } else {
                    billInstallmentsGroup.classList.add('hidden');
                }
            });
        }

        // --- LÓGICA DE IMPORTAÇÃO CSV (PRODUTOS) ---
        const fileInput = document.getElementById('csv-file-input');
        const importButton = document.getElementById('btn-import-csv');
        const importStatus = document.getElementById('import-status');

        if (importButton) {
            importButton.addEventListener('click', async () => {
                if (!fileInput.files || fileInput.files.length === 0) {
                    showModal("Erro", "Por favor, selecione um arquivo CSV primeiro.");
                    return;
                }
                if (!userId) {
                    showModal("Erro", "Você precisa estar logado para importar produtos.");
                    return;
                }

                const file = fileInput.files[0];
                importButton.disabled = true; // Desabilita o botão durante o envio
                importStatus.textContent = 'Lendo arquivo';
                importStatus.classList.remove('text-red-600', 'text-green-600');
                importStatus.classList.add('text-blue-600');

                // Usar PapaParse para ler o CSV
                Papa.parse(file, {
                    header: true, // A primeira linha é o cabeçalho
                    skipEmptyLines: true,
                    complete: async (results) => {
                        console.log("Arquivo CSV lido:", results.data);
                        if (!results.data || results.data.length === 0) {
                            importStatus.textContent = 'Erro: Arquivo CSV vazio ou inválido.';
                            importStatus.classList.replace('text-blue-600', 'text-red-600');
                            importButton.disabled = false;
                            return;
                        }

                        // Inicia o processamento em lote
                        await processBatchUpload(results.data);
                        importButton.disabled = false;
                    },
                    error: (err) => {
                        console.error("Erro no PapaParse:", err);
                        importStatus.textContent = `Erro ao ler o arquivo: ${err.message}`;
                        importStatus.classList.replace('text-blue-600', 'text-red-600');
                        importButton.disabled = false;
                    }
                });
            });
        }

        async function processBatchUpload(products) {
            importStatus.textContent = `Processando ${products.length} produtos`;

            try {
                // Criar um "batch" (lote)
                const batch = writeBatch(db);
                const collectionPath = `artifacts/${appId}/users/${userId}/produtos`;

                let validProductsCount = 0;

                for (const prod of products) {
                    // 1. Validar e limpar os dados
                    if (!prod.nome || !prod.ref) {
                        console.warn("Produto pulado (sem nome ou ref):", prod);
                        continue; // Pula este produto
                    }

                    const custo = parseFloat(prod.custo) || 0;
                    const margem = parseFloat(prod.margem) || 100;
                    const venda = custo * (1 + (margem / 100));

                  // 2. Criar o objeto do produto (Convertendo tudo para String para segurança)
            const newProduct = {
                nome: String(prod.nome || '').trim(),
                ref: String(prod.ref || '').trim(),
                custo: custo,
                margem: margem,
                venda: venda,
                estoque: parseInt(prod.estoque) || 0,
                categoria: prod.categoria ? String(prod.categoria).trim() : 'Sem Categoria',
                descricao: String(prod.descricao || '').trim(),
                createdAt: serverTimestamp(),
                ownerId: userId
            };

                    // 3. Adicionar ao lote (batch)
                    // Criamos um 'doc' novo com ID automático
                    const newDocRef = doc(collection(db, collectionPath));
                    batch.set(newDocRef, newProduct);
                    validProductsCount++;
                }

                if (validProductsCount === 0) {
                    importStatus.textContent = 'Nenhum produto válido encontrado no arquivo. Verifique as colunas.';
                    importStatus.classList.replace('text-blue-600', 'text-red-600');
                    return;
                }

                // 4. Enviar o lote inteiro para o Firebase de uma só vez
                await batch.commit();

                console.log("Lote enviado com sucesso!");
                importStatus.textContent = `Sucesso! ${validProductsCount} produtos importados.`;
                importStatus.classList.replace('text-blue-600', 'text-green-600');
                fileInput.value = ''; // Limpa o campo de arquivo

            } catch (error) {
        console.error("Erro ao enviar o lote para o Firebase:", error);
        importStatus.textContent = `Erro ao salvar no banco de dados: ${error.message}`;
        importStatus.classList.replace('text-blue-600', 'text-red-600');
        throw error; // <-- ADICIONE ESTA LINHA
    }
        }
        // --- FIM DA LÓGICA DE IMPORTAÇÃO ---
        // --- LÓGICA DE IMPORTAÇÃO EXCEL (.xlsx) ---
const excelFileInput = document.getElementById('excel-file-input');
const excelImportButton = document.getElementById('btn-import-excel');

if (excelImportButton) {
    excelImportButton.addEventListener('click', () => {
        if (!excelFileInput.files || excelFileInput.files.length === 0) {
            showModal("Erro", "Por favor, selecione um arquivo Excel (.xlsx) primeiro.");
            return;
        }
        if (!userId) {
            showModal("Erro", "Você precisa estar logado para importar produtos.");
            return;
        }

        const file = excelFileInput.files[0];
        excelImportButton.disabled = true;
        importStatus.textContent = 'Lendo arquivo Excel...';
        importStatus.classList.remove('text-red-600', 'text-green-600');
        importStatus.classList.add('text-blue-600');

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                // XLSX é o objeto global da biblioteca SheetJS que importamos
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Converte a planilha para JSON (array de objetos)
                // A primeira linha do Excel DEVE ser o cabeçalho (nome, ref, custo, etc.)
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (!jsonData || jsonData.length === 0) {
                     importStatus.textContent = 'Erro: Planilha Excel vazia ou em formato inválido.';
                     importStatus.classList.replace('text-blue-600', 'text-red-600');
                     excelImportButton.disabled = false;
                     return;
                }
                
                console.log("Arquivo Excel lido:", jsonData);
                
                // REUTILIZA A MESMA FUNÇÃO de upload em lote!
                await processBatchUpload(jsonData);
                
                importStatus.textContent = `Sucesso! ${jsonData.length} produtos importados do Excel.`;
                importStatus.classList.replace('text-blue-600', 'text-green-600');
                excelImportButton.disabled = false;
                excelFileInput.value = ''; // Limpa o input

            } catch (err) {
                console.error("Erro ao ler arquivo Excel:", err);
                importStatus.textContent = `Erro ao ler Excel: ${err.message}`;
                importStatus.classList.replace('text-blue-600', 'text-red-600');
                excelImportButton.disabled = false;
            }
        };
        
        reader.onerror = (err) => {
            console.error("Erro no FileReader:", err);
            importStatus.textContent = `Erro ao carregar arquivo: ${err.message}`;
            importStatus.classList.replace('text-blue-600', 'text-red-600');
            excelImportButton.disabled = false;
        };

        reader.readAsArrayBuffer(file);
    });
}
// --- FIM DA LÓGICA EXCEL ---
        // --- LÓGICA DE IMPORTAÇÃO POR "COLAR" (PASTE) ---
const pasteInput = document.getElementById('paste-data-input');
const pasteButton = document.getElementById('btn-import-paste');

if (pasteButton) {
    pasteButton.addEventListener('click', () => {
        const textData = pasteInput.value;
        if (!textData || textData.trim().length === 0) {
            showModal("Erro", "Por favor, cole os dados da sua planilha no campo de texto.");
            return;
        }
        if (!userId) {
            showModal("Erro", "Você precisa estar logado para importar produtos.");
            return;
        }

        pasteButton.disabled = true;
        importStatus.textContent = 'Lendo dados colados...';
        importStatus.classList.remove('text-red-600', 'text-green-600');
        importStatus.classList.add('text-blue-600');

        // Usa PapaParse para ler o texto (TSV - Tab Separated Values)
        Papa.parse(textData, {
            header: true,         // Usa a primeira linha como cabeçalho
            skipEmptyLines: true,
            delimiter: "\t",      // Define o separador como "Tab"
            complete: async (results) => {
                console.log("Dados colados lidos:", results.data);
                
                if (!results.data || results.data.length === 0) {
                    importStatus.textContent = 'Erro: Dados colados vazios ou inválidos.';
                    importStatus.classList.replace('text-blue-600', 'text-red-600');
                    pasteButton.disabled = false;
                    return;
                }
                
                // REUTILIZA A MESMA FUNÇÃO de upload em lote que já temos!
                await processBatchUpload(results.data);
                pasteButton.disabled = false;
            },
            error: (err) => {
                console.error("Erro no PapaParse (Paste):", err);
                importStatus.textContent = `Erro ao ler dados: ${err.message}`;
                importStatus.classList.replace('text-blue-600', 'text-red-600');
                pasteButton.disabled = false;
            }
        });
    });
}
// --- FIM DA LÓGICA DE "COLAR" ---
        // --- LÓGICA DE ADICIONAR CATEGORIA (MODAL) ---
        const btnAddCategory = document.getElementById('btn-add-category');

        if (btnAddCategory) {
            btnAddCategory.addEventListener('click', () => {
                // 1. Configurar o Modal
                modalTitle.textContent = 'Adicionar Nova Categoria';
                modalBody.innerHTML = `
            <p class="text-sm text-gray-600 mb-4">Digite o nome da nova categoria que você quer adicionar à lista.</p>
            <div>
                <label for="new-category-name" class="block text-sm font-medium">Nome da Categoria</label>
                <input type="text" id="new-category-name" required class="w-full px-3 py-2 mt-1 border rounded-md" placeholder="Ex: Colares">
                <p id="category-error" class="text-xs text-red-600 mt-1 hidden"></p>
            </div>
            <div class="mt-6 text-right">
                <button type="button" id="btn-cancel-category" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 mr-2">Cancelar</button>
                <button type="button" id="btn-save-category" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">Salvar</button>
            </div>
        `;

                // 2. Mostrar o Modal (sem usar a função showModal(title, msg), 
                //    pois ela sobrepõe o modalBody que acabamos de criar)
                modalContainer.style.display = 'flex';

                const saveBtn = document.getElementById('btn-save-category');
                const cancelBtn = document.getElementById('btn-cancel-category');
                const input = document.getElementById('new-category-name');
                const errorP = document.getElementById('category-error');

                // 3. Adicionar listener de Salvar
                // Usamos .onclick aqui para garantir que estamos sempre 
                // substituindo qualquer listener antigo (mais simples que cloneNode)
                saveBtn.onclick = async () => {
                    const categoryName = input.value.trim();
                    errorP.classList.add('hidden');

                    if (!categoryName) {
                        errorP.textContent = 'Por favor, digite um nome.';
                        errorP.classList.remove('hidden');
                        input.classList.add('border-red-500');
                        return;
                    }
                    if (!userId) {
                        showModal("Erro", "Usuário não logado.");
                        return;
                    }

                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Salvando';

                    try {
                        // Salva no Firestore
                        // Usamos o nome em minúsculo como ID para evitar duplicatas
                        const categoryId = categoryName.toLowerCase();
                        const collectionPath = `artifacts/${appId}/users/${userId}/categorias`;
                        const docRef = doc(db, collectionPath, categoryId);

                        await setDoc(docRef, {
                            nome: categoryName,
                            createdAt: serverTimestamp()
                        });

                        // O 'onSnapshot' (que criamos no passo 2) vai detectar
                        // essa mudança e atualizar a lista <select> automaticamente.

                        // Mas, para uma resposta imediata, podemos selecionar a opção
                        // (assumindo que o onSnapshot já a adicionou, o que é rápido)
                        document.getElementById('prod-categoria').value = categoryName;

                        hideModal();

                    } catch (error) {
                        console.error("Erro ao salvar categoria:", error);
                        showModal("Erro", "Não foi possível salvar a nova categoria.");
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Salvar';
                    }
                };

                // 4. Adicionar listener de Cancelar
                cancelBtn.onclick = () => {
                    hideModal();
                };

                // 5. Adicionar listener para fechar com 'Esc' (opcional, mas bom)
                input.onkeydown = (e) => {
                    if (e.key === 'Escape') hideModal();
                    if (e.key === 'Enter') saveBtn.click();
                };

                // Foca no input
                input.focus();
            });
        }
        // --- FIM DA LÓGICA DE CATEGORIA ---

        // --- LÓGICA DE GERENCIAR/EXCLUIR CATEGORIA ---
        const btnManageCategory = document.getElementById('btn-manage-category');

        if (btnManageCategory) {
            btnManageCategory.addEventListener('click', () => {
                // 1. Configurar o Título do Modal
                modalTitle.textContent = 'Gerenciar Categorias Criadas';

                // 2. Criar o Corpo do Modal
                const categoryList = document.createElement('ul');
                categoryList.className = 'space-y-2 max-h-60 overflow-y-auto';

                // 3. Buscar apenas as categorias customizadas (do Firebase)
                const select = document.getElementById('prod-categoria');
                const customOptions = select.querySelectorAll('option.custom-category');

                if (customOptions.length === 0) {
                    categoryList.innerHTML = '<p class="text-gray-500 text-sm">Você ainda não criou nenhuma categoria customizada.</p>';
                } else {
                    customOptions.forEach(option => {
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-md';
                        li.textContent = option.value;

                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'btn-delete-category text-red-500 hover:text-red-700';
                        deleteButton.dataset.name = option.value; // Guarda o nome para exclusão
                        deleteButton.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i>';

                        li.appendChild(deleteButton);
                        categoryList.appendChild(li);
                    });
                }

                // 4. Limpa e insere o conteúdo no modal
                modalBody.innerHTML = '';
                modalBody.appendChild(categoryList);

                // 5. Adiciona um botão de fechar
                const footer = document.createElement('div');
                footer.className = 'mt-6 text-right';
                footer.innerHTML = '<button type="button" id="btn-close-manage" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Fechar</button>';
                modalBody.appendChild(footer);

                // 6. Mostra o modal
                modalContainer.style.display = 'flex';
                lucide.createIcons(); // Recria os ícones de lixeira

                // 7. Adiciona os listeners de clique

                // Fechar
                document.getElementById('btn-close-manage').onclick = hideModal;

                // Excluir
                modalBody.querySelectorAll('.btn-delete-category').forEach(button => {
                    button.onclick = (e) => {
                        const categoryName = e.currentTarget.dataset.name;
                        // Usamos a função showModal para confirmação
                        showDeleteCategoryConfirmation(categoryName);
                    };
                });
            });
        }

        function showDeleteCategoryConfirmation(categoryName) {
            if (!userId) {
                showModal("Erro", "Usuário não logado.");
                return;
            }

            // 1. Pergunta ao usuário
            modalTitle.textContent = 'Confirmar Exclusão';
            modalBody.innerHTML = `
        <p>Você tem certeza que deseja excluir a categoria "<strong>${categoryName}</strong>"?</p>
        <p class="text-sm text-gray-600 mt-2">Isso não pode ser desfeito. Os produtos existentes que usam esta categoria não serão alterados.</p>
        <div class="mt-6 text-right space-x-2">
            <button type="button" id="btn-confirm-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancelar</button>
            <button type="button" id="btn-confirm-delete" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Sim, Excluir</button>
        </div>
    `;

            // 2. Mostra o modal de confirmação (que já estava aberto)
            modalContainer.style.display = 'flex';

            // 3. Listeners da confirmação
            document.getElementById('btn-confirm-cancel').onclick = () => {
                // Simplesmente fecha o modal de confirmação e volta
                hideModal();
            };

            document.getElementById('btn-confirm-delete').onclick = async () => {
                const deleteBtn = document.getElementById('btn-confirm-delete');
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Excluindo';

                try {
                    // Caminho do documento (ID é o nome em minúsculo)
                    const categoryId = categoryName.toLowerCase();
                    const collectionPath = `artifacts/${appId}/users/${userId}/categorias`;
                    const docRef = doc(db, collectionPath, categoryId);

                    // Exclui do Firebase
                    await deleteDoc(docRef);

                    // Fecha o modal
                    hideModal();

                    // O onSnapshot do 'loadCategories' vai
                    // atualizar a lista <select> automaticamente!

                } catch (error) {
                    console.error("Erro ao excluir categoria:", error);
                    showModal("Erro", "Não foi possível excluir a categoria.");
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'Sim, Excluir';
                }
            };
        }
        // --- FIM DA LÓGICA DE GERENCIAR ---

        // --- LÓGICA DE AÇÕES DA TABELA (EDITAR/EXCLUIR) ---
        const mainAppContainer = document.getElementById('page-main-app');

        if (mainAppContainer) {
            mainAppContainer.addEventListener('click', (e) => {

                // --- AÇÃO: Excluir Produto ---
                const deleteBtn = e.target.closest('.btn-delete-product');
                if (deleteBtn && deleteBtn.dataset.id) {
                    const productId = deleteBtn.dataset.id;
                    console.log("Solicitando exclusão do produto:", productId);
                    showProductDeleteConfirmation(productId);
                    return; // Encerra
                }

                // --- AÇÃO: Editar Produto ---
                const editBtn = e.target.closest('.btn-edit-product');
                if (editBtn && editBtn.dataset.id) {
                    const productId = editBtn.dataset.id;
                    console.log("Solicitando edição do produto:", productId);
                    showEditProductModal(productId);
                    return; // Encerra
                }

                // --- AÇÃO: Remover Item da Venda ---
                const removeSaleItemBtn = e.target.closest('.btn-remove-sale-item');
                if (removeSaleItemBtn && removeSaleItemBtn.dataset.index) {
                    const itemIndex = parseInt(removeSaleItemBtn.dataset.index, 10);

                    if (!isNaN(itemIndex) && itemIndex < currentSaleItems.length) {
                        // Remove o item do array "carrinho"
                        currentSaleItems.splice(itemIndex, 1);
                        // Redesenha a tabela
                        renderSaleItems();
                        // Recalcula os totais
                        updateSaleTotals();
                    }
                    return; // Encerra
                }

                // --- AÇÃO: Excluir Pessoa ---
                const deletePersonBtn = e.target.closest('.btn-delete-person');
                if (deletePersonBtn && deletePersonBtn.dataset.id) {
                    console.log("Solicitando exclusão da pessoa:", deletePersonBtn.dataset.id);
                    showPersonDeleteConfirmation(deletePersonBtn.dataset.id);
                    return; // Encerra
                }

                // --- AÇÃO: Editar Pessoa ---
                const editPersonBtn = e.target.closest('.btn-edit-person');
                if (editPersonBtn && editPersonBtn.dataset.id) {
                    console.log("Solicitando edição da pessoa:", editPersonBtn.dataset.id);
                    showEditPersonModal(editPersonBtn.dataset.id);
                    return; // Encerra
                }

              // --- AÇÃO: Realizar Acerto de Consignação ---
        const settleBtn = e.target.closest('.btn-settle-consignment');
        if (settleBtn && settleBtn.dataset.id) {
            const consignmentId = settleBtn.dataset.id;
            console.log("Solicitando acerto da consignação:", consignmentId);
            showConsignmentSettlementModal(consignmentId); // Chama a tela de acerto (devolução/comissão)
            return; // Encerra
        }
        
        // --- AÇÃO: Gerenciar/Editar Itens da Consignação ---
        const manageConsignBtn = e.target.closest('.btn-manage-consignment');
        if (manageConsignBtn && manageConsignBtn.dataset.id) {
            const consignmentId = manageConsignBtn.dataset.id;
            console.log("Solicitando edição de itens/data:", consignmentId);
            showConsignmentEditModal(consignmentId); // Chama a tela de edição de itens/data
            return; // Encerra
        }

        // --- AÇÃO: Excluir/Cancelar Consignação ---
        const deleteConsignBtn = e.target.closest('.btn-delete-consign');
        if (deleteConsignBtn && deleteConsignBtn.dataset.id) {
            const consignmentId = deleteConsignBtn.dataset.id;
            const clientId = deleteConsignBtn.dataset.clientId;
            console.log("Solicitando cancelamento da consignação:", consignmentId);
            showConsignmentCancelConfirmation(consignmentId, clientId); // Chama a tela de confirmação de cancelamento
            return; // Encerra
        }
                // --- AÇÃO: Excluir Venda (do Histórico) ---
                const deleteSaleBtn = e.target.closest('.btn-delete-sale');
                if (deleteSaleBtn && deleteSaleBtn.dataset.id) {
                    const saleId = deleteSaleBtn.dataset.id;
                    console.log("Solicitando exclusão da venda:", saleId);
                    showSaleDeleteConfirmation(saleId);
                    return; // Encerra
                }

                // --- AÇÃO: Ver Relatório da Venda ---
                const viewSaleReportBtn = e.target.closest('.btn-view-sale-report');
                if (viewSaleReportBtn && viewSaleReportBtn.dataset.id) {
                    const saleId = viewSaleReportBtn.dataset.id;
                    console.log("Solicitando relatório da venda:", saleId);
                    // Busca a venda na nossa cache global 'allSales'
                    const sale = allSales.find(s => s.id === saleId);
                    if (sale) {
                        generateSaleReportPDF(sale); // Chama a função que gera o PDF
                    } else {
                        showModal("Erro", "Venda não encontrada para gerar relatório.");
                    }
                    return; // Encerra
                }

                // --- AÇÃO: Marcar Conta como Paga ---
                const markPaidBtn = e.target.closest('.btn-mark-paid');
                if (markPaidBtn && markPaidBtn.dataset.id) {
                    const billId = markPaidBtn.dataset.id;
                    console.log("Solicitando marcar conta como paga:", billId);
                    handleMarkBillAsPaid(billId); // Chama a função principal de pagar
                    return; // Encerra
                }

                // --- AÇÃO: Excluir Conta a Pagar ---
                const deleteBillBtn = e.target.closest('.btn-delete-bill');
                if (deleteBillBtn && deleteBillBtn.dataset.id) {
                    const billId = deleteBillBtn.dataset.id;
                    console.log("Solicitando exclusão da conta:", billId);
                    showBillDeleteConfirmation(billId); // Chama a função de confirmação
                    return; // Encerra
                }
                // --- AÇÃO: Estornar Conta Paga ---
        const unmarkPaidBtn = e.target.closest('.btn-unmark-paid');
        if (unmarkPaidBtn && unmarkPaidBtn.dataset.id) {
            const billId = unmarkPaidBtn.dataset.id;
            console.log("Solicitando estorno da conta:", billId);
            handleUnmarkBillAsPaid(billId); // Chama a função de estorno
            return; // Encerra
        }
            });
        }
        // --- FIM DA LÓGICA DE AÇÕES ---
        // --- LÓGICA DE AÇÕES EM LOTE (PRODUTOS) ---

        const btnBatchDelete = document.getElementById('btn-batch-delete');
        const btnBatchEdit = document.getElementById('btn-batch-edit');
        const selectAllCheckbox = document.getElementById('select-all-products');

        /**
         * Helper: Pega os IDs de todos os produtos selecionados
         */
        function getSelectedProductIds() {
            const selectedCheckboxes = document.querySelectorAll('#product-list-table input.product-checkbox:checked');
            const ids = [];
            selectedCheckboxes.forEach(cb => {
                if (cb.dataset.id) {
                    ids.push(cb.dataset.id);
                }
            });
            return ids;
        }

        // --- Lógica do "Selecionar Todos" ---
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('click', () => {
                const allCheckboxes = document.querySelectorAll('#product-list-table input.product-checkbox');
                allCheckboxes.forEach(cb => {
                    cb.checked = selectAllCheckbox.checked;
                });
            });
        }

        // --- Lógica do "Excluir em Lote" ---
        if (btnBatchDelete) {
            btnBatchDelete.addEventListener('click', () => {
                const idsToDelete = getSelectedProductIds();

                if (idsToDelete.length === 0) {
                    showModal("Atenção", "Selecione pelo menos um produto para excluir.");
                    return;
                }

                showBatchDeleteConfirmation(idsToDelete);
            });
        }

        /**
         * Mostra o modal de confirmação para EXCLUIR em lote.
         */
        function showBatchDeleteConfirmation(ids) {
            if (!userId) {
                showModal("Erro", "Usuário não logado.");
                return;
            }

            modalTitle.textContent = 'Confirmar Exclusão em Lote';
            modalBody.innerHTML = `
        <p>Você tem certeza que deseja excluir <strong>${ids.length}</strong> produto(s) selecionado(s)?</p>
        <p class="text-sm text-gray-600 mt-2">Esta ação não pode ser desfeita.</p>
        <div class="mt-6 text-right space-x-2">
            <button type="button" id="btn-confirm-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancelar</button>
            <button type="button" id="btn-confirm-delete" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Sim, Excluir</button>
        </div>
    `;

            modalContainer.style.display = 'flex';

            document.getElementById('btn-confirm-cancel').onclick = hideModal;

            document.getElementById('btn-confirm-delete').onclick = async () => {
                const deleteBtn = document.getElementById('btn-confirm-delete');
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Excluindo';

                try {
                    // Usar WriteBatch para excluir todos de uma vez
                    const batch = writeBatch(db);
                    const collectionPath = `artifacts/${appId}/users/${userId}/produtos`;

                    ids.forEach(id => {
                        const docRef = doc(db, collectionPath, id);
                        batch.delete(docRef);
                    });

                    await batch.commit(); // Envia o lote

                    hideModal();
                    selectAllCheckbox.checked = false; // Desmarca o "Selecionar Todos"
                    // O onSnapshot vai atualizar a UI!

                } catch (error) {
                    console.error("Erro ao excluir em lote:", error);
                    showModal("Erro", "Não foi possível excluir os produtos.");
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'Sim, Excluir';
                }
            };
        }


        // --- Lógica do "Editar em Lote" ---
        if (btnBatchEdit) {
            btnBatchEdit.addEventListener('click', () => {
                const idsToEdit = getSelectedProductIds();

                if (idsToEdit.length === 0) {
                    showModal("Atenção", "Selecione pelo menos um produto para editar.");
                    return;
                }

                showBatchEditModal(idsToEdit);
            });
        }

        /**
         * Mostra o modal de EDIÇÃO em lote.
         */
        function showBatchEditModal(ids) {
            if (!userId) {
                showModal("Erro", "Usuário não logado.");
                return;
            }

            // Pegar a lista de categorias do <select> principal para replicar no modal
            const categorySelectHTML = document.getElementById('prod-categoria').innerHTML;

            modalTitle.textContent = `Editar ${ids.length} Produto(s)`;
            modalBody.innerHTML = `
        <form id="form-batch-edit">
            <p class="text-sm text-gray-600 mb-4">Marque os campos que você deseja atualizar para todos os produtos selecionados. Campos desmarcados não serão alterados.</p>
            
            <div class="space-y-4">
                <!-- Atualizar Categoria -->
                <div class="p-4 border rounded-lg">
                    <div class="flex items-center">
                        <input type="checkbox" id="batch-edit-cat-toggle" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="batch-edit-cat-toggle" class="ml-2 block text-sm font-medium">Atualizar Categoria</label>
                    </div>
                    <div id="batch-edit-cat-group" class="mt-2 hidden">
                        <label class="block text-sm font-medium">Nova Categoria</label>
                        <select id="batch-edit-categoria" class="w-full px-3 py-2 mt-1 border rounded-md">
                            ${categorySelectHTML}
                        </select>
                    </div>
                </div>
                
                <!-- Atualizar Margem -->
                <div class="p-4 border rounded-lg">
                    <div class="flex items-center">
                        <input type="checkbox" id="batch-edit-margin-toggle" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="batch-edit-margin-toggle" class="ml-2 block text-sm font-medium">Atualizar Margem de Lucro</Elabel>
                    </div>
                    <div id="batch-edit-margin-group" class="mt-2 hidden">
                        <label class="block text-sm font-medium">Nova Margem (%)</Elabel>
                        <input type="number" id="batch-edit-margem" class="w-full px-3 py-2 mt-1 border rounded-md" placeholder="Ex: 100">
                        <p class="text-xs text-gray-500 mt-1">O preço de venda será recalculado (requer leitura de dados).</p>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-right space-x-2">
                <button type="button" id="btn-cancel-batch-edit" class="px-6 py-2 font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
                <button type="submit" id="btn-save-batch-edit" class="px-6 py-2 font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">Atualizar Produtos</button>
            </div>
        </form>
    `;

            modalContainer.style.display = 'flex';

            // Lógica interna do modal (mostrar/esconder campos)
            const catToggle = document.getElementById('batch-edit-cat-toggle');
            const catGroup = document.getElementById('batch-edit-cat-group');
            catToggle.addEventListener('change', () => catGroup.classList.toggle('hidden', !catToggle.checked));

            const marginToggle = document.getElementById('batch-edit-margin-toggle');
            const marginGroup = document.getElementById('batch-edit-margin-group');
            marginToggle.addEventListener('change', () => marginGroup.classList.toggle('hidden', !marginToggle.checked));

            // Lógica dos botões
            document.getElementById('btn-cancel-batch-edit').onclick = hideModal;

            document.getElementById('form-batch-edit').onsubmit = async (e) => {
                e.preventDefault();

                const updateCat = catToggle.checked;
                const updateMargin = marginToggle.checked;

                if (!updateCat && !updateMargin) {
                    showModal("Atenção", "Marque pelo menos um campo (Categoria ou Margem) para atualizar.");
                    return;
                }

                const saveBtn = document.getElementById('btn-save-batch-edit');
                saveBtn.disabled = true;
                saveBtn.innerHTML = `<i class="animate-spin inline-block w-4 h-4 border-[2px] border-current border-t-transparent rounded-full mr-2" role="status"></i>Atualizando`;

                const collectionPath = `artifacts/${appId}/users/${userId}/produtos`;
                const batch = writeBatch(db);

                try {
                    const updatedData = {};

                    // --- Preparar dados da Categoria (Simples) ---
                    if (updateCat) {
                        updatedData.categoria = document.getElementById('batch-edit-categoria').value;
                    }

                    // --- Preparar dados da Margem (Complexo: requer leitura) ---
                    if (updateMargin) {
                        const newMargem = parseFloat(document.getElementById('batch-edit-margem').value);
                        if (isNaN(newMargem)) {
                            throw new Error("Valor da margem é inválido.");
                        }

                        // Precisamos ler cada produto para saber o CUSTO antes de atualizar
                        // a margem e o preço de venda.
                        for (const id of ids) {
                            const docRef = doc(db, collectionPath, id);
                            const docSnap = await getDoc(docRef); // Causa 1 leitura por item!

                            if (docSnap.exists()) {
                                const product = docSnap.data();
                                const custo = product.custo || 0;
                                const newVenda = custo * (1 + (newMargem / 100));

                                // Adiciona ao lote (batch)
                                batch.update(docRef, {
                                    ...updatedData, // Adiciona a categoria (se marcada)
                                    margem: newMargem,
                                    venda: newVenda
                                });
                            }
                        }
                    } else if (updateCat) {
                        // Se só atualizou a categoria (sem margem), faz um update simples
                        for (const id of ids) {
                            const docRef = doc(db, collectionPath, id);
                            batch.update(docRef, updatedData); // updatedData só contém a categoria
                        }
                    }

                    // Envia o lote
                    await batch.commit();

                    hideModal();
                    selectAllCheckbox.checked = false; // Desmarca o "Selecionar Todos"
                    // O onSnapshot vai atualizar a UI!

                } catch (error) {
                    console.error("Erro ao editar em lote:", error);
                    showModal("Erro", "Não foi possível atualizar os produtos: " + error.message);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = 'Atualizar Produtos';
                }
            };
        }
        // --- FIM DAS AÇÕES EM LOTE ---
        // --- LÓGICA DE EXCLUIR PESSOA ---
        function showPersonDeleteConfirmation(personId) {
            if (!userId) {
                showModal("Erro", "Usuário não logado.");
                return;
            }

            // 1. Pergunta ao usuário
            modalTitle.textContent = 'Confirmar Exclusão';
            modalBody.innerHTML = `
        <p>Você tem certeza que deseja excluir esta pessoa?</p>
        <p class="text-sm text-gray-600 mt-2">Esta ação não pode ser desfeita.</p>
        <div class="mt-6 text-right space-x-2">
            <button type="button" id="btn-confirm-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancelar</button>
            <button type="button" id="btn-confirm-delete" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Sim, Excluir</button>
        </div>
    `;

            // 2. Mostra o modal
            modalContainer.style.display = 'flex';

            // 3. Listeners da confirmação
            document.getElementById('btn-confirm-cancel').onclick = hideModal;

            document.getElementById('btn-confirm-delete').onclick = async () => {
                const deleteBtn = document.getElementById('btn-confirm-delete');
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Excluindo';

                try {
                    // Caminho do documento
                    const collectionPath = `artifacts/${appId}/users/${userId}/pessoas`;
                    const docRef = doc(db, collectionPath, personId);

                    // Exclui do Firebase
                    await deleteDoc(docRef);

                    hideModal();
                    // O 'onSnapshot' (loadPeople) vai
                    // atualizar a lista automaticamente!

                } catch (error) {
                    console.error("Erro ao excluir pessoa:", error);
                    showModal("Erro", "Não foi possível excluir a pessoa.");
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'Sim, Excluir';
                }
            };
        }
        // --- FIM EXCLUIR PESSOA ---
        // --- LÓGICA DE EDITAR PESSOA ---
        async function showEditPersonModal(personId) {
            if (!userId) {
                showModal("Erro", "Usuário não logado.");
                return;
            }

            // 1. Buscar os dados da pessoa
            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/pessoas`;
                const docRef = doc(db, collectionPath, personId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    showModal("Erro", "Pessoa não encontrada. Pode ter sido excluída.");
                    return;
                }

                const person = docSnap.data();

                // 3. Montar o HTML do formulário de edição (baseado no form-add-person)
                modalTitle.textContent = 'Editar Pessoa';
                modalBody.innerHTML = `
            <form id="form-edit-person">
                <h3 class="text-lg font-medium">Dados da Pessoa</h3>
                <div class="grid grid-cols-1 gap-6 mt-4 md:grid-cols-3">
                    <!-- Campos Obrigatórios -->
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium">Tipo de Cadastro</label>
                        <select id="edit-person-type" required class="w-full px-3 py-2 mt-1 border rounded-md md:w-1/3">
                            <option value="cliente">Cliente Direto</option>
                            <option value="revendedor">Revendedor</option>
                            <option value="fornecedor">Fornecedor</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Nome Completo</label>
                        <input type="text" id="edit-person-name" required class="w-full px-3 py-2 mt-1 border rounded-md" value="${person.nome || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Email</label>
                        <input type="email" id="edit-person-email" required class="w-full px-3 py-2 mt-1 border rounded-md" value="${person.email || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Telefone</label>
                        <input type="tel" id="edit-person-phone" required class="w-full px-3 py-2 mt-1 border rounded-md" value="${person.telefone || ''}">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium">Endereço</label>
                        <input type="text" id="edit-person-address" required class="w-full px-3 py-2 mt-1 border rounded-md" value="${person.endereco || ''}">
                    </div>
                    
                    <!-- Campos Opcionais -->
                    <hr class="md:col-span-3">
                    <h3 class="text-lg font-medium md:col-span-3">Dados Adicionais (Opcional)</h3>
                    <div>
                        <label class="block text-sm font-medium">CPF</label>
                        <input type="text" id="edit-person-cpf" class="w-full px-3 py-2 mt-1 border rounded-md" value="${person.cpf || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">RG</label>
                        <input type="text" id="edit-person-rg" class="w-full px-3 py-2 mt-1 border rounded-md" value="${person.rg || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Instagram</label>
                        <input type="text" id="edit-person-insta" class="w-full px-3 py-2 mt-1 border rounded-md" value="${person.instagram || ''}">
                    </div>
                </div>
                <div class="mt-6 text-right space-x-2">
                    <button type="button" id="btn-cancel-edit-person" class="px-6 py-2 font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
                    <button type="submit" id="btn-save-edit-person" class="px-6 py-2 font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">Atualizar Pessoa</button>
                </div>
            </form>
        `;

                // 4. Mostrar o Modal
                modalContainer.style.display = 'flex';

                // 5. Seta o valor correto do <select>
                document.getElementById('edit-person-type').value = person.tipo;

                // 6. Adicionar listeners aos botões do Modal
                document.getElementById('btn-cancel-edit-person').onclick = hideModal;

                document.getElementById('form-edit-person').onsubmit = async (e) => {
                    e.preventDefault();

                    const saveBtn = document.getElementById('btn-save-edit-person');
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = `<i class="animate-spin inline-block w-4 h-4 border-[2px] border-current border-t-transparent rounded-full mr-2" role="status"></i>Atualizando`;

                    try {
                        // Monta o objeto atualizado
                        const updatedPerson = {
                            nome: document.getElementById('edit-person-name').value,
                            email: document.getElementById('edit-person-email').value,
                            telefone: document.getElementById('edit-person-phone').value,
                            endereco: document.getElementById('edit-person-address').value,
                            tipo: document.getElementById('edit-person-type').value,
                            cpf: document.getElementById('edit-person-cpf').value || null,
                            rg: document.getElementById('edit-person-rg').value || null,
                            instagram: document.getElementById('edit-person-insta').value || null,
                            // Não atualizamos o createdAt
                        };

                        // Validação
                        if (!updatedPerson.nome || !updatedPerson.email || !updatedPerson.telefone || !updatedPerson.endereco) {
                            throw new Error("Campos obrigatórios (Nome, Email, Tel, Endereço) não podem estar vazios.");
                        }

                        // Envia a atualização (usando o docRef original)
                        await updateDoc(docRef, updatedPerson);

                        hideModal();
                        // O onSnapshot (loadPeople) vai atualizar a UI automaticamente!

                    } catch (error) {
                        console.error("Erro ao atualizar pessoa:", error);
                        showModal("Erro", "Falha ao atualizar: " + error.message);
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = 'Atualizar Pessoa';
                    }
                };

            } catch (error) {
                console.error("Erro ao buscar pessoa para edição: ", error);
                showModal("Erro", "Não foi possível carregar os dados desta pessoa.");
            }
        }
        // --- FIM EDITAR PESSOA ---
        // --- LÓGICA DE EXCLUIR VENDA ---
        function showSaleDeleteConfirmation(saleId) {
            if (!userId) {
                showModal("Erro", "Usuário não logado.");
                return;
            }

            // 1. Busca a venda na cache para mostrar detalhes
            const sale = allSales.find(s => s.id === saleId);
            if (!sale) {
                showModal("Erro", "Venda não encontrada na lista atual.");
                return;
            }

            // 2. Pergunta ao usuário
            modalTitle.textContent = 'Confirmar Exclusão da Venda';
            modalBody.innerHTML = `
        <p>Você tem certeza que deseja excluir esta venda (${sale.type}) para "${sale.clientId || 'Consumidor Final'}"?</p>
        <p class="font-medium text-red-600 mt-2">Esta ação irá:</p>
        <ul class="list-disc list-inside text-sm text-red-600">
            <li>Excluir o registro da venda.</li>
            <li>Devolver os itens vendidos ao estoque.</li>
            <li>Excluir o lançamento financeiro associado (se houver).</li>
        </ul>
        <p class="text-sm text-gray-600 mt-2">Esta ação não pode ser desfeita.</p>
        <div class="mt-6 text-right space-x-2">
            <button type="button" id="btn-confirm-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancelar</button>
            <button type="button" id="btn-confirm-delete" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Sim, Excluir Venda</button>
        </div>
    `;

            // 3. Mostra o modal
            modalContainer.style.display = 'flex';

            // 4. Listeners da confirmação
            document.getElementById('btn-confirm-cancel').onclick = hideModal;

            document.getElementById('btn-confirm-delete').onclick = async () => {
                const deleteBtn = document.getElementById('btn-confirm-delete');
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Excluindo';

                try {
                    await handleDeleteSale(sale); // Chama a função principal de exclusão
                    hideModal();
                    // O 'onSnapshot' (loadSalesHistory, loadFinancialHistory, loadProducts)
                    // vai atualizar tudo automaticamente!

                } catch (error) {
                    console.error("Erro ao excluir venda:", error);
                    showModal("Erro", "Não foi possível excluir a venda: " + error.message);
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'Sim, Excluir Venda';
                }
            };
        }
        // --- FIM EXCLUIR VENDA (Confirmação) ---
        // --- LÓGICA DE EXCLUIR VENDA (Ação Principal) ---
async function handleDeleteSale(sale) {
    if (!userId || !sale || !sale.id) {
        throw new Error("Dados inválidos para exclusão da venda.");
    }

    const batch = writeBatch(db);
    const productCollectionPath = `artifacts/${appId}/users/${userId}/produtos`;
    const saleCollectionPath = `artifacts/${appId}/users/${userId}/vendas`;
    const financeCollectionPath = `artifacts/${appId}/users/${userId}/lancamentos`;

    // --- 1. VERIFICAR QUAIS PRODUTOS AINDA EXISTEM ANTES DE ATUALIZAR ---
    const productRefsToUpdate = [];
    if (sale.items && sale.items.length > 0) {
        // Loop de Verificação (Leitura)
        for (const item of sale.items) {
            // Verificamos se o item.id é válido
            if (item.id) {
                const productRef = doc(db, productCollectionPath, item.id);
                try {
                    const productSnap = await getDoc(productRef);
                    if (productSnap.exists()) {
                        // Se o produto existe, adicionamos a ref à lista
                        productRefsToUpdate.push(productRef);
                    } else {
                        // O produto foi deletado, apenas loga e ignora
                        console.warn(`Produto ${item.id} da venda ${sale.id} não existe mais. Estoque não será devolvido.`);
                    }
                } catch (readError) {
                    console.error(`Erro ao verificar produto ${item.id}:`, readError);
                    // Não para o processo, apenas não devolve o estoque deste item
                }
            } else {
                console.warn("Item da venda sem ID:", item);
            }
        }
    }
    
    // --- 2. Devolver itens ao estoque (APENAS OS QUE EXISTEM) ---
    // Loop de Escrita (dentro do Batch)
    productRefsToUpdate.forEach(productRef => {
        batch.update(productRef, { 
            estoque: increment(1) 
        });
    });

    // --- 3. Excluir o lançamento financeiro associado (se houver) ---
    const financeQuery = query(
        collection(db, financeCollectionPath),
        where("saleId", "==", sale.id),
        where("ownerId", "==", userId)
    );
    
    const financeSnapshot = await getDocs(financeQuery); // Leitura
    if (!financeSnapshot.empty) {
        financeSnapshot.forEach(financeDoc => {
            console.log("Excluindo lançamento financeiro associado:", financeDoc.id);
            batch.delete(financeDoc.ref); // Escrita
        });
    } else {
        console.log("Nenhum lançamento financeiro encontrado para a venda:", sale.id);
    }

    // --- 4. Excluir o documento da venda ---
    const saleRef = doc(db, saleCollectionPath, sale.id);
    batch.delete(saleRef); // Escrita

    // --- 5. Executar o Lote ---
    await batch.commit();
    console.log("Venda e operações associadas excluídas com sucesso:", sale.id);
}
// --- FIM EXCLUIR VENDA (Ação Principal) ---
        // --- LÓGICA DE MARCAR CONTA COMO PAGA ---
        async function handleMarkBillAsPaid(billId) {
            if (!userId || !billId) {
                showModal("Erro", "ID da conta inválido para marcar como paga.");
                return;
            }

            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/lancamentos`;
                const billRef = doc(db, collectionPath, billId);

                await updateDoc(billRef, {
                    pago: true,
                    data: serverTimestamp() // Atualiza a data para o momento do pagamento
                });

                showModal("Sucesso!", "Conta marcada como paga e data de pagamento atualizada.");
                // O onSnapshot (loadFinancialHistory) vai atualizar as tabelas automaticamente!

            } catch (error) {
                console.error("Erro ao marcar conta como paga:", error);
                showModal("Erro", "Não foi possível marcar a conta como paga: " + error.message);
            }
        }
        // --- FIM MARCAR CONTA COMO PAGA ---
/**
 * Estorna uma conta (marca como NÃO paga)
 */
async function handleUnmarkBillAsPaid(billId) {
    if (!userId || !billId) {
        showModal("Erro", "ID da conta inválido para estornar.");
        return;
    }

    try {
        const collectionPath = `artifacts/${appId}/users/${userId}/lancamentos`;
        const billRef = doc(db, collectionPath, billId);
        
        // Simplesmente define 'pago' como false
        // O 'vencimento' original ainda está lá, então ela voltará para a lista A Pagar
        await updateDoc(billRef, { 
            pago: false
        });

        showModal("Sucesso!", "Conta estornada e movida de volta para 'A Pagar'.");
        // O onSnapshot (loadFinancialHistory) vai atualizar as tabelas automaticamente!

    } catch (error) {
        console.error("Erro ao estornar conta:", error);
        showModal("Erro", "Não foi possível estornar a conta: " + error.message);
    }
}
// --- FIM ESTORNAR CONTA ---

        // --- LÓGICA DE EXCLUIR CONTA (Confirmação) ---
        function showBillDeleteConfirmation(billId) {
            if (!userId) {
                showModal("Erro", "Usuário não logado.");
                return;
            }

            // 1. Busca a conta na cache (allFinancialEntries)
            const bill = allFinancialEntries.find(entry => entry.id === billId);
            if (!bill) {
                showModal("Erro", "Conta não encontrada na lista atual.");
                return;
            }

            // 2. Pergunta ao usuário
            modalTitle.textContent = 'Confirmar Exclusão da Conta';
            modalBody.innerHTML = `
        <p>Você tem certeza que deseja excluir a conta:</p>
        <p class="mt-2 text-lg font-bold">"${bill.descricao}" - R$ ${bill.valor.toFixed(2).replace('.', ',')}</p>
        <p class="font-medium text-red-600 mt-2">Esta ação não pode ser desfeita.</p>
        <div class="mt-6 text-right space-x-2">
            <button type="button" id="btn-confirm-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancelar</button>
            <button type="button" id="btn-confirm-delete" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Sim, Excluir Conta</button>
        </div>
    `;

            // 3. Mostra o modal
            modalContainer.style.display = 'flex';

            // 4. Listeners da confirmação
            document.getElementById('btn-confirm-cancel').onclick = hideModal;

            document.getElementById('btn-confirm-delete').onclick = async () => {
                const deleteBtn = document.getElementById('btn-confirm-delete');
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Excluindo';

                try {
                    await handleDeleteBill(billId); // Chama a função principal de exclusão
                    hideModal();
                    // O 'onSnapshot' (loadFinancialHistory) vai atualizar tudo automaticamente!

                } catch (error) {
                    console.error("Erro ao excluir conta:", error);
                    showModal("Erro", "Não foi possível excluir a conta: " + error.message);
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'Sim, Excluir Conta';
                }
            };
        }
        // --- FIM EXCLUIR CONTA (Confirmação) ---

    // --- LÓGICA DE ATUALIZAÇÃO DO DASHBOARD (FINAL E CORRIGIDA) ---

function updateDashboard() {
    console.log("--- Iniciando Atualização do Dashboard ---");
    
    // Elementos do Dashboard
    const warningsCountEl = document.getElementById('dashboard-warnings-count');
    const warningsDetailsEl = document.getElementById('dashboard-warnings-details'); 
    const warningsListEl = document.getElementById('dashboard-warnings-list');
    const warningsPlaceholderEl = document.getElementById('dashboard-warnings-placeholder');
    const salesValueEl = document.getElementById('dashboard-sales-value');
    const salesCountEl = document.getElementById('dashboard-sales-count');
    const balanceValueEl = document.getElementById('dashboard-balance-value');
    const balanceDetailsEl = document.getElementById('dashboard-balance-details');
    const lowstockCountEl = document.getElementById('dashboard-lowstock-count');

    // Funções Helper
    const formatCurrency = (val) => `R$ ${val.toFixed(2).replace('.', ',')}`;
    
    // Datas de Comparação em UTC (Corrigindo o fuso horário)
    const todayUTC = new Date();
    todayUTC.setUTCHours(0, 0, 0, 0); 
    const threeDaysFromNowUTC = new Date(todayUTC);
    threeDaysFromNowUTC.setUTCDate(todayUTC.getUTCDate() + 3);

    console.log(`Data de Hoje (UTC para filtro): ${todayUTC.toISOString().split('T')[0]}`);
    console.log(`Data Limite Avisos (UTC + 3 dias): ${threeDaysFromNowUTC.toISOString().split('T')[0]}`);

    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();

    let warningItems = []; 
    let consignmentsDueCount = 0;
    let billsDueCount = 0;

    // --- 1. Calcular Avisos ---

    // a) Consignações vencendo
    console.log(`Verificando ${allSales.length} vendas/consignações...`);
    allSales.forEach(sale => {
        if (sale.type === 'consignacao' && sale.status === 'Ativa' && sale.dueDate) {
            // Cria a data de vencimento em UTC
            const dueDateUTC = new Date(sale.dueDate + 'T00:00:00Z'); // 'Z' garante que seja UTC
            
            // Compara (se a data de vencimento for HOJE ou antes de 3 dias)
            if (dueDateUTC <= threeDaysFromNowUTC) {
                console.log(`AVISO CONSIGNAÇÃO: ${sale.clientId} vence em ${sale.dueDate}`);
                consignmentsDueCount++;
                const diffTime = dueDateUTC.getTime() - todayUTC.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let daysText = diffDays === 0 ? 'vence hoje' : (diffDays === 1 ? 'vence amanhã' : `vence em ${diffDays} dias`);
                if (diffDays < 0) daysText = `venceu há ${Math.abs(diffDays)} dia(s)`;
                
                warningItems.push({
                    type: 'consign',
                    date: dueDateUTC,
                    text: `Acerto Consignação (${sale.clientId || 'N/D'}) ${daysText}.`,
                    class: 'text-red-700 bg-red-50',
                    targetPage: 'page-vendas', 
                    targetTab: 'tab-vendas-consign' 
                });
            }
        }
    });

    // b) Contas a Pagar vencendo
    console.log(`Verificando ${allFinancialEntries.length} lançamentos financeiros...`);
    allFinancialEntries.forEach(entry => {
        if (entry.tipo === 'Saída' && !entry.pago && entry.vencimento) {
            // Cria a data de vencimento em UTC
            const dueDateUTC = new Date(entry.vencimento + 'T00:00:00Z'); // 'Z' garante que seja UTC
            
            // Compara
            if (dueDateUTC <= threeDaysFromNowUTC) {
                console.log(`AVISO CONTA: ${entry.descricao} VENCE EM ${entry.vencimento}`);
                billsDueCount++;
                const diffTime = dueDateUTC.getTime() - todayUTC.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                let daysText = diffDays === 0 ? 'vence hoje' : (diffDays === 1 ? 'vence amanhã' : `vence em ${diffDays} dias`);
                if (diffDays < 0) daysText = `venceu há ${Math.abs(diffDays)} dia(s)`;

                warningItems.push({
                    type: 'bill',
                    date: dueDateUTC,
                    text: `Conta "${entry.descricao}" ${daysText}.`,
                    class: diffDays < 0 ? 'text-red-700 bg-red-50' : 'text-yellow-700 bg-yellow-50',
                    targetPage: 'page-financeiro', 
                    targetTab: 'tab-financeiro-bills'
                });
            } else {
                // LOG DE CONTA OK
                console.log(`Conta ${entry.descricao} está OK (vence depois de ${threeDaysFromNowUTC.toISOString().split('T')[0]})`);
            }
        }
    });
    
    // Atualiza Card de Avisos
    const totalWarnings = consignmentsDueCount + billsDueCount;
    if (warningsCountEl) warningsCountEl.textContent = totalWarnings;
    if (warningsDetailsEl) warningsDetailsEl.textContent = `${consignmentsDueCount} acerto(s), ${billsDueCount} conta(s)`;
    
    // Atualiza Lista de Avisos
    if (warningsListEl) {
        warningsListEl.innerHTML = ''; 
        if (totalWarnings === 0) {
            warningsListEl.innerHTML = '<li id="dashboard-warnings-placeholder" class="text-sm text-gray-500">Nenhum aviso importante no momento.</li>';
        } else {
            warningItems.sort((a, b) => a.date - b.date);
            warningItems.forEach(item => {
                const li = document.createElement('li');
                li.className = `flex items-center p-3 space-x-3 rounded-md cursor-pointer hover:bg-gray-200 ${item.class}`;
                li.dataset.targetPage = item.targetPage;
                li.dataset.targetTab = item.targetTab;
                
                li.innerHTML = `
                    <i data-lucide="${item.type === 'consign' ? 'calendar-clock' : 'file-text'}"></i>
                    <span>${item.text}</span>
                `;
                warningsListEl.appendChild(li);
            });
            lucide.createIcons(); 
        }
    }

    // --- 2. Calcular Vendas do Mês --- (Código igual)
    let monthlySalesValue = 0;
    let monthlySalesCount = 0;
    allSales.forEach(sale => {
        if (sale.createdAt && sale.createdAt.toDate) {
            const saleDate = sale.createdAt.toDate();
            if (saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear) {
                
                if (sale.type === 'direta' && sale.status === 'Finalizada') {
                    monthlySalesCount++;
                    monthlySalesValue += sale.total;
                } else if (sale.type === 'consignacao' && sale.status === 'Finalizada' && sale.settlement) {
                    monthlySalesCount++; 
                    monthlySalesValue += sale.settlement.totalSold; 
                }
            }
        }
    });
    if (salesValueEl) salesValueEl.textContent = formatCurrency(monthlySalesValue);
    if (salesCountEl) salesCountEl.textContent = `${monthlySalesCount} venda(s) realizada(s)`;

    // --- 3. Calcular Caixa do Mês --- 
    let monthlyRevenue = 0;
    let monthlyExpenses = 0;
    allFinancialEntries.forEach(entry => {
        if (entry.data && entry.data.toDate) {
            const entryDate = entry.data.toDate();
            if (entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear) {
                if (entry.tipo === 'Entrada') {
                    monthlyRevenue += entry.valor;
                } else if (entry.tipo === 'Saída' && entry.pago === true) { 
                    monthlyExpenses += entry.valor;
                }
            }
        }
    });
    const monthlyBalance = monthlyRevenue - monthlyExpenses;
    
    if (balanceValueEl) balanceValueEl.textContent = formatCurrency(monthlyBalance);
    if (balanceDetailsEl) balanceDetailsEl.textContent = `Ent: ${formatCurrency(monthlyRevenue)}, Saí: ${formatCurrency(monthlyExpenses)}`;
    
    // Ajusta cor do saldo
    balanceValueEl.classList.remove('text-green-600', 'text-red-600', 'text-blue-600');
    if (monthlyBalance > 0) {
        balanceValueEl.classList.add('text-green-600');
    } else if (monthlyBalance < 0) {
        balanceValueEl.classList.add('text-red-600');
    } else {
        balanceValueEl.classList.add('text-blue-600');
    }


    // --- 4. Calcular Estoque Zerado/Baixo --- (Código igual)
    let lowStockCount = 0;
    allUserProducts.forEach(prod => {
        if (prod.estoque <= 5) { 
            lowStockCount++;
        }
    });
    if (lowstockCountEl) lowstockCountEl.textContent = lowStockCount;

    console.log("--- Finalizando Atualização do Dashboard ---");
}
// --- FIM DA ATUALIZAÇÃO DO DASHBOARD ---
// --- LÓGICA DE NAVEGAÇÃO DO DASHBOARD ---
const dashboardPage = document.getElementById('page-dashboard');

if (dashboardPage) {
    dashboardPage.addEventListener('click', (e) => {
        let targetPage = null;
        let targetTab = null;

        // 1. Verifica clique nos CARDS
        const cardVendas = e.target.closest('#card-link-vendas');
        const cardFinanceiro = e.target.closest('#card-link-financeiro');
        const cardProdutos = e.target.closest('#card-link-produtos');
        const widgetProdutos = e.target.closest('#widget-link-produtos'); // Widget de estoque baixo

        // 2. Verifica clique nos AVISOS (<li>)
        const warningLi = e.target.closest('#dashboard-warnings-list li[data-target-page]');
        
        if (cardVendas) {
            targetPage = 'page-vendas';
            targetTab = 'tab-vendas-new'; // Vai para "Nova Venda"
        } else if (cardFinanceiro) {
            targetPage = 'page-financeiro';
            targetTab = 'tab-financeiro-summary'; // Vai para "Resumo do Caixa"
        } else if (cardProdutos || widgetProdutos) {
            targetPage = 'page-produtos';
            targetTab = 'tab-produtos-view'; // Vai para "Visualizar Produtos"
        } else if (warningLi) {
            targetPage = warningLi.dataset.targetPage;
            targetTab = warningLi.dataset.targetTab;
        }

        // 3. Executa a navegação
        if (targetPage) {
            e.preventDefault(); // Previne qualquer ação padrão
            
            // 1. Muda para a página principal
            showPage(targetPage);
            
            // 2. Clica na aba interna específica (se houver)
            if (targetTab) {
                // Usamos um setTimeout para garantir que a página mudou antes de clicar na aba
                setTimeout(() => {
                    // Busca o botão de aba DENTRO da página que está ativa
                    const tabButton = document.querySelector(`#${targetPage} button[data-tab="${targetTab}"]`);
                    if (tabButton) {
                        tabButton.click(); // Simula o clique na aba correta
                    } else {
                        console.warn(`Não foi possível encontrar a aba: ${targetTab}`);
                    }
                }, 50); // 50ms de delay é o suficiente
            }
        }
    });
}
// --- FIM DA LÓGICA DO DASHBOARD ---

        // --- LÓGICA DE EXCLUIR CONTA (Ação Principal) ---
        async function handleDeleteBill(billId) {
            if (!userId || !billId) {
                throw new Error("ID da conta inválido para exclusão.");
            }

            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/lancamentos`;
                const billRef = doc(db, collectionPath, billId);
                await deleteDoc(billRef);

                console.log("Conta excluída com sucesso:", billId);
            } catch (error) {
                console.error("Erro ao excluir conta:", error);
                throw error; // Re-lança para ser pego pelo catch da confirmação
            }
        }
        // --- FIM EXCLUIR CONTA (Ação Principal) ---

        // --- LÓGICA DE CANCELAMENTO DE CONSIGNAÇÃO ---
function showConsignmentCancelConfirmation(consignmentId, clientId) {
    // Busca o documento da consignação (deve estar na cache allSales)
    const consignment = allSales.find(s => s.id === consignmentId);
    if (!consignment) {
        showModal("Erro", "Consignação não encontrada para cancelamento.");
        return;
    }
    
    modalTitle.textContent = 'Confirmar Cancelamento de Consignação';
    modalBody.innerHTML = `
        <p>Você tem certeza que deseja CANCELAR a consignação com <strong>${clientId || 'N/D'}</strong>?</p>
        <p class="font-medium text-red-600 mt-2">Esta ação irá:</p>
        <ul class="list-disc list-inside text-sm text-red-600">
            <li>Excluir o registro da consignação.</li>
            <li>Devolver TODOS os ${consignment.items ? consignment.items.length : 0} produtos consignados ao estoque.</li>
        </ul>
        <div class="mt-6 text-right space-x-2">
            <button type="button" id="btn-cancel-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Não, Manter Ativa</button>
            <button type="button" id="btn-confirm-cancel-consign" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Sim, Devolver Tudo e Cancelar</button>
        </div>
    `;

    modalContainer.style.display = 'flex';
    document.getElementById('btn-cancel-cancel').onclick = hideModal;

    document.getElementById('btn-confirm-cancel-consign').onclick = async () => {
        const confirmBtn = document.getElementById('btn-confirm-cancel-consign');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Cancelando...';

        try {
            const batch = writeBatch(db);
            const productCollectionPath = `artifacts/${appId}/users/${userId}/produtos`;
            const saleCollectionPath = `artifacts/${appId}/users/${userId}/vendas`;
            
            // 1. Devolver TODOS os itens originais ao estoque
            if (consignment.items && consignment.items.length > 0) {
                 for (const item of consignment.items) {
                    const productRef = doc(db, productCollectionPath, item.id);
                    batch.update(productRef, { estoque: increment(1) });
                }
            }
            
            // 2. Excluir o documento da consignação
            const saleRef = doc(db, saleCollectionPath, consignmentId);
            batch.delete(saleRef);

            await batch.commit();
            
            hideModal();
            showModal("Sucesso!", "Consignação cancelada e estoque devolvido com sucesso.");

        } catch (error) {
            console.error("Erro ao cancelar consignação:", error);
            showModal("Erro", "Não foi possível cancelar: " + error.message);
        }
    };
}
// --- FIM LÓGICA DE CANCELAMENTO ---


// --- LÓGICA DE EDIÇÃO COMPLETA DA CONSIGNAÇÃO ATIVA ---
async function showConsignmentEditModal(consignmentId) {
    if (!userId) {
        showModal("Erro", "Usuário não logado.");
        return;
    }

    // Busca a consignação na nossa cache allSales
    const originalConsignment = allSales.find(s => s.id === consignmentId);
    if (!originalConsignment) {
        showModal("Erro", "Consignação não encontrada.");
        return;
    }

    // Usamos o currentSaleItems como um "carrinho temporário" para edição
    // Fazemos uma cópia profunda dos itens originais
    let editConsignmentItems = JSON.parse(JSON.stringify(originalConsignment.items || [])); 

    // O CLIENT ID será o nome do cliente original.
    const clientName = originalConsignment.clientId; 

    // --- Funções Internas de Edição ---
    const updateEditTotals = () => {
        let subtotal = 0;
        editConsignmentItems.forEach(p => { subtotal += p.venda; });
        
        // Simplesmente mostra o subtotal, pois a consignação ativa não tem desconto
        document.getElementById('edit-consign-subtotal').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
        document.getElementById('edit-consign-total').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
    };

    const renderEditItems = () => {
        const tableBody = document.getElementById('edit-consign-items-list');
        tableBody.innerHTML = '';
        
        if (editConsignmentItems.length === 0) {
             tableBody.innerHTML = '<tr><td colspan="3" class="py-2 text-center text-gray-500">Nenhum item na consignação.</td></tr>';
        } else {
             editConsignmentItems.forEach((product, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.innerHTML = `
                    <td class="py-2 pr-2"><div class="font-medium">${product.nome}</div></td>
                    <td class="py-2 px-2">${product.ref}</td>
                    <td class="py-2 pl-2 text-right">
                        <button class="btn-remove-edit-item text-red-500 hover:text-red-700" data-index="${index}">
                            <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            lucide.createIcons();
        }
        updateEditTotals();
    };

    const handleEditAddItem = async (refCode) => {
        const addItemInput = document.getElementById('edit-item-ref');
        if (!refCode) return;
        
        try {
             const product = await findProductByRef(refCode); // Reutiliza a busca por ref
             if (!product) {
                showModal("Erro", `Produto com referência "${refCode}" não foi encontrado.`);
             } else {
                // Adiciona ao carrinho de edição
                editConsignmentItems.push(product);
                renderEditItems();
                addItemInput.value = '';
             }
        } catch (error) {
            console.error("Erro ao adicionar item:", error);
            showModal("Erro", "Falha ao adicionar produto.");
        }
        addItemInput.focus();
    };

    // --- Montar o Modal ---
    modalTitle.textContent = `Gerenciar Consignação de ${clientName}`;
    modalBody.innerHTML = `
        <form id="form-edit-consignment" class="grid grid-cols-1 gap-6 lg:grid-cols-2 max-h-[75vh] overflow-y-auto">
            
            <!-- Coluna 1: Edição e Itens -->
            <div class="space-y-4">
                <h4 class="text-lg font-medium">Itens e Data de Acerto</h4>

                <!-- Campo Adicionar Item -->
                <div class="flex mt-4 space-x-2">
                    <input type="text" id="edit-item-ref" placeholder="Adicionar Código de Ref. para consignar" class="flex-1 px-3 py-2 border rounded-md">
                    <button type="button" id="btn-add-edit-item" class="px-4 py-2 font-medium text-white bg-blue-500 rounded-md hover:bg-blue-600">Adicionar</button>
                </div>
                
                <!-- Lista de Itens -->
                <div class="mt-4 overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="py-2 text-left text-sm font-medium text-gray-500">Produto</th>
                                <th class="py-2 text-left text-sm font-medium text-gray-500">Ref.</th>
                                <th class="py-2 text-left text-sm font-medium text-gray-500">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="edit-consign-items-list" class="divide-y">
                            <!-- Populado por renderEditItems -->
                        </tbody>
                    </table>
                </div>

                <!-- Campo Data de Acerto -->
                <div>
                    <label class="block text-sm font-medium">Nova Data do Acerto</label>
                    <input type="date" id="edit-sale-due-date" class="w-full px-3 py-2 mt-1 border rounded-md" value="${originalConsignment.dueDate || ''}">
                </div>
            </div>
            
            <!-- Coluna 2: Resumo e Salvar -->
            <div class="p-6 space-y-4 bg-gray-50 rounded-lg">
                 <h4 class="text-lg font-medium">Resumo e Ações</h4>
                
                <div class="flex justify-between text-lg">
                    <span>Cliente:</span>
                    <span class="font-medium">${clientName}</span>
                </div>

                <div class="pt-4 border-t">
                    <div class="flex justify-between font-medium">
                        <span>Subtotal de Itens:</span>
                        <span id="edit-consign-subtotal">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between font-bold text-xl mt-2">
                        <span>VALOR TOTAL:</span>
                        <span id="edit-consign-total">R$ 0,00</span>
                    </div>
                </div>
                
                <p class="text-sm text-red-600 pt-4 border-t">Atenção: A atualização irá alterar o estoque.</p>

                <button type="submit" id="btn-update-consign" class="w-full px-4 py-3 font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">
                    Atualizar Consignação e Estoque
                </button>
            </div>
        </form>
    `;

    // 4. Mostrar e Ligar Eventos

    modalContainer.style.display = 'flex';
    renderEditItems(); // Primeira renderização

    // Ligar Adicionar Item
    const btnAddItem = document.getElementById('btn-add-edit-item');
    const itemRefInput = document.getElementById('edit-item-ref');
    btnAddItem.onclick = () => handleEditAddItem(itemRefInput.value.trim());
    itemRefInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); btnAddItem.click(); }
    });

    // Ligar Remoção de Item (Delegação de Eventos)
    document.getElementById('form-edit-consignment').addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.btn-remove-edit-item');
        if (removeBtn && removeBtn.dataset.index) {
            const index = parseInt(removeBtn.dataset.index, 10);
            
            // Remove 1 item do array e atualiza o estoque
            editConsignmentItems.splice(index, 1);
            renderEditItems(); // Redesenha
            lucide.createIcons();
            e.preventDefault();
        }
    });

    // Ligar o Save Final
    document.getElementById('form-edit-consignment').onsubmit = async (e) => {
        e.preventDefault();
        
        const saveBtn = document.getElementById('btn-update-consign');
        const originalBtnText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = `<i class="animate-spin inline-block w-4 h-4 border-[2px] border-current border-t-transparent rounded-full mr-2" role="status"></i>Atualizando...`;

        try {
            const newDueDate = document.getElementById('edit-sale-due-date').value;
            if (!newDueDate) throw new Error("A data de acerto é obrigatória.");
            
            // 1. Calcula o diferencial de estoque (o mais complexo)
            const originalRefs = new Set(originalConsignment.items.map(item => item.ref));
            const newRefs = new Set(editConsignmentItems.map(item => item.ref));

            const toReturnToStock = originalConsignment.items.filter(item => !newRefs.has(item.ref)); // Itens que foram REMOVIDOS da consignação
            const toRemoveFromStock = editConsignmentItems.filter(item => !originalRefs.has(item.ref)); // Itens que foram ADICIONADOS à consignação

            // 2. Preparar o Batch
            const batch = writeBatch(db);
            const productCollectionPath = `artifacts/${appId}/users/${userId}/produtos`;
            const saleRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, consignmentId);

            // Devolver para estoque: itens REMOVIDOS (os que o revendedor devolveu)
            toReturnToStock.forEach(item => {
                const productRef = doc(db, productCollectionPath, item.id);
                batch.update(productRef, { estoque: increment(1) });
            });
            
            // Remover de estoque: itens ADICIONADOS (os que o revendedor pegou a mais)
            toRemoveFromStock.forEach(item => {
                const productRef = doc(db, productCollectionPath, item.id);
                batch.update(productRef, { estoque: increment(-1) });
            });

            // 3. Atualizar o documento da Consignação
            const newSubtotal = editConsignmentItems.reduce((sum, item) => sum + item.venda, 0);

            batch.update(saleRef, {
                dueDate: newDueDate,
                items: editConsignmentItems,
                subtotal: newSubtotal,
                total: newSubtotal, // Consignação ativa não tem desconto, então total = subtotal
                // Manter status: 'Ativa'
            });

            // 4. Executar o Batch
            await batch.commit();

            hideModal();
            showModal("Sucesso!", "Consignação atualizada. Estoque ajustado.");

        } catch (error) {
            console.error("Erro ao atualizar consignação:", error);
            showModal("Erro", "Falha ao atualizar consignação: " + error.message);
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnText;
        }
    };
}
// --- FIM LÓGICA DE EDIÇÃO COMPLETA ---
        // --- FIM EXCLUIR VENDA (Ação Principal) ---
        // --- LÓGICA DE ACERTO DE CONSIGNAÇÃO ---
        async function showConsignmentSettlementModal(consignmentId) {
            if (!userId) {
                showModal("Erro", "Usuário não logado.");
                return;
            }

            // 1. Acha a consignação na nossa "cache" global
            const consignment = allSales.find(s => s.id === consignmentId);
            if (!consignment) {
                showModal("Erro", "Consignação não encontrada.");
                return;
            }

            // --- Variáveis de ESTADO do Modal ---
            // Fazemos cópias profundas para não alterar a venda original
            let itemsToSettle = JSON.parse(JSON.stringify(consignment.items)); // Itens que ainda não foram devolvidos
            let itemsReturned = []; // Itens que o usuário devolveu AGORA

            // 2. Montar o HTML do Modal
            modalTitle.textContent = 'Realizar Acerto de Consignação';
            modalBody.innerHTML = `
        <div class="grid grid-cols-2 gap-6">
            <!-- Coluna Esquerda: Devolução -->
            <div>
                <h4 class="text-lg font-medium">Devolução de Itens</h4>
                <p class="text-sm text-gray-500">Digite a Ref. dos itens devolvidos.</p>
                
                <div class="flex space-x-2 mt-4">
                    <input type="text" id="settle-ref-input" placeholder="Digitar Ref. ou usar leitor" class="w-full px-3 py-2 border rounded-md">
                    <button type="button" id="btn-return-item" class="px-4 py-2 text-white bg-blue-500 rounded-md hover:bg-blue-600">Devolver</button>
                </div>
                <p id="settle-error" class="text-xs text-red-600 mt-1 h-4"></p>
                
                <h5 class="font-medium mt-4 mb-2">Itens Consignados (Ainda com Revendedor):</h5>
                <ul id="settle-list-consigned" class="h-32 overflow-y-auto space-y-1 p-2 border rounded-md bg-gray-50">
                    <!-- JS vai popular -->
                </ul>
                
                <h5 class="font-medium mt-4 mb-2">Itens Devolvidos (Voltando ao Estoque):</h5>
                <ul id="settle-list-returned" class="h-32 overflow-y-auto space-y-1 p-2 border rounded-md bg-gray-50">
                    <!-- JS vai popular -->
                </ul>
            </div>
            
            <!-- Coluna Direita: Acerto -->
            <div>
                <h4 class="text-lg font-medium">Acerto Financeiro</h4>
                <p class="text-sm text-gray-500">Itens vendidos e cálculo de comissão.</p>
                
                <div id="settle-list-sold" class="mt-4 p-2 border rounded-md bg-gray-50 h-48 overflow-y-auto">
                    <!-- JS vai popular os itens vendidos -->
                </div>
                
                <div class="space-y-3 mt-4">
                    <div class="flex justify-between font-medium">
                        <span>Total Vendido:</span>
                        <span id="settle-total-sold">R$ 0,00</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <label for="settle-commission" class="text-sm font-medium">Comissão do Revendedor (%):</label>
                        <input type="number" id="settle-commission" value="0" class="w-24 px-3 py-2 text-sm border rounded-md">
                    </div>
                    <div class="flex justify-between font-bold text-lg text-green-600">
                        <span>VALOR A PAGAR:</span>
                        <span id="settle-final-amount">R$ 0,00</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Forma de Pagamento:</label>
                        <select id="settle-payment" class="w-full px-3 py-2 mt-1 border rounded-md">
                            <option>Dinheiro</option>
                            <option>Pix</option>
                            <option>Cartão de Crédito</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 pt-4 border-t text-right space-x-2">
           <button type="button" id="btn-cancel-settle" class="px-6 py-2 font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
            <button type="button" id="btn-finalize-settle" class="px-6 py-2 font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">Finalizar Acerto</button>
        </div>
    `;

            // 3. Mostrar o Modal
            modalContainer.style.display = 'flex';

            // --- 4. Funções Internas do Modal ---
            const listConsigned = document.getElementById('settle-list-consigned');
            const listReturned = document.getElementById('settle-list-returned');
            const listSold = document.getElementById('settle-list-sold');
            const totalSoldSpan = document.getElementById('settle-total-sold');
            const commissionInput = document.getElementById('settle-commission');
            const finalAmountSpan = document.getElementById('settle-final-amount');
            const refInput = document.getElementById('settle-ref-input');
            const errorP = document.getElementById('settle-error');

            // Função para desenhar as 3 listas e calcular totais
            function redrawListsAndCalculate() {
                // Limpa listas
                listConsigned.innerHTML = '';
                listReturned.innerHTML = '';
                listSold.innerHTML = '';

                let totalSold = 0;

                // Itens que sobraram (itemsToSettle) são os VENDIDOS
                if (itemsToSettle.length === 0) {
                    listSold.innerHTML = '<p class="text-sm text-gray-500 p-1">Nenhum item vendido.</p>';
                } else {
                    itemsToSettle.forEach(item => {
                        listSold.innerHTML += `<li class="flex justify-between text-sm p-1"><span>${item.nome}</span> <span>R$ ${item.venda.toFixed(2)}</span></li>`;
                        totalSold += item.venda;
                    });
                }

                // Itens em "itemsReturned"
                if (itemsReturned.length === 0) {
                    listReturned.innerHTML = '<p class="text-sm text-gray-500 p-1">Nenhum item devolvido.</p>';
                } else {
                    itemsReturned.forEach(item => {
                        listReturned.innerHTML += `<li class="text-sm p-1 text-gray-700">${item.nome} (${item.ref})</li>`;
                    });
                }

                // Itens que estavam no 'consignment' original (para referência)
                if (consignment.items.length === 0) {
                    listConsigned.innerHTML = '<p class="text-sm text-gray-500 p-1">Nenhum item nesta consignação.</p>';
                } else {
                    consignment.items.forEach(item => {
                        let status = itemsReturned.find(r => r.id === item.id)
                            ? '<span class="text-red-500">(Devolvido)</span>'
                            : '<span class="text-green-500">(Vendido)</span>';

                        // Correção: A lista "consignados" deve mostrar o que AINDA FALTA DEVOLVER
                        // Vamos refazer a lógica. A lista "consigned" mostra o que ainda está com o cliente.
                        // A lista "returned" mostra o que ele devolveu.
                        // A lista "sold" é calculada por último.
                    });
                }

                // --- LÓGICA REFEITA (Mais simples, como o usuário pediu) ---
                // A lista 'itemsToSettle' contém os itens que AINDA NÃO FORAM DEVOLVIDOS.
                // A lista 'itemsReturned' contém os itens que FORAM DEVOLVIDOS.

                listConsigned.innerHTML = '';
                listReturned.innerHTML = '';
                listSold.innerHTML = ''; // 'listSold' agora é 'itemsToSettle'

                totalSold = 0;

                if (itemsToSettle.length === 0) {
                    listSold.innerHTML = '<p class="text-sm text-gray-500 p-1">Nenhum item vendido (todos devolvidos).</p>';
                } else {
                    itemsToSettle.forEach(item => {
                        listSold.innerHTML += `<li class="flex justify-between text-sm p-1"><span>${item.nome} (${item.ref})</span> <span>R$ ${item.venda.toFixed(2)}</span></li>`;
                        totalSold += item.venda;
                    });
                }

                if (itemsReturned.length === 0) {
                    listReturned.innerHTML = '<p class="text-sm text-gray-500 p-1">Nenhum item devolvido ainda.</p>';
                } else {
                    itemsReturned.forEach(item => {
                        listReturned.innerHTML += `<li class="text-sm p-1 text-gray-700 line-through">${item.nome} (${item.ref})</li>`;
                    });
                }

                // A lista de 'Consignados' NUNCA MUDA. Ela mostra o que foi pego.
                consignment.items.forEach(item => {
                    listConsigned.innerHTML += `<li class="text-sm p-1 text-gray-700">${item.nome} (${item.ref})</li>`;
                });

                // Cálculo Financeiro
                const commissionPercent = parseFloat(commissionInput.value) || 0;
                const commissionAmount = totalSold * (commissionPercent / 100);
                const finalAmount = totalSold - commissionAmount;

                totalSoldSpan.textContent = `R$ ${totalSold.toFixed(2).replace('.', ',')}`;
                finalAmountSpan.textContent = `R$ ${finalAmount.toFixed(2).replace('.', ',')}`;
            }

            // "Ligar" botão de Devolver Item
            document.getElementById('btn-return-item').onclick = () => {
                const refCode = refInput.value.trim();
                errorP.textContent = '';
                if (!refCode) return;

                // Procura o item na lista 'itemsToSettle'
                const itemIndex = itemsToSettle.findIndex(item => item.ref === refCode);

                if (itemIndex > -1) {
                    // Achou!
                    // Remove 1 item de 'itemsToSettle' e o move para 'itemsReturned'
                    const [returnedItem] = itemsToSettle.splice(itemIndex, 1);
                    itemsReturned.push(returnedItem);

                    refInput.value = ''; // Limpa o input
                    redrawListsAndCalculate(); // Atualiza a UI
                } else {
                    // Não achou (ou já foi devolvido)
                    errorP.textContent = 'Ref. não encontrada ou já devolvida.';
                }
                refInput.focus();
            };
            refInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') document.getElementById('btn-return-item').click();
            });

            // "Ligar" input de comissão
            commissionInput.addEventListener('input', redrawListsAndCalculate);

            // "Ligar" botões de fechar
            document.getElementById('btn-cancel-settle').onclick = hideModal;

            // "Ligar" botão FINALIZAR
            document.getElementById('btn-finalize-settle').onclick = async () => {
                const finalSaveBtn = document.getElementById('btn-finalize-settle');
                finalSaveBtn.disabled = true;
                finalSaveBtn.innerHTML = `<i class="animate-spin inline-block w-4 h-4 border-[2px] border-current border-t-transparent rounded-full mr-2" role="status"></i>Finalizando`;

                try {
                    // --- 1. Calcular os dados finais ---
                    let totalSold = 0;
                    itemsToSettle.forEach(item => { totalSold += item.venda; });

                    const commissionPercent = parseFloat(commissionInput.value) || 0;
                    const commissionAmount = totalSold * (commissionPercent / 100);
                    const finalAmountPaid = totalSold - commissionAmount;
                    const paymentMethod = document.getElementById('settle-payment').value;

                    // --- 2. Preparar o Lote (Batch) ---
                    const batch = writeBatch(db);
                    const productCollectionPath = `artifacts/${appId}/users/${userId}/produtos`;

                    // --- 2a. Atualizar Estoque (Devolver itens) ---
                    for (const item of itemsReturned) {
                        const productRef = doc(db, productCollectionPath, item.id);
                        batch.update(productRef, {
                            estoque: increment(1) // Devolve 1 ao estoque
                        });
                    }

                    // --- 2b. Atualizar a Venda (Consignação) Original ---
                    const saleRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, consignmentId);
                    batch.update(saleRef, {
                        status: 'Finalizada',
                        items: itemsToSettle, // Salva APENAS os itens vendidos
                        paymentMethod: paymentMethod,
                        // Novos campos do acerto:
                        settlement: {
                            totalSold: totalSold,
                            commissionPercent: commissionPercent,
                            commissionAmount: commissionAmount,
                            finalAmountPaid: finalAmountPaid,
                            settledAt: serverTimestamp()
                        }
                    });

                    // --- 2c. Criar o Lançamento Financeiro ---
                    const financeCollectionPath = `artifacts/${appId}/users/${userId}/lancamentos`;
                    const financeData = {
                        descricao: `Acerto Consignação (Rev: ${consignment.clientId})`,
                        valor: finalAmountPaid,
                        tipo: 'Entrada',
                        data: serverTimestamp(),
                        vencimento: null,
                        pago: true,
                        saleId: consignmentId,
                        ownerId: userId
                    };
                    const newFinanceRef = doc(collection(db, financeCollectionPath));
                    batch.set(newFinanceRef, financeData);

                    // --- 3. Executar o Lote ---
                    await batch.commit();

                    // --- 4. Gerar o Relatório (CORRETO AQUI) ---
                    const settlementData = {
                        totalSold: totalSold,
                        commissionPercent: commissionPercent,
                        commissionAmount: commissionAmount,
                        finalAmountPaid: finalAmountPaid,
                        paymentMethod: paymentMethod
                    };

                    // >>>>> ESTA É A LINHA QUE FALTAVA <<<<<
                    await generateSettlementReport(consignment, itemsToSettle, itemsReturned, settlementData);

                    // --- 5. Sucesso ---
                    hideModal(); // Fecha o modal DEPOIS de gerar o PDF

                    // O onSnapshot (loadSalesHistory e loadFinancialHistory)
                    // vai atualizar as tabelas automaticamente!

                } catch (error) {
                    console.error("Erro ao finalizar acerto:", error);
                    showModal("Erro", "Não foi possível finalizar o acerto: " + error.message);
                    finalSaveBtn.disabled = false;
                    finalSaveBtn.innerHTML = 'Finalizar Acerto';
                }
            }; // Fim do onclick


            // 5. Chamar a função pela primeira vez para popular tudo
            redrawListsAndCalculate();
        }
        // --- FIM DA LÓGICA DE ACERTO ---
        /**
         * Gera um Relatório de Acerto em PDF
         */
        async function generateSettlementReport(consignment, itemsSold, itemsReturned, settlementData) {
            // Puxa as bibliotecas globais
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'mm', format: 'a4' });

            // Função helper para formatar dinheiro
            const formatCurrency = (val) => `R$ ${val.toFixed(2).replace('.', ',')}`;

            // --- 1. Título e Cabeçalho ---
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Relatório de Acerto de Consignação', 105, 20, { align: 'center' });

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Cliente (Revendedor): ${consignment.clientId}`, 15, 35);
            doc.text(`Data do Acerto: ${new Date().toLocaleDateString('pt-BR')}`, 15, 42);
            // Tenta pegar a data de retirada (se já foi convertida)
            const withdrawalDate = consignment.createdAt?.toDate ? consignment.createdAt.toDate().toLocaleDateString('pt-BR') : 'N/D';
            doc.text(`Data da Retirada: ${withdrawalDate}`, 15, 49);

            let currentY = 60; // Posição vertical inicial

            // --- 2. Tabela de Itens Vendidos ---
            if (itemsSold.length > 0) {
                const soldHead = [['Ref.', 'Produto Vendido', 'Valor Unit. (R$)']];
                const soldBody = itemsSold.map(item => [
                    item.ref,
                    item.nome,
                    item.venda.toFixed(2)
                ]);
                // Linha de Resumo
                soldBody.push([
                    { content: 'Total Vendido:', colSpan: 2, styles: { halign: 'right', fontStyle: 'bold' } },
                    { content: settlementData.totalSold.toFixed(2), styles: { fontStyle: 'bold' } }
                ]);

                doc.autoTable({
                    startY: currentY,
                    head: soldHead,
                    body: soldBody,
                    theme: 'striped',
                    headStyles: { fillColor: [22, 160, 133] } // Cor Verde
                });
                currentY = doc.lastAutoTable.finalY + 10; // Atualiza a posição
            }

            // --- 3. Tabela de Itens Devolvidos ---
            if (itemsReturned.length > 0) {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Itens Devolvidos (Retornando ao Estoque)', 15, currentY);
                currentY += 5;

                const returnedHead = [['Ref.', 'Produto Devolvido']];
                const returnedBody = itemsReturned.map(item => [
                    item.ref,
                    item.nome
                ]);

                doc.autoTable({
                    startY: currentY,
                    head: returnedHead,
                    body: returnedBody,
                    theme: 'grid',
                    headStyles: { fillColor: [192, 57, 43] } // Cor Vermelha
                });
                currentY = doc.lastAutoTable.finalY + 10;
            }

            // --- 4. Resumo Financeiro ---
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Resumo Financeiro', 15, currentY);
            currentY += 7;

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Vendido: ${formatCurrency(settlementData.totalSold)}`, 20, currentY);
            currentY += 7;
            doc.text(`Comissão (${settlementData.commissionPercent}%): - ${formatCurrency(settlementData.commissionAmount)}`, 20, currentY);
            currentY += 7;
            doc.text(`Forma de Pagamento: ${settlementData.paymentMethod}`, 20, currentY);
            currentY += 7;

            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`VALOR TOTAL A PAGAR: ${formatCurrency(settlementData.finalAmountPaid)}`, 20, currentY);

            // --- 5. Abrir o PDF ---
            doc.output('dataurlnewwindow');
        }
        // --- FIM DA GERAÇÃO DE RELATÓRIO ---
        /**
         * Gera um Relatório de Venda (Direta ou Consignação Finalizada) em PDF
         */
        async function generateSaleReportPDF(sale) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'mm', format: 'a4' });

            const formatCurrency = (val) => `R$ ${val !== undefined && val !== null ? val.toFixed(2).replace('.', ',') : '0,00'}`;

            // --- 1. Título e Cabeçalho ---
            const reportTitle = sale.type === 'direta' ? 'Relatório de Venda Direta' : 'Relatório de Consignação Finalizada';
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(reportTitle, 105, 20, { align: 'center' });

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Cliente: ${sale.clientId || 'Consumidor Final'}`, 15, 35);
            const saleDate = sale.createdAt?.toDate ? sale.createdAt.toDate().toLocaleDateString('pt-BR') : 'N/D';
            doc.text(`Data da Venda: ${saleDate}`, 15, 42);

            let currentY = 55;

            // --- 2. Tabela de Itens Vendidos ---
            if (sale.items && sale.items.length > 0) {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Itens Vendidos', 15, currentY);
                currentY += 7;

                const soldHead = [['Ref.', 'Produto', 'Valor Unit. (R$)']];
                const soldBody = sale.items.map(item => [
                    item.ref,
                    item.nome,
                    item.venda.toFixed(2)
                ]);

                doc.autoTable({
                    startY: currentY,
                    head: soldHead,
                    body: soldBody,
                    theme: 'striped',
                    headStyles: { fillColor: [41, 128, 185] } // Cor Azul
                });
                currentY = doc.lastAutoTable.finalY + 10;
            }

            // --- 3. Resumo Financeiro ---
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Resumo Financeiro', 15, currentY);
            currentY += 7;

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Subtotal: ${formatCurrency(sale.subtotal)}`, 20, currentY);
            currentY += 7;
            doc.text(`Desconto (${sale.discountPercent}%): - ${formatCurrency(sale.discountAmount)}`, 20, currentY);

            // Mostra detalhes da comissão se for consignação finalizada
            if (sale.type === 'consignacao' && sale.settlement) {
                currentY += 7;
                doc.text(`Comissão (${sale.settlement.commissionPercent}%): - ${formatCurrency(sale.settlement.commissionAmount)}`, 20, currentY);
            }

            currentY += 7;
            doc.text(`Forma de Pagamento: ${sale.paymentMethod || 'N/D'}`, 20, currentY);
            currentY += 9; // Mais espaço antes do total

            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            const finalTotal = (sale.type === 'consignacao' && sale.settlement) ? sale.settlement.finalAmountPaid : sale.total;
            doc.text(`VALOR TOTAL PAGO: ${formatCurrency(finalTotal)}`, 20, currentY);

            // --- 4. Abrir o PDF ---
            doc.output('dataurlnewwindow');
        }
        // --- FIM DA GERAÇÃO DE RELATÓRIO DE VENDA ---
        // --- LÓGICA DE GERAR ETIQUETAS (PDF) ---

        // Definições de layout das etiquetas PIMACO (em mm)
        // Convertido de cm (valor * 10)
        // Definições de layout das etiquetas PIMACO (em mm)
        // Baseado nas imagens fornecidas (valores em cm convertidos para mm)
        const LABEL_DEFINITIONS = {
            // --- Folha A4 (210 x 297 mm) ---
            "A4048": { pageFormat: 'a4', width: 33, height: 17, marginTop: 12.5, marginLeft: 7, cols: 6, rows: 16 },
            "A4049": { pageFormat: 'a4', width: 28, height: 15, marginTop: 13.5, marginLeft: 8, cols: 7, rows: 18 },
            "A4050": { pageFormat: 'a4', width: 101.6, height: 55.8, marginTop: 9, marginLeft: 4.7, cols: 2, rows: 5 },
            "A4051": { pageFormat: 'a4', width: 40.7, height: 21.2, marginTop: 10.7, marginLeft: 4.5, cols: 5, rows: 13 },
            "A4054": { pageFormat: 'a4', width: 101.6, height: 25.4, marginTop: 8.8, marginLeft: 4.7, cols: 2, rows: 11 },
            "A4055": { pageFormat: 'a4', width: 66.1, height: 31, marginTop: 9, marginLeft: 7.2, cols: 3, rows: 9 },
            "A4056": { pageFormat: 'a4', width: 66.1, height: 25.4, marginTop: 8.8, marginLeft: 7.2, cols: 3, rows: 11 },
            "A4060": { pageFormat: 'a4', width: 66.1, height: 38.1, marginTop: 15.2, marginLeft: 7.2, cols: 3, rows: 7 },
            "A4261": { pageFormat: 'a4', width: 66.1, height: 46.5, marginTop: 9.1, marginLeft: 7.2, cols: 3, rows: 6 },
            "A4062": { pageFormat: 'a4', width: 101.6, height: 33.9, marginTop: 12.9, marginLeft: 4.7, cols: 2, rows: 8 },
            "A4063": { pageFormat: 'a4', width: 101.6, height: 38.1, marginTop: 15.2, marginLeft: 4.7, cols: 2, rows: 7 },
            "A4264": { pageFormat: 'a4', width: 66.1, height: 71.9, marginTop: 4.7, marginLeft: 7.2, cols: 3, rows: 4 },
            "A4265": { pageFormat: 'a4', width: 101.6, height: 67.8, marginTop: 13, marginLeft: 4.7, cols: 2, rows: 4 },
            "A4067": { pageFormat: 'a4', width: 200, height: 288.5, marginTop: 4.3, marginLeft: 5, cols: 1, rows: 1 },
            "A4268": { pageFormat: 'a4', width: 199.9, height: 143.4, marginTop: 5.1, marginLeft: 5.1, cols: 1, rows: 2 },

            // --- Folha Carta (215.9 x 279.4 mm) ---
            "3080": { pageFormat: 'letter', width: 69.8, height: 25.4, marginTop: 12.7, marginLeft: 4.8, cols: 3, rows: 10 },
            "3081": { pageFormat: 'letter', width: 106.8, height: 25.4, marginTop: 12.7, marginLeft: 4, cols: 2, rows: 10 },
            "3082": { pageFormat: 'letter', width: 106.8, height: 33.9, marginTop: 21.2, marginLeft: 4, cols: 2, rows: 7 },
            "5580": { pageFormat: 'letter', width: 69.8, height: 25.4, marginTop: 12.7, marginLeft: 4.8, cols: 3, rows: 10 },
            "6080": { pageFormat: 'letter', width: 69.8, height: 25.4, marginTop: 12.7, marginLeft: 4.8, cols: 3, rows: 10 },
            "6081": { pageFormat: 'letter', width: 106.8, height: 25.4, marginTop: 12.7, marginLeft: 4, cols: 2, rows: 10 },
            "6082": { pageFormat: 'letter', width: 106.8, height: 33.9, marginTop: 21.2, marginLeft: 4, cols: 2, rows: 7 },
            "6083": { pageFormat: 'letter', width: 106.8, height: 50.8, marginTop: 12.7, marginLeft: 4, cols: 2, rows: 5 },
            "6084": { pageFormat: 'letter', width: 106.8, height: 84.7, marginTop: 12.7, marginLeft: 4, cols: 2, rows: 3 },
            "6085": { pageFormat: 'letter', width: 215.9, height: 279.4, marginTop: 0, marginLeft: 0, cols: 1, rows: 1 }, // Página inteira
            "6086": { pageFormat: 'letter', width: 212.7, height: 138.1, marginTop: 1.6, marginLeft: 1.6, cols: 1, rows: 2 }, // Largura 0 na tabela, assumido como página - margens
            "6087": { pageFormat: 'letter', width: 47.5, height: 12.7, marginTop: 12.7, marginLeft: 14.5, cols: 4, rows: 20 },
            "6088": { pageFormat: 'letter', width: 106.4, height: 138.1, marginTop: 1.6, marginLeft: 1.6, cols: 2, rows: 2 },
            "6089": { pageFormat: 'letter', width: 47.5, height: 16.9, marginTop: 12.7, marginLeft: 14.5, cols: 4, rows: 15 },
            "6092": { pageFormat: 'letter', width: 29.1, height: 17, marginTop: 16.9, marginLeft: 13, cols: 7, rows: 9 },
            "6093": { pageFormat: 'letter', width: 52, height: 27.4, marginTop: 15.1, marginLeft: 14.5, cols: 4, rows: 6 },
            "6094": { pageFormat: 'letter', width: 67.5, height: 48.5, marginTop: 16.7, marginLeft: 19, cols: 3, rows: 4 },
            "6095": { pageFormat: 'letter', width: 96.3, height: 59.3, marginTop: 21.2, marginLeft: 17, cols: 2, rows: 4 },
            "8096": { pageFormat: 'letter', width: 69.8, height: 30, marginTop: 12.7, marginLeft: 3.2, cols: 3, rows: 8 },
            "8098": { pageFormat: 'letter', width: 101.6, height: 42.3, marginTop: 12.7, marginLeft: 12.7, cols: 2, rows: 6 },
            "8099F": { pageFormat: 'letter', width: 83.8, height: 46.6, marginTop: 23.3, marginLeft: 27.2, cols: 2, rows: 5 },
            "8099L": { pageFormat: 'letter', width: 34.1, height: 16.9, marginTop: 12.7, marginLeft: 34.1, cols: 5, rows: 15 },

            // --- Genéricos (Mantidos) ---
            "gen-30x15": { pageFormat: 'a4', width: 30, height: 15, marginTop: 5, marginLeft: 5, cols: 6, rows: 18 },
            "gen-40x20": { pageFormat: 'a4', width: 40, height: 20, marginTop: 5, marginLeft: 5, cols: 5, rows: 14 },
            "gen-50x25": { pageFormat: 'a4', width: 50, height: 25, marginTop: 5, marginLeft: 5, cols: 4, rows: 11 },
            "gen-60x40": { pageFormat: 'a4', width: 60, height: 40, marginTop: 5, marginLeft: 5, cols: 3, rows: 7 }
        };
        // Adiciona margens direitas/inferiores (assumindo que são iguais)
        Object.keys(LABEL_DEFINITIONS).forEach(key => {
            const def = LABEL_DEFINITIONS[key];
            def.marginRight = def.marginLeft;
            def.marginBottom = def.marginTop;
        });

        const btnGenerateLabels = document.getElementById('btn-generate-labels');

        if (btnGenerateLabels) {
            btnGenerateLabels.addEventListener('click', async () => {
                // 1. Pegar IDs e Quantidades
                const selectedCheckboxes = document.querySelectorAll('#label-product-list input.label-product-checkbox:checked');
                const productsToPrint = []; // Array de objetos {id, qty}

                selectedCheckboxes.forEach(cb => {
                    const id = cb.dataset.id;
                    const qtyInput = labelProductListContainer.querySelector(`.label-product-qty[data-id="${id}"]`);
                    const qty = parseInt(qtyInput.value) || 1; // Pega o valor, ou 1 se for inválido

                    productsToPrint.push({ id, qty });
                });

                if (productsToPrint.length === 0) {
                    showModal("Atenção", "Selecione pelo menos um produto para gerar etiquetas.");
                    return;
                }

                // 2. Pegar formato da etiqueta (igual)
                const formatKey = document.getElementById('label-format').value;
                const definition = LABEL_DEFINITIONS[formatKey];

                if (!definition) {
                    showModal("Erro", "Formato de etiqueta não reconhecido ou ainda não implementado.");
                    return;
                }

                // 3. Mostrar "Carregando" (igual)
                showModal("Gerando PDF", "Buscando dados e preparando o arquivo. Por favor, aguarde.");

                try {
                    // 4. Buscar dados completos dos produtos (passando o novo array)
                    const productsWithData = await fetchProductsByIds(productsToPrint);

                    // 5. Gerar o PDF (passando o novo array)
                    await generateLabelPDF(productsWithData, definition);

                    hideModal(); // Esconde o "Carregando"

                } catch (error) {
                    console.error("Erro ao gerar PDF:", error);
                    showModal("Erro", "Não foi possível gerar o PDF: " + error.message);
                }
            });
        }

        /**
         * Helper: Busca dados de produtos por um array de IDs
         */
        /**
         * Helper: Busca dados de produtos por um array de objetos {id, qty}
         */
        async function fetchProductsByIds(productsToFetch) {
            const productsWithData = [];
            if (!userId || productsToFetch.length === 0) return productsWithData;

            const collectionPath = `artifacts/${appId}/users/${userId}/produtos`;

            // Mapeia ID -> Quantidade, para sabermos depois
            const qtyMap = new Map();
            productsToFetch.forEach(p => qtyMap.set(p.id, p.qty));

            // Busca os documentos (em paralelo)
            const readPromises = [];
            productsToFetch.forEach(p => {
                const docRef = doc(db, collectionPath, p.id);
                readPromises.push(getDoc(docRef));
            });

            const docSnapshots = await Promise.all(readPromises);

            // Anexa os dados do Firestore à quantidade solicitada
            docSnapshots.forEach(docSnap => {
                if (docSnap.exists()) {
                    productsWithData.push({
                        id: docSnap.id,
                        ...docSnap.data(),
                        qtyToPrint: qtyMap.get(docSnap.id) // <-- Anexa a quantidade!
                    });
                }
            });

            return productsWithData;
        }
        /**
         * Função principal que desenha o PDF
         */
        /**
         * Função principal que desenha o PDF (COM LAYOUT CORRIGIDO)
         */
        /**
         * Função principal que desenha o PDF (COM LAYOUT MAIS COMPACTO)
         */
        /**
         * Função principal que desenha o PDF (COM LOOP DE QUANTIDADE)
         */
        async function generateLabelPDF(productsWithData, def) {
            const { jsPDF } = window.jspdf;

            const doc = new jsPDF({
                unit: 'mm',
                format: def.pageFormat || 'a4',
                orientation: 'portrait'
            });

            const canvas = document.getElementById('barcode-canvas');

            const pageW = doc.internal.pageSize.getWidth();
            const pageH = doc.internal.pageSize.getHeight();

            const gapH = (def.cols > 1)
                ? (pageW - def.marginLeft - def.marginRight - (def.cols * def.width)) / (def.cols - 1)
                : 0;

            const gapV = (def.rows > 1)
                ? (pageH - def.marginTop - def.marginBottom - (def.rows * def.height)) / (def.rows - 1)
                : 0;

            let col = 0;
            let row = 0;

            // LOOP EXTERNO: Para cada *produto* selecionado
            for (const product of productsWithData) {

                // LOOP INTERNO: Para cada *quantidade* desse produto
                for (let i = 0; i < product.qtyToPrint; i++) {

                    // --- Esta parte é toda igual a antes ---

                    const x = def.marginLeft + (col * (def.width + gapH));
                    const y = def.marginTop + (row * (def.height + gapV));

                    const labelH = def.height;
                    const labelW = def.width;
                    const padding = 2;

                    const yPos_Name = y + padding + 1;
                    const bottomTextHeight = Math.min(6, labelH * 0.15);
                    const barcodeAreaStartY = yPos_Name + 3;
                    const barcodeAreaEndY = y + labelH - padding - bottomTextHeight - 1;
                    const barcodeDisplayHeight = Math.max(5, barcodeAreaEndY - barcodeAreaStartY);
                    const yPos_Barcode = barcodeAreaStartY + (barcodeDisplayHeight / 2) - (barcodeDisplayHeight * 0.5);
                    const yPos_BottomText = y + labelH - padding - (bottomTextHeight / 2);

                    // 1. Nome do Produto
                    doc.setFontSize(7);
                    doc.setFont(undefined, 'normal');
                    doc.text(product.nome, x + labelW / 2, yPos_Name, { align: 'center', maxWidth: labelW - (padding * 2) });

                    // 2. Código de Barras
                    try {
                        JsBarcode(canvas, product.ref, {
                            format: "CODE128", width: 1.5, height: 40,
                            fontSize: 10, margin: 0, displayValue: false
                        });
                        const barcodeDataUrl = canvas.toDataURL('image/png');
                        const barcodePdfWidth = labelW * 0.9;
                        const barcodePdfX = x + (labelW * 0.05);
                        doc.addImage(barcodeDataUrl, 'PNG', barcodePdfX, yPos_Barcode, barcodePdfWidth, barcodeDisplayHeight);
                    } catch (e) {
                        console.error("Erro ao gerar barcode:", e);
                        doc.text(`Erro Barcode`, x + labelW / 2, yPos_Barcode + (barcodeDisplayHeight / 2), { align: 'center' });
                    }

                    // 3. Referência e Preço
                    doc.setFontSize(6);
                    doc.setFont(undefined, 'normal');
                    const preco = `R$ ${product.venda.toFixed(2).replace('.', ',')}`;
                    const refText = `${product.ref}`;
                    const refTextWidth = doc.getStringUnitWidth(refText) * doc.getFontSize() / doc.internal.scaleFactor;
                    const priceTextWidth = doc.getStringUnitWidth(preco) * doc.getFontSize() / doc.internal.scaleFactor;
                    const totalTextWidth = refTextWidth + priceTextWidth + 2;
                    const startX_Ref = x + (labelW / 2) - (totalTextWidth / 2);
                    const startX_Price = startX_Ref + refTextWidth + 2;
                    doc.text(refText, startX_Ref, yPos_BottomText);
                    doc.setFont(undefined, 'bold');
                    doc.text(preco, startX_Price, yPos_BottomText);
                    doc.setFont(undefined, 'normal');

                    // --- Avança para a próxima etiqueta ---
                    col++;
                    if (col >= def.cols) {
                        col = 0;
                        row++;
                    }
                    if (row >= def.rows) {
                        col = 0;
                        row = 0;
                        doc.addPage(); // Próxima folha
                    }

                } // --- Fim do loop INTERNO (quantidade) ---

            } // --- Fim do loop EXTERNO (produto) ---

            doc.output('dataurlnewwindow');
        }
        // --- FIM DA LÓGICA DE ETIQUETAS ---

        // --- LÓGICA DE ATIVAÇÃO DOS CAMPOS DE QTD DAS ETIQUETAS ---
        const labelProductListContainer = document.getElementById('label-product-list');

        if (labelProductListContainer) {
            labelProductListContainer.addEventListener('change', (e) => {
                // Verifica se o evento foi em um checkbox de produto
                if (e.target.classList.contains('label-product-checkbox')) {
                    const checkbox = e.target;
                    const productId = checkbox.dataset.id;
                    const qtyInput = labelProductListContainer.querySelector(`.label-product-qty[data-id="${productId}"]`);

                    if (qtyInput) {
                        qtyInput.disabled = !checkbox.checked; // Ativa/desativa

                        if (checkbox.checked) {
                            qtyInput.classList.remove('bg-gray-100'); // Fundo branco
                            qtyInput.focus();
                            qtyInput.select(); // Seleciona o texto "1"
                        } else {
                            qtyInput.classList.add('bg-gray-100'); // Fundo cinza
                            qtyInput.value = 1; // Reseta para 1
                        }
                    }
                }
            });
        }
        // --- FIM DA LÓGICA DE ATIVAÇÃO ---
        // --- LÓGICA DO FILTRO DE BUSCA (PRODUTOS) ---
        const productSearchInput = document.getElementById('product-search-input');

        if (productSearchInput) {
            productSearchInput.addEventListener('input', () => {
                const searchTerm = productSearchInput.value;
                const filteredProducts = filterProducts(searchTerm);
                renderProductList(filteredProducts); // Redesenha a tabela com os produtos filtrados
            });
        }
        // --- FIM DO FILTRO DE BUSCA ---
        // --- LÓGICA DO FILTRO DE BUSCA (PESSOAS) ---
        const peopleSearchInput = document.getElementById('people-search-input');

        /**
         * Filtra a lista global de pessoas (allUserPeople) com base em um termo.
         */
        function filterPeople(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            if (!term) {
                return allUserPeople; // Retorna tudo se o filtro estiver vazio
            }

            return allUserPeople.filter(person => {
                // Verifica se o termo existe no nome, email ou cpf (se houver)
                return (
                    (person.nome && person.nome.toLowerCase().includes(term)) ||
                    (person.email && person.email.toLowerCase().includes(term)) ||
                    (person.cpf && person.cpf.toLowerCase().includes(term)) ||
                    (person.telefone && person.telefone.toLowerCase().includes(term))
                );
            });
        }

        if (peopleSearchInput) {
            peopleSearchInput.addEventListener('input', () => {
                const searchTerm = peopleSearchInput.value;
                const filteredPeople = filterPeople(searchTerm);
                // ATENÇÃO: A função renderPeopleList já desenha a tabela,
                // mas a função renderPeopleDropdown NÃO precisa ser chamada aqui,
                // pois o dropdown de vendas não deve ser filtrado.
                renderPeopleList(filteredPeople);
            });
        }
        // --- FIM DO FILTRO DE BUSCA (PESSOAS) ---
        // --- LÓGICA DA PÁGINA DE VENDAS E FINANCEIRO ---

        // Cache global
        let allSales = [];
        let allFinancialEntries = [];
        let cashFlowChart = null; // Guarda a instância do gráfico

        // Elementos da UI de Venda
        const btnAddSaleItem = document.getElementById('btn-add-sale-item');
        const saleItemRefInput = document.getElementById('sale-item-ref');
        const saleItemsListBody = document.getElementById('sale-items-list');
        const saleDiscountInput = document.getElementById('sale-discount');
        const saleSubtotalSpan = document.getElementById('sale-subtotal');
        const saleDiscountValueSpan = document.getElementById('sale-discount-value');
        const saleTotalSpan = document.getElementById('sale-total');

        // --- Funções de Carregamento (Listeners) ---

        /**
         * Cria o listener (onSnapshot) para a coleção de VENDAS
         * e atualiza o Histórico E as Consignações
         */
        function loadSalesHistory(resolve) {
            const collectionPath = `artifacts/${appId}/users/${userId}/vendas`;
            const q = query(collection(db, collectionPath));

            const unsubscribe = onSnapshot(q, (snapshot) => {
                console.log(`Vendas/Consignações recebidas: ${snapshot.size} docs`);
                allSales = [];
                snapshot.forEach(doc => {
                    allSales.push({ id: doc.id, ...doc.data() });
                });

                // Ordena por data de criação (mais novas primeiro)
                // CORREÇÃO: Ordena de forma segura (à prova de nulos)
                allSales.sort((a, b) => {
                    // Se o carimbo de data/hora 'createdAt' ainda for nulo, usa a data atual como fallback
                    const timeA = a.createdAt ? a.createdAt.toMillis() : new Date().getTime();
                    const timeB = b.createdAt ? b.createdAt.toMillis() : new Date().getTime();
                    return timeB - timeA;
                });

                // Separa as listas
                const activeConsignments = allSales.filter(s => s.type === 'consignacao' && s.status === 'Ativa');
                const completedSales = allSales.filter(s => s.type === 'direta' || s.status === 'Finalizada');

                // Renderiza as duas tabelas
                renderConsignList(activeConsignments);
                renderSalesHistoryList(completedSales);
                

                if (resolve) { // Chama resolve AQUI
             resolve();
             resolve = null; // Evita múltiplas chamadas
        }

            }, (error) => {
                console.error("Erro ao carregar vendas: ", error);
                showModal("Erro de Dados", "Não foi possível carregar seu histórico de vendas.");
            });

            activeListeners.push(unsubscribe);
        }

       /**
 * Cria o listener (onSnapshot) para a coleção de LANÇAMENTOS FINANCEIROS
 */
function loadFinancialHistory(resolve) {
    const collectionPath = `artifacts/${appId}/users/${userId}/lancamentos`;
    const q = query(collection(db, collectionPath));

    const unsubscribe = onSnapshot(q, (snapshot) => {
        console.log(`Lançamentos financeiros recebidos: ${snapshot.size} docs`);
        allFinancialEntries = [];
        snapshot.forEach(doc => {
            allFinancialEntries.push({ id: doc.id, ...doc.data() });
        });

        // Ordena por data (mais novos primeiro)
        allFinancialEntries.sort((a, b) => {
            const timeA = a.data ? a.data.toMillis() : new Date().getTime();
            const timeB = b.data ? b.data.toMillis() : new Date().getTime();
            return timeB - timeA;
        });

        // --- ATUALIZAÇÃO: Chamar as QUATRO funções ---
        renderFinancialHistoryList(allFinancialEntries); // Tabela Todos Lançamentos
        updateFinancialSummary();                      // Resumo do Caixa
        renderBillsTab(allFinancialEntries);   // Tabela Contas a Pagar
        renderCashFlowChart();                         // <-- NOVO GRÁFICO
        // updateDashboard(); // Comentado por enquanto
        // ------------------------------------------
        if (resolve) { // Chama resolve AQUI
            resolve();
            resolve = null; // Evita múltiplas chamadas
        }
    }, (error) => {
        console.error("Erro ao carregar lançamentos: ", error);
        showModal("Erro de Dados", "Não foi possível carregar seu histórico financeiro.");
    });

    activeListeners.push(unsubscribe);
}
        // --- Funções de Renderização (Desenhar Tabelas) ---

        /**
 /**
 * Desenha a tabela de Consignações Ativas (em Vendas)
 */
function renderConsignList(consignments) {
    const tableBody = document.getElementById('consign-list-table');
    const tableHead = tableBody.previousElementSibling.querySelector('thead tr'); // Pega o cabeçalho existente
    tableBody.innerHTML = ''; // Limpa o exemplo
    
    // --- Corrigir Largura do Cabeçalho Estático ---
    if (tableHead) {
        tableHead.querySelectorAll('th').forEach(th => th.classList.add('whitespace-nowrap'));
    }
    
    if (consignments.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Nenhuma consignação ativa.</td></tr>';
        return;
    }
    
    consignments.forEach(c => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50";
        
        const dueDate = new Date(c.dueDate);
        const diffTime = dueDate.getTime() - new Date().getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const dateString = dueDate.toLocaleDateString('pt-BR', {timeZone: 'UTC'}); // UTC para evitar bugs de fuso
        
        let dateClass = 'text-gray-700';
        if (diffDays <= 0) dateClass = 'font-bold text-red-600';
        else if (diffDays <= 3) dateClass = 'font-medium text-yellow-600';

        tr.innerHTML = `
            <!-- Revendedor(a) -->
            <td class="px-6 py-4 whitespace-nowrap">${c.clientId || 'Não informado'}</td>
            
            <!-- Data Abertura -->
            <td class="px-6 py-4 whitespace-nowrap">${c.createdAt.toDate().toLocaleDateString('pt-BR')}</td>
            
            <!-- Data Acerto -->
            <td class="px-6 py-4 whitespace-nowrap ${dateClass}">${dateString} (${diffDays} dias)</td>
            
            <!-- Valor Total -->
            <td class="px-6 py-4 whitespace-nowrap">R$ ${c.total.toFixed(2).replace('.', ',')}</td>
            
            <!-- Ação (Gerenciar, Acertar, Excluir) -->
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                 <!-- 1. Botão GERENCIAR/EDITAR ITENS -->
                <button class="btn-manage-consignment text-indigo-600 hover:text-indigo-900" data-id="${c.id}">
                    <i data-lucide="edit-2" class="w-5 h-5 pointer-events-none"></i>
                </button>
                
                <!-- 2. Botão REALIZAR ACERTO (Principal) -->
                <button class="btn-settle-consignment px-3 py-1 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700" data-id="${c.id}">Acertar</button>
                
                <!-- 3. Botão EXCLUIR/CANCELAR -->
                <button class="btn-delete-consign text-red-600 hover:text-red-900" data-id="${c.id}" data-client-id="${c.clientId}">
                    <i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i>
                </button>
            </td>
        `;
        tableBody.appendChild(tr);
    });
    
    lucide.createIcons();
}
/**
         * Desenha a tabela de Histórico de Vendas (em Vendas)
         */
        function renderSalesHistoryList(sales) {
            const tableBody = document.getElementById('history-list-table');
            tableBody.innerHTML = ''; // Limpa o exemplo

            if (sales.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Nenhuma venda registrada.</td></tr>';
                return;
            }

            sales.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";

                const typeBadge = s.type === 'direta'
                    ? 'text-green-800 bg-green-100'
                    : 'text-blue-800 bg-blue-100';
                const typeName = s.type === 'direta' ? 'Venda Direta' : 'Consignação';

                tr.innerHTML = `
            <td class="px-6 py-4">${s.createdAt.toDate().toLocaleDateString('pt-BR')}</td>
            <td class="px-6 py-4">${s.clientId || 'Consumidor Final'}</td>
            <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium ${typeBadge} rounded-full">${typeName}</span></td>
            <td class="px-6 py-4">R$ ${s.total.toFixed(2).replace('.', ',')}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
    <button class="btn-view-sale-report px-3 py-1 text-sm font-medium text-indigo-700 bg-indigo-100 rounded-md hover:bg-indigo-200" data-id="${s.id}"><i data-lucide="file-text" class="w-4 h-4 inline mr-1 pointer-events-none"></i>Ver</button>
    <button class="btn-delete-sale text-red-600 hover:text-red-900" data-id="${s.id}"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button>
</td>
        `;
                tableBody.appendChild(tr);
            });
            lucide.createIcons();
        }

        /**
         * Desenha a tabela de Todos Lançamentos (em Financeiro)
         */
        function renderFinancialHistoryList(entries) {
            const tableBody = document.getElementById('finance-history-table');
            tableBody.innerHTML = ''; // Limpa o exemplo

            if (entries.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Nenhum lançamento financeiro.</td></tr>';
                return;
            }

            entries.forEach(entry => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";

                const isEntrada = entry.tipo === 'Entrada';
                const typeBadge = isEntrada
                    ? 'text-green-800 bg-green-100'
                    : 'text-red-800 bg-red-100';
                const typeClass = isEntrada ? 'text-green-600' : 'text-red-600';
                const typePrefix = isEntrada ? '+' : '-';

                const entryDate = entry.data ? entry.data.toDate().toLocaleDateString('pt-BR') : 'Processando';
                tr.innerHTML = `
            <td class="px-6 py-4">${entryDate}</td>
            <td class="px-6 py-4">${entry.descricao}</td>
            <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium ${typeBadge} rounded-full">${entry.tipo}</span></td>
            <td class="px-6 py-4 font-medium ${typeClass}">${typePrefix} R$ ${entry.valor.toFixed(2).replace('.', ',')}</td>
        `;

                tableBody.appendChild(tr);
            });
        }

        /**
         * Calcula e atualiza o Resumo do Caixa (Receita, Despesa, Saldo do Mês Atual)
         */
        function updateFinancialSummary() {
            const revenueEl = document.getElementById('summary-revenue');
            const expensesEl = document.getElementById('summary-expenses');
            const balanceEl = document.getElementById('summary-balance');

            // Garante que os elementos existem
            if (!revenueEl || !expensesEl || !balanceEl) {
                console.warn("Elementos do resumo financeiro não encontrados.");
                return;
            }

            // Pega o mês e ano atuais
            const now = new Date();
            const currentMonth = now.getMonth(); // 0 = Janeiro, 11 = Dezembro
            const currentYear = now.getFullYear();

            let monthlyRevenue = 0;
            let monthlyExpenses = 0;

            // Filtra os lançamentos (allFinancialEntries) pelo mês/ano atual
            allFinancialEntries.forEach(entry => {
                // Verifica se 'entry.data' existe e é uma data válida do Firebase
                if (entry.data && entry.data.toDate) {
                    const entryDate = entry.data.toDate();
                    const entryMonth = entryDate.getMonth();
                    const entryYear = entryDate.getFullYear();

                    // Compara mês e ano
                    if (entryMonth === currentMonth && entryYear === currentYear) {
                        if (entry.tipo === 'Entrada') {
                            monthlyRevenue += entry.valor;
                        } else if (entry.tipo === 'Saída') {
                            monthlyExpenses += entry.valor;
                        }
                    }
                }
            });

            const monthlyBalance = monthlyRevenue - monthlyExpenses;

            // Formata como moeda
            const formatCurrency = (val) => `R$ ${val.toFixed(2).replace('.', ',')}`;

            // Atualiza o HTML
            revenueEl.textContent = formatCurrency(monthlyRevenue);
            expensesEl.textContent = `- ${formatCurrency(monthlyExpenses)}`; // Mantém o sinal de menos
            balanceEl.textContent = formatCurrency(monthlyBalance);

            // Ajusta a cor do saldo (opcional)
            balanceEl.classList.remove('text-green-600', 'text-red-600', 'text-blue-600');
            if (monthlyBalance > 0) {
                balanceEl.classList.add('text-green-600');
            } else if (monthlyBalance < 0) {
                balanceEl.classList.add('text-red-600');
            } else {
                balanceEl.classList.add('text-blue-600'); // Ou cinza, se preferir
            }
        }

      /**
 * Desenha as tabelas de Contas a Pagar E Contas Pagas (em Financeiro)
 */
function renderBillsTab(entries) {
    const tableBodyToPay = document.getElementById('bills-list-table');
    const tableBodyPaid = document.getElementById('bills-paid-table');
    
    if (!tableBodyToPay || !tableBodyPaid) return; // Sai se os elementos não existirem
    
    tableBodyToPay.innerHTML = '';
    tableBodyPaid.innerHTML = '';

    // Filtra apenas as Saídas
    const allBills = entries.filter(entry => entry.tipo === 'Saída');
    
    // Separa em A Pagar e Pagas
    const billsToPay = allBills.filter(bill => !bill.pago);
    
    // Filtra pagas apenas do mês atual (para não poluir)
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    const billsPaidThisMonth = allBills.filter(bill => {
        if (!bill.pago || !bill.data || !bill.data.toDate) return false;
        const paymentDate = bill.data.toDate();
        return paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;
    });

    // --- Renderiza Tabela A PAGAR ---
    if (billsToPay.length === 0) {
        tableBodyToPay.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Nenhuma conta a pagar registrada.</td></tr>';
    } else {
        // Ordena por data de vencimento (mais próximas primeiro)
        billsToPay.sort((a, b) => {
            const dateA = a.vencimento ? new Date(a.vencimento) : new Date(9999, 0, 1);
            const dateB = b.vencimento ? new Date(b.vencimento) : new Date(9999, 0, 1);
            return dateA - dateB;
        });

        billsToPay.forEach(bill => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";
            
            let dueDateString = 'N/D';
            let dateClass = 'text-gray-700';
            if (bill.vencimento) {
                const dueDate = new Date(bill.vencimento + 'T00:00:00'); 
                dueDateString = dueDate.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                const diffTime = dueDate.getTime() - new Date().setHours(0,0,0,0);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) dateClass = 'font-bold text-red-600'; 
                else if (diffDays <= 3) dateClass = 'font-medium text-yellow-600';
            }

            tr.innerHTML = `
                <td class="px-4 py-3">${bill.descricao}</td>
                <td class="px-4 py-3 ${dateClass}">${dueDateString}</td>
                <td class="px-4 py-3">R$ ${bill.valor.toFixed(2).replace('.', ',')}</td>
                <td class="px-4 py-3">
                    <button class="btn-mark-paid px-3 py-1 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700" data-id="${bill.id}">Pagar</button>
                    <button class="btn-delete-bill text-red-500 hover:text-red-700 ml-2" data-id="${bill.id}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                </td>
            `;
            tableBodyToPay.appendChild(tr);
        });
    }
    
    // --- Renderiza Tabela PAGAS (Mês Atual) ---
    if (billsPaidThisMonth.length === 0) {
        tableBodyPaid.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Nenhuma conta paga este mês.</td></tr>';
    } else {
         // Ordena por data de pagamento (mais recentes primeiro)
        billsPaidThisMonth.sort((a, b) => b.data.toDate() - a.data.toDate());
        
        billsPaidThisMonth.forEach(bill => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";
            
            const paymentDate = bill.data ? bill.data.toDate().toLocaleDateString('pt-BR') : 'N/D';

            tr.innerHTML = `
                <td class="px-4 py-3 text-gray-500">${bill.descricao}</td>
                <td class="px-4 py-3 text-gray-500">${paymentDate}</td>
                <td class="px-4 py-3 text-gray-500">R$ ${bill.valor.toFixed(2).replace('.', ',')}</td>
                <td class="px-4 py-3">
                    <button class="btn-unmark-paid px-3 py-1 text-sm font-medium text-white bg-yellow-600 rounded-md hover:bg-yellow-700" data-id="${bill.id}">Estornar</button>
                </td>
            `;
            tableBodyPaid.appendChild(tr);
        });
    }

    lucide.createIcons(); // Recria icones para ambas as tabelas
}
        /**
 * Renderiza o gráfico de fluxo de caixa dos últimos 30 dias
 */
function renderCashFlowChart() {
    const ctx = document.getElementById('cash-flow-chart');
    if (!ctx) return; // Sai se o canvas não estiver na tela

    // --- 1. Processar os dados ---
    const labels = []; // Ex: ['29/09', '30/09', ..., '28/10']
    const dailyData = {}; // Guarda { '28/10': { entradas: 0, saidas: 0 } }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 29); // 29 dias atrás + hoje = 30 dias

    // Preenche os labels e o objeto de dados
    for (let i = 0; i < 30; i++) {
        const date = new Date(thirtyDaysAgo);
        date.setDate(thirtyDaysAgo.getDate() + i);
        
        const label = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        labels.push(label);
        dailyData[label] = { entradas: 0, saidas: 0 };
    }

    // Filtra os lançamentos dos últimos 30 dias
    const recentEntries = allFinancialEntries.filter(entry => {
        if (!entry.data || !entry.data.toDate) return false;
        const entryDate = entry.data.toDate();
        entryDate.setHours(0, 0, 0, 0);
        return entryDate >= thirtyDaysAgo && entryDate <= today;
    });

    // Preenche o objeto 'dailyData' com os valores
    recentEntries.forEach(entry => {
        const entryLabel = entry.data.toDate().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        if (dailyData[entryLabel]) {
            if (entry.tipo === 'Entrada') {
                dailyData[entryLabel].entradas += entry.valor;
            } else if (entry.tipo === 'Saída') {
                dailyData[entryLabel].saidas += entry.valor;
            }
        }
    });

    // Converte o objeto 'dailyData' em arrays para o gráfico
    const entradasData = labels.map(label => dailyData[label].entradas);
    const saidasData = labels.map(label => dailyData[label].saidas * -1); // Deixa como negativo para o gráfico

    // --- 2. Desenhar o Gráfico ---
    
    // Destrói o gráfico anterior, se existir (MUITO IMPORTANTE)
    if (cashFlowChart) {
        cashFlowChart.destroy();
    }

    // Cria o novo gráfico
    cashFlowChart = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Entradas',
                    data: entradasData,
                    backgroundColor: 'rgba(22, 160, 133, 0.7)', // Verde
                    borderColor: 'rgba(22, 160, 133, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Saídas',
                    data: saidasData, // Já está negativo
                    backgroundColor: 'rgba(192, 57, 43, 0.7)', // Vermelho
                    borderColor: 'rgba(192, 57, 43, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true, // Empilha entradas e saídas no mesmo dia
                },
                y: {
                    stacked: true,
                    ticks: {
                        // Formata o eixo Y para mostrar "R$"
                        callback: function(value, index, values) {
                            return `R$ ${value}`;
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        // Formata a dica (tooltip) para mostrar "R$"
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}
// --- FIM DA LÓGICA DO GRÁFICO ---
        // --- Funções de Venda (iguais a antes) ---

        async function handleAddSaleItem(e) {
            if (e) e.preventDefault();
            const refCode = saleItemRefInput.value.trim();
            if (!refCode) return;
            saleItemRefInput.disabled = true;
            btnAddSaleItem.disabled = true;

            try {
                const product = await findProductByRef(refCode);
                if (!product) {
                    showModal("Erro", `Produto com referência "${refCode}" não foi encontrado.`);
                } else {
                    currentSaleItems.push(product);
                    renderSaleItems();
                    updateSaleTotals();
                    saleItemRefInput.value = '';
                }
            } catch (error) {
                console.error("Erro ao buscar produto:", error);
                showModal("Erro", "Falha ao buscar produto: " + error.message);
            }
            saleItemRefInput.disabled = false;
            btnAddSaleItem.disabled = false;
            saleItemRefInput.focus();
        }

        async function findProductByRef(refCode) {
            if (!userId) return null;
            const collectionPath = `artifacts/${appId}/users/${userId}/produtos`;
            const q = query(
                collection(db, collectionPath),
                where("ref", "==", refCode),
                where("ownerId", "==", userId)
            );
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                return null;
            } else {
                const doc = querySnapshot.docs[0];
                return { id: doc.id, ...doc.data() };
            }
        }

        function renderSaleItems() {
            saleItemsListBody.innerHTML = '';
            if (currentSaleItems.length === 0) {
                saleItemsListBody.innerHTML = '<tr><td colspan="4" class="py-2 text-center text-gray-500">Nenhum item adicionado.</td></tr>';
                return;
            }
            currentSaleItems.forEach((product, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.innerHTML = `
            <td class="py-2 pr-2"><div class="font-medium">${product.nome}</div></td>
            <td class="py-2 px-2">${product.ref}</td>
            <td class="py-2 px-2">R$ ${product.venda.toFixed(2).replace('.', ',')}</td>
            <td class="py-2 pl-2 text-right">
                <button class="btn-remove-sale-item text-red-500 hover:text-red-700" data-index="${index}">
                    <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                </button>
            </td>
        `;
                saleItemsListBody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function updateSaleTotals() {
            let subtotal = 0;
            currentSaleItems.forEach(product => {
                subtotal += product.venda;
            });
            const discountPercent = parseFloat(saleDiscountInput.value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const total = subtotal - discountAmount;
            saleSubtotalSpan.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            saleDiscountValueSpan.textContent = `- R$ ${discountAmount.toFixed(2).replace('.', ',')}`;
            saleTotalSpan.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        // --- "LIGA" OS EVENTOS DA PÁGINA DE VENDAS ---
        if (btnAddSaleItem) {
            btnAddSaleItem.addEventListener('click', handleAddSaleItem);
            saleItemRefInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleAddSaleItem(e);
                }
            });
            saleDiscountInput.addEventListener('input', updateSaleTotals);
        }

        renderSaleItems();
        updateSaleTotals();

        // --- FIM DA LÓGICA DE VENDAS E FINANCEIRO ---
        // --- LÓGICA DE FINALIZAR A VENDA ---

        const formNewSale = document.getElementById('form-new-sale');

        /**
         * Limpa o formulário de venda e o carrinho
         */
        function resetSaleForm() {
            currentSaleItems = []; // Limpa o array do carrinho
            renderSaleItems();     // Limpa a tabela de itens
            updateSaleTotals();    // Zera os totais

            if (formNewSale) formNewSale.reset(); // Reseta os campos (desconto, data, etc.)

            // Volta a aba para "Venda Direta"
            const radioDireta = document.querySelector('input[name="sale-type"][value="direta"]');
            if (radioDireta) radioDireta.click();

            // Garante que os campos de consignação estão escondidos
            const fieldsConsignacao = document.getElementById('fields-consignacao');
            if (fieldsConsignacao) fieldsConsignacao.style.display = 'none';

            const fieldsVendaDireta = document.getElementById('fields-venda-direta');
            if (fieldsVendaDireta) fieldsVendaDireta.style.display = 'block';
        }


        /**
         * Função principal: Salva a Venda/Consignação no Firestore
         * E FAZ O LANÇAMENTO FINANCEIRO (se for Venda Direta)
         */
        async function handleFinalizeSale(e) {
            e.preventDefault(); // <-- O PASSO MAIS IMPORTANTE! Impede o recarregamento.

            if (!userId) {
                showModal("Erro", "Você não está logado.");
                return;
            }

            if (currentSaleItems.length === 0) {
                showModal("Atenção", "Adicione pelo menos um item à venda antes de finalizar.");
                return;
            }

            const saveButton = document.getElementById('btn-finalize-sale');
            const originalButtonText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = `<i class="animate-spin inline-block w-4 h-4 border-[2px] border-current border-t-transparent rounded-full mr-2" role="status"></i>Salvando`;

            try {
                // --- 1. Coletar todos os dados ---
                const saleType = document.querySelector('input[name="sale-type"]:checked').value;
                const clientId = document.getElementById('sale-client').value;
                const paymentMethod = document.getElementById('sale-payment').value;

                let subtotal = 0;
                currentSaleItems.forEach(p => { subtotal += p.venda; });
                const discountPercent = parseFloat(saleDiscountInput.value) || 0;
                const discountAmount = subtotal * (discountPercent / 100);
                const total = subtotal - discountAmount;

                const itemsSold = currentSaleItems.map(p => ({
                    id: p.id, nome: p.nome, ref: p.ref, venda: p.venda, custo: p.custo
                }));

                let dueDate = null;
                if (saleType === 'consignacao') {
                    dueDate = document.getElementById('sale-due-date').value;
                    if (!dueDate) {
                        throw new Error("Para consignação, a data do acerto é obrigatória.");
                    }
                }

                // --- 2. Preparar o Pacote (Batch) ---
                const batch = writeBatch(db);
                const saleCollectionPath = `artifacts/${appId}/users/${userId}/vendas`;
                const productCollectionPath = `artifacts/${appId}/users/${userId}/produtos`;
                const financeCollectionPath = `artifacts/${appId}/users/${userId}/lancamentos`; // <-- NOVO

                // --- 2a. Criar o documento de Venda ---
                const saleData = {
                    type: saleType,
                    status: (saleType === 'direta') ? 'Finalizada' : 'Ativa',
                    clientId: clientId,
                    paymentMethod: (saleType === 'direta') ? paymentMethod : null,
                    items: itemsSold,
                    subtotal: subtotal,
                    discountPercent: discountPercent,
                    discountAmount: discountAmount,
                    total: total,
                    dueDate: dueDate,
                    createdAt: serverTimestamp(),
                    ownerId: userId
                };
                const newSaleRef = doc(collection(db, saleCollectionPath));
                batch.set(newSaleRef, saleData); // Adiciona a criação da venda ao lote

                // --- 2b. Atualizar o estoque de cada produto ---
                for (const item of currentSaleItems) {
                    const productRef = doc(db, productCollectionPath, item.id);
                    batch.update(productRef, {
                        estoque: increment(-1)
                    });
                }

                // --- 2c. NOVO: Criar o Lançamento Financeiro (Apenas se for Venda Direta) ---
                if (saleType === 'direta') {
                    const financeData = {
                        descricao: `Venda Direta #${newSaleRef.id.substring(0, 6)}`, // "Venda #aB1cD2"
                        valor: total, // O valor final da venda
                        tipo: 'Entrada',
                        data: serverTimestamp(), // Data que a venda ocorreu
                        vencimento: null,
                        pago: true,
                        saleId: newSaleRef.id, // Link para a venda original
                        ownerId: userId
                    };
                    const newFinanceRef = doc(collection(db, financeCollectionPath));
                    batch.set(newFinanceRef, financeData); // Adiciona o lançamento financeiro ao lote
                }

                // --- 3. Executar o Lote ---
                await batch.commit();

                // --- 4. Sucesso ---
                showModal("Sucesso!", `Venda do tipo "${saleType}" registrada com sucesso.`);
                resetSaleForm(); // Limpa tudo
                // (Não precisamos mais do showModal("Sucesso..."), pois o PDF já é a confirmação)

                // O onSnapshot (loadSalesHistory e loadFinancialHistory)
                // vai atualizar as tabelas automaticamente!

            } catch (error) {
                console.error("Erro ao finalizar venda:", error);
                showModal("Erro", "Não foi possível salvar a venda: " + error.message);
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
            }
        }
        // --- "LIGA" O ATALHO DE CADASTRO DE CLIENTE (EM VENDAS) ---
        const btnAddNewClientSale = document.getElementById('btn-add-new-client-sale');

        if (btnAddNewClientSale) {
            btnAddNewClientSale.addEventListener('click', (e) => {
                e.preventDefault();

                console.log("Atalho: Cadastrar novo cliente");

                // 1. Muda o sistema para a página 'Pessoas'
                showPage('page-pessoas');

                // 2. Encontra e "clica" na aba 'Cadastrar Pessoa'
                const tabButton = document.querySelector('#pessoas-tabs .pessoas-tab-btn[data-tab="tab-pessoas-add"]');
                if (tabButton) {
                    tabButton.click(); // Simula um clique, o que aciona a nossa função setupTabs
                }

                // 3. (Bônus) Foca no campo "Nome" para cadastro rápido
                // Usamos um pequeno delay para dar tempo da aba trocar
                setTimeout(() => {
                    const personNameInput = document.getElementById('person-name');
                    if (personNameInput) {
                        personNameInput.focus();
                    }
                }, 100); // 100ms
            });
        }
        // --- FIM DO ATALHO ---
        // --- "LIGA" O FORMULÁRIO DE CADASTRO DE PESSOA ---
        const formAddPerson = document.getElementById('form-add-person');

        if (formAddPerson) {
            formAddPerson.addEventListener('submit', async (e) => {
                e.preventDefault(); // Impede o recarregamento
                if (!userId) {
                    showModal("Erro", "Você não está logado.");
                    return;
                }

                const saveButton = formAddPerson.querySelector('button[type="submit"]');
                const originalButtonText = saveButton.innerHTML;
                saveButton.disabled = true;
                saveButton.innerHTML = `<i class="animate-spin inline-block w-4 h-4 border-[2px] border-current border-t-transparent rounded-full mr-2" role="status"></i>Salvando`;

                try {
                    // 1. Coletar os dados do formulário
                    const personData = {
                        nome: document.getElementById('person-name').value,
                        email: document.getElementById('person-email').value,
                        telefone: document.getElementById('person-phone').value,
                        endereco: document.getElementById('person-address').value,
                        tipo: document.getElementById('person-type').value,
                        // Opcionais
                        cpf: document.getElementById('person-cpf').value || null,
                        rg: document.getElementById('person-rg').value || null,
                        instagram: document.getElementById('person-insta').value || null,
                        createdAt: serverTimestamp(),
                        ownerId: userId
                    };

                    // 2. Validar campos obrigatórios
                    if (!personData.nome || !personData.email || !personData.telefone || !personData.endereco) {
                        throw new Error("Campos obrigatórios (Nome, Email, Tel, Endereço) não podem estar vazios.");
                    }

                    // 3. Salvar no Firestore
                    const collectionPath = `artifacts/${appId}/users/${userId}/pessoas`;
                    const docRef = await addDoc(collection(db, collectionPath), personData);

                    showModal("Sucesso!", `"${personData.nome}" foi salvo(a) com sucesso.`);
                    formAddPerson.reset();

                    // 4. BÔNUS: Voltar para a página de vendas e pré-selecionar
                    showPage('page-vendas');
                    const tabVendasNew = document.querySelector('.vendas-tab-btn[data-tab="tab-vendas-new"]');
                    if (tabVendasNew) tabVendasNew.click();

                    // Espera o 'onSnapshot' atualizar a lista do <select>
                    setTimeout(() => {
                        const select = document.getElementById('sale-client');
                        if (select) select.value = docRef.id; // Pré-seleciona o cliente
                    }, 500); // 500ms de delay

                } catch (error) {
                    console.error("Erro ao salvar pessoa:", error);
                    showModal("Erro", "Não foi possível salvar: " + error.message);
                } finally {
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalButtonText;
                }
            });
        }
        // --- FIM DO FORMULÁRIO PESSOA ---
        // --- "LIGA" O FORMULÁRIO DE ADICIONAR CONTA/DESPESA ---
        const formAddBill = document.getElementById('form-add-bill');

        if (formAddBill) {
            formAddBill.addEventListener('submit', async (e) => {
                e.preventDefault(); // Impede recarregamento
                if (!userId) {
                    showModal("Erro", "Você não está logado.");
                    return;
                }

                const saveButton = formAddBill.querySelector('button[type="submit"]');
                const originalButtonText = saveButton.innerHTML;
                saveButton.disabled = true;
                saveButton.innerHTML = `<i class="animate-spin inline-block w-4 h-4 border-[2px] border-current border-t-transparent rounded-full mr-2" role="status"></i>Salvando`;

                try {
                    // 1. Coletar dados
                    const description = document.getElementById('bill-desc').value;
                    const totalValue = parseFloat(document.getElementById('bill-value').value);
                    const firstDueDate = document.getElementById('bill-due-date').value; // Formato YYYY-MM-DD
                    const isInstallment = document.getElementById('bill-is-installment').checked;
                    const installmentCount = isInstallment ? parseInt(document.getElementById('bill-installments-count').value) : 1;

                    // 2. Validações
                    if (!description || isNaN(totalValue) || totalValue <= 0 || !firstDueDate) {
                        throw new Error("Descrição, Valor e Data de Vencimento são obrigatórios.");
                    }
                    if (isInstallment && (isNaN(installmentCount) || installmentCount < 2)) {
                        throw new Error("Número de parcelas inválido (mínimo 2).");
                    }

                    // 3. Preparar Lote (Batch)
                    const batch = writeBatch(db);
                    const collectionPath = `artifacts/${appId}/users/${userId}/lancamentos`;

                    const installmentValue = totalValue / installmentCount;

                    // 4. Loop para criar os lançamentos (1 ou N)
                    for (let i = 0; i < installmentCount; i++) {
                        const currentDueDate = new Date(firstDueDate + 'T00:00:00'); // Adiciona T00:00:00
                        currentDueDate.setMonth(currentDueDate.getMonth() + i); // Adiciona 'i' meses à data da primeira parcela

                        const billData = {
                            descricao: `${description} ${isInstallment ? `(${i + 1}/${installmentCount})` : ''}`,
                            valor: installmentValue,
                            tipo: 'Saída',
                            data: serverTimestamp(), // Data de registro
                            vencimento: currentDueDate.toISOString().split('T')[0], // Salva como YYYY-MM-DD
                            pago: false,
                            isInstallment: isInstallment,
                            installmentNumber: isInstallment ? i + 1 : null,
                            totalInstallments: isInstallment ? installmentCount : null,
                            ownerId: userId
                        };

                        const newBillRef = doc(collection(db, collectionPath));
                        batch.set(newBillRef, billData); // Adiciona ao lote
                    }

                    // 5. Executar o Lote
                    await batch.commit();

                    showModal("Sucesso!", `Conta "${description}" registrada com sucesso.`);
                    formAddBill.reset();
                    // Desmarca o checkbox de parcela e esconde o campo
                    const checkbox = document.getElementById('bill-is-installment');
                    const group = document.getElementById('bill-installments-group');
                    if (checkbox && group) {
                        checkbox.checked = false;
                        group.classList.add('hidden');
                    }

                    // O onSnapshot (loadFinancialHistory) vai atualizar as tabelas!

                } catch (error) {
                    console.error("Erro ao adicionar conta:", error);
                    showModal("Erro", "Não foi possível registrar a conta: " + error.message);
                } finally {
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalButtonText;
                }
            });
        }
        // --- FIM DO FORMULÁRIO CONTA/DESPESA ---
        // --- "LIGA" O PREENCHIMENTO AUTOMÁTICO DE DATA EM CONTAS A PAGAR ---
const btnTabContasAPagar = document.getElementById('btn-tab-contas-a-pagar');

if (btnTabContasAPagar) {
    btnTabContasAPagar.addEventListener('click', () => {
        // Define a data de vencimento para 30 dias no futuro
        const billDueDateInput = document.getElementById('bill-due-date');
        // Só preenche se estiver vazio, para não sobrescrever o que você já digitou
        if (!billDueDateInput.value) {
            billDueDateInput.value = getFutureDateString(30);
        }
    });
}
// --- FIM DO PREENCHIMENTO DE DATA ---
        // --- "LIGA" O FORMULÁRIO DE VENDA ---
        if (formNewSale) {
            formNewSale.addEventListener('submit', handleFinalizeSale);
        }
        // --- FIM DA LÓGICA DE FINALIZAR VENDA ---
        /**
         * Mostra o modal de confirmação para EXCLUIR um produto.
         */
        function showProductDeleteConfirmation(productId) {
            if (!userId) {
                showModal("Erro", "Usuário não logado.");
                return;
            }

            // 1. Pergunta ao usuário
            modalTitle.textContent = 'Confirmar Exclusão';
            modalBody.innerHTML = `
        <p>Você tem certeza que deseja excluir este produto?</p>
        <p class="text-sm text-gray-600 mt-2">Esta ação não pode ser desfeita.</p>
        <div class="mt-6 text-right space-x-2">
            <button type="button" id="btn-confirm-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancelar</button>
            <button type="button" id="btn-confirm-delete" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Sim, Excluir</button>
        </div>
    `;

            // 2. Mostra o modal
            modalContainer.style.display = 'flex';

            // 3. Listeners da confirmação
            document.getElementById('btn-confirm-cancel').onclick = hideModal;

            document.getElementById('btn-confirm-delete').onclick = async () => {
                const deleteBtn = document.getElementById('btn-confirm-delete');
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Excluindo';

                try {
                    // Caminho do documento
                    const collectionPath = `artifacts/${appId}/users/${userId}/produtos`;
                    const docRef = doc(db, collectionPath, productId);

                    // Exclui do Firebase
                    await deleteDoc(docRef);

                    // Fecha o modal
                    hideModal();

                    // O 'onSnapshot' (que já está rodando) vai
                    // atualizar a lista automaticamente!

                } catch (error) {
                    console.error("Erro ao excluir produto:", error);
                    showModal("Erro", "Não foi possível excluir o produto.");
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'Sim, Excluir';
                }
            };
        }

        /**
         * Mostra o modal de EDIÇÃO de um produto.
         */
        async function showEditProductModal(productId) {
            if (!userId) {
                showModal("Erro", "Usuário não logado.");
                return;
            }

            // 1. Buscar os dados do produto
            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/produtos`;
                const docRef = doc(db, collectionPath, productId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    showModal("Erro", "Produto não encontrado. Pode ter sido excluído.");
                    return;
                }

                const product = docSnap.data();

                // 2. Pegar a lista de categorias do <select> principal para replicar no modal
                const categorySelectHTML = document.getElementById('prod-categoria').innerHTML;

                // 3. Montar o HTML do formulário de edição
                modalTitle.textContent = 'Editar Produto';
                modalBody.innerHTML = `
            <form id="form-edit-product" class="grid grid-cols-1 gap-6 md:grid-cols-3">
                <!-- Coluna 1: Infos Principais -->
                <div class="space-y-4 md:col-span-2">
                    <h3 class="text-lg font-medium">Detalhes do Produto</h3>
                    <div>
                        <label class="block text-sm font-medium">Nome do Produto</label>
                        <input type="text" id="edit-prod-nome" required class="w-full px-3 py-2 mt-1 border rounded-md" value="${product.nome}">
                    </div>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                        <div>
                            <label class="block text-sm font-medium">Custo (R$)</label>
                            <input type="number" id="edit-prod-custo" step="0.01" class="w-full px-3 py-2 mt-1 border rounded-md" value="${product.custo || 0}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Margem (%)</label>
                            <input type="number" id="edit-prod-margem" class="w-full px-3 py-2 mt-1 border rounded-md" value="${product.margem || 100}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Venda (R$)</label>
                            <input type="text" id="edit-prod-venda" readonly class="w-full px-3 py-2 mt-1 bg-gray-100 border rounded-md" value="${product.venda.toFixed(2).replace('.', ',')}">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Descrição</label>
                        <textarea id="edit-prod-desc" rows="4" class="w-full px-3 py-2 mt-1 border rounded-md">${product.descricao || ''}</textarea>
                    </div>
                </div>
                <!-- Coluna 2: Estoque e Categoria -->
                <div class="space-y-4 md:col-span-1">
                    <h3 class="text-lg font-medium">Organização</h3>
                    <div>
                        <label class="block text-sm font-medium">Categoria</label>
                        <select id="edit-prod-categoria" class="w-full px-3 py-2 mt-1 border rounded-md">
                            ${categorySelectHTML}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Cód. Referência</label>
                        <input type="text" id="edit-prod-ref" required class="w-full px-3 py-2 mt-1 border rounded-md" value="${product.ref}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Qtd. em Estoque</label>
                        <input type="number" id="edit-prod-estoque" class="w-full px-3 py-2 mt-1 border rounded-md" value="${product.estoque || 0}">
                    </div>
                    <div class="p-4 border rounded-md">
                        <h4 class="font-medium text-center">Código de Barras</h4>
                        <svg id="edit-barcode-preview" class="w-full h-auto mt-2"></svg>
                    </div>
                </div>
                <!-- Ações -->
                <div class="md:col-span-3 text-right space-x-2">
                    <button type="button" id="btn-cancel-edit" class="px-6 py-2 font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
                    <button type="submit" id="btn-save-edit" class="px-6 py-2 font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">Atualizar Produto</button>
                </div>
            </form>
        `;

                // 4. Mostrar o Modal
                modalContainer.style.display = 'flex';

                // 5. Ativar a lógica INTERNA do modal

                // Seta o valor correto do <select>
                document.getElementById('edit-prod-categoria').value = product.categoria;

                // Lógica para calcular preço de venda (igual à do form principal)
                const editCusto = document.getElementById('edit-prod-custo');
                const editMargem = document.getElementById('edit-prod-margem');
                const editVenda = document.getElementById('edit-prod-venda');

                function calcularEditPrecoVenda() {
                    const custo = parseFloat(editCusto.value) || 0;
                    const margem = parseFloat(editMargem.value) || 100;
                    const venda = custo * (1 + (margem / 100));
                    editVenda.value = venda.toFixed(2).replace('.', ',');
                }
                editCusto.addEventListener('input', calcularEditPrecoVenda);
                editMargem.addEventListener('input', calcularEditPrecoVenda);

                // Lógica para gerar barcode (igual à do form principal)
                const editRef = document.getElementById('edit-prod-ref');
                function gerarEditBarcodePreview() {
                    const ref = editRef.value;
                    if (ref) {
                        JsBarcode("#edit-barcode-preview", ref, {
                            format: "CODE128", displayValue: true, fontSize: 14, margin: 10, height: 50
                        });
                    } else {
                        document.getElementById("edit-barcode-preview").innerHTML = "";
                    }
                }
                editRef.addEventListener('input', gerarEditBarcodePreview);
                gerarEditBarcodePreview(); // Gera o barcode inicial

                // 6. Adicionar listeners aos botões do Modal
                document.getElementById('btn-cancel-edit').onclick = hideModal;

                document.getElementById('form-edit-product').onsubmit = async (e) => {
                    e.preventDefault();

                    const saveBtn = document.getElementById('btn-save-edit');
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = `<i class="animate-spin inline-block w-4 h-4 border-[2px] border-current border-t-transparent rounded-full mr-2" role="status"></i>Atualizando`;

                    try {
                        // --- VERIFICAR DUPLICIDADE DE REFERÊNCIA (NA EDIÇÃO) ---
                const newRef = document.getElementById('edit-prod-ref').value.trim();
                const originalRef = product.ref; // 'product' vem da função 'showEditProductModal'

                // Só precisamos verificar se a referência FOI ALTERADA
                if (newRef !== originalRef) {
                    console.log("Referência alterada. Verificando duplicidade...");
                    const productQuery = query(
                        collection(db, collectionPath),
                        where("ref", "==", newRef),
                        where("ownerId", "==", userId)
                    );
                    
                    const querySnapshot = await getDocs(productQuery);
                    
                    if (!querySnapshot.empty) {
                        // A nova referência já existe em outro produto
                        throw new Error(`A referência "${newRef}" já está sendo usada por outro produto.`);
                    }
                }
                // --- FIM DA VERIFICAÇÃO ---
                        // Monta o objeto atualizado
                        const updatedProduct = {
                            nome: document.getElementById('edit-prod-nome').value,
                            custo: parseFloat(editCusto.value) || 0,
                            margem: parseFloat(editMargem.value) || 0,
                            venda: parseFloat(editVenda.value.replace(',', '.')) || 0,
                            categoria: document.getElementById('edit-prod-categoria').value,
                            ref: document.getElementById('edit-prod-ref').value,
                            estoque: parseInt(document.getElementById('edit-prod-estoque').value) || 0,
                            descricao: document.getElementById('edit-prod-desc').value,
                            // Não mexemos na fotoUrl aqui, ela permanece a mesma
                        };

                        // Envia a atualização
                        await updateDoc(docRef, updatedProduct);

                        hideModal();
                        // O onSnapshot vai atualizar a UI automaticamente!

                    } catch (error) {
                        console.error("Erro ao atualizar produto:", error);
                        showModal("Erro", "Falha ao atualizar o produto: " + error.message);
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = 'Atualizar Produto';
                    }
                };

            } catch (error) {
                console.error("Erro ao buscar produto para edição: ", error);
                showModal("Erro", "Não foi possível carregar os dados do produto.");
            }
        }
        // --- INICIALIZAÇÃO FINAL ---

        // Renderiza ícones
        lucide.createIcons();

        console.log("Sistema Brígida pronto.");

    </script>

</body>

</html>